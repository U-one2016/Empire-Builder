<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CITY ARCHITECT PRO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap');
:root{--bg:#0e1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--gold:#f0b429;--gold2:#d97706;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--purple:#bc8cff;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;user-select:none;}
header{display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;gap:10px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;color:var(--gold);white-space:nowrap;}
.stats-bar{display:flex;gap:5px;flex:1;justify-content:center;flex-wrap:wrap;}
.stat-chip{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 9px;display:flex;align-items:center;gap:5px;font-family:'JetBrains Mono',monospace;font-size:0.75rem;}
.stat-chip .lbl{color:var(--text2);font-size:0.6rem;}
.stat-chip .val{color:var(--gold);font-weight:700;}
.stat-chip.inc .val{color:var(--green);}
.stat-chip.pop .val{color:var(--accent);}
.stat-chip.stg .val{color:var(--purple);}
.hbtns{display:flex;gap:5px;flex-shrink:0;}
.hbtn{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 11px;cursor:pointer;color:var(--text);font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;transition:all .15s;white-space:nowrap;}
.hbtn:hover{border-color:var(--gold);color:var(--gold);}
.hbtn.sv{border-color:var(--green);color:var(--green);}
.hbtn.sv:hover{background:rgba(63,185,80,.15);}
.stage-bar-wrap{padding:4px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;}
.stage-label{font-size:0.62rem;color:var(--text2);margin-bottom:3px;display:flex;justify-content:space-between;}
.stage-track{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.stage-fill{height:100%;background:linear-gradient(90deg,var(--gold2),var(--gold));border-radius:3px;transition:width .4s ease;}
.main{display:flex;flex:1;overflow:hidden;}
#map-wrap{flex:1;position:relative;overflow:hidden;cursor:crosshair;}
canvas{display:block;position:absolute;top:0;left:0;}
#cv-bg{z-index:1;}#cv-city{z-index:2;}#cv-ui{z-index:3;pointer-events:none;}
/* minimap */
#minimap{position:absolute;bottom:10px;right:10px;border:1px solid var(--border);border-radius:6px;overflow:hidden;z-index:10;cursor:pointer;}
.sidebar{width:210px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;}
.sidebar::-webkit-scrollbar{width:4px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.sb-sec{padding:9px;border-bottom:1px solid var(--border);}
.sb-ttl{font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:7px;display:flex;align-items:center;gap:5px;}
.sb-ttl::after{content:'';flex:1;height:1px;background:var(--border);}
.bld-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 8px;cursor:pointer;display:flex;align-items:center;gap:7px;color:var(--text);font-family:'Noto Sans JP',sans-serif;margin-bottom:4px;transition:all .15s;position:relative;text-align:left;}
.bld-btn:hover{border-color:rgba(240,180,41,.5);background:var(--surface);}
.bld-btn.active{border-color:var(--gold);background:rgba(240,180,41,.08);}
.bld-btn.locked{opacity:.4;cursor:not-allowed;}
.bld-btn.locked:hover{border-color:var(--border);background:var(--surface2);}
.bld-ico{width:32px;height:32px;flex-shrink:0;border-radius:4px;overflow:hidden;}
.bld-info{flex:1;min-width:0;}
.bld-name{font-size:0.74rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bld-meta{display:flex;gap:4px;margin-top:2px;flex-wrap:wrap;}
.bc{font-size:0.6rem;color:var(--gold);font-family:'JetBrains Mono',monospace;}
.bi{font-size:0.6rem;color:var(--green);font-family:'JetBrains Mono',monospace;}
.bp{font-size:0.6rem;color:var(--accent);font-family:'JetBrains Mono',monospace;}
.lk-badge{position:absolute;top:3px;right:3px;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1px 3px;font-size:0.52rem;color:var(--text2);}
.tool-btns{display:flex;flex-direction:column;gap:4px;}
.tbtn{width:100%;border-radius:7px;padding:7px 9px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:0.74rem;transition:all .15s;border:1px solid;text-align:center;}
.tbtn.demo{background:rgba(248,81,73,.1);border-color:var(--red);color:var(--red);}
.tbtn.demo:hover,.tbtn.demo.on{background:rgba(248,81,73,.25);}
.tbtn.rst{background:rgba(139,148,158,.1);border-color:var(--border);color:var(--text2);}
.tbtn.rst:hover{background:rgba(139,148,158,.2);color:var(--text);}
.tooltip{position:absolute;background:var(--surface);border:1px solid var(--gold);padding:7px 11px;border-radius:8px;font-size:0.7rem;pointer-events:none;z-index:100;display:none;box-shadow:0 4px 20px rgba(0,0,0,.5);max-width:185px;}
.tooltip .ttn{font-weight:700;margin-bottom:3px;color:var(--gold);}
.tooltip .ttr{color:var(--text2);font-size:0.62rem;line-height:1.7;}
.tooltip .ttr span{color:var(--text);}
.notif{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);padding:7px 16px;border-radius:20px;font-size:0.77rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:200;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4);}
.notif.show{opacity:1;}
.notif.gd{border-color:var(--gold);color:var(--gold);}
.notif.gr{border-color:var(--green);color:var(--green);}
.notif.rd{border-color:var(--red);color:var(--red);}
.notif.pu{border-color:var(--purple);color:var(--purple);}
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;}
.modal-ov.show{display:flex;}
.modal{background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:32px 44px;text-align:center;max-width:400px;box-shadow:0 0 60px rgba(240,180,41,.25);}
.modal h2{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:4px;color:var(--gold);margin-bottom:6px;}
.modal p{color:var(--text2);margin-bottom:22px;font-size:0.88rem;white-space:pre-line;}
.modal-btn{background:var(--gold);color:#000;border:none;padding:11px 28px;border-radius:8px;font-size:.95rem;font-weight:700;font-family:'Noto Sans JP',sans-serif;cursor:pointer;}
.modal-btn:hover{background:var(--gold2);}
.mstars{font-size:1.8rem;margin-bottom:10px;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-45px)}}
.ifloat{position:absolute;font-family:'JetBrains Mono',monospace;font-size:0.72rem;pointer-events:none;z-index:150;animation:floatUp 1.4s ease forwards;font-weight:700;}
/* scroll hint */
.scroll-hint{position:absolute;bottom:46px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.35);font-size:0.65rem;pointer-events:none;z-index:10;}
</style>
</head>
<body>
<header>
  <div class="logo">üèô CITY ARCHITECT</div>
  <div class="stats-bar">
    <div class="stat-chip"><span class="lbl">üí∞ ‰∫àÁÆó</span><span class="val" id="s-money">10,000</span></div>
    <div class="stat-chip inc"><span class="lbl">üìà ÂèéÂÖ•/Áßí</span><span class="val" id="s-income">0</span></div>
    <div class="stat-chip pop"><span class="lbl">üë• ‰∫∫Âè£</span><span class="val" id="s-pop">0</span></div>
    <div class="stat-chip"><span class="lbl">üè¢ Âª∫Áâ©</span><span class="val" id="s-bld">0</span></div>
    <div class="stat-chip stg"><span class="lbl">‚≠ê „Çπ„ÉÜ„Éº„Ç∏</span><span class="val" id="s-stage">1</span></div>
  </div>
  <div class="hbtns">
    <button class="hbtn sv" onclick="saveGame()">üíæ „Çª„Éº„Éñ</button>
    <button class="hbtn" onclick="loadGame()">üìÇ „É≠„Éº„Éâ</button>
  </div>
</header>
<div class="stage-bar-wrap">
  <div class="stage-label">
    <span id="stage-name">„Çπ„ÉÜ„Éº„Ç∏1: Â∞è„Åï„Å™Êùë</span>
    <span id="stage-goal-txt">ÁõÆÊ®ô: ¬•5,000</span>
  </div>
  <div class="stage-track"><div class="stage-fill" id="stage-fill" style="width:0%"></div></div>
</div>
<div class="main">
  <div id="map-wrap">
    <canvas id="cv-bg"></canvas>
    <canvas id="cv-city"></canvas>
    <canvas id="cv-ui"></canvas>
    <canvas id="minimap" width="160" height="100"></canvas>
    <div class="tooltip" id="tooltip">
      <div class="ttn" id="tt-name"></div>
      <div class="ttr">ÂèéÂÖ•: <span id="tt-inc"></span></div>
      <div class="ttr">‰∫∫Âè£: <span id="tt-pop"></span></div>
    </div>
    <div class="notif" id="notif"></div>
    <div class="scroll-hint">üñ± „Éâ„É©„ÉÉ„Ç∞„Åß„Çπ„ÇØ„É≠„Éº„É´</div>
  </div>
  <div class="sidebar" id="sidebar"></div>
</div>
<div class="modal-ov" id="modal">
  <div class="modal">
    <div class="mstars" id="m-stars">‚≠ê‚≠ê‚≠ê</div>
    <h2 id="m-title">STAGE CLEAR!</h2>
    <p id="m-desc">Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏ÔºÅ</p>
    <button class="modal-btn" onclick="nextStage()">Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏ ‚Üí</button>
  </div>
</div>

<script>
// ==================== BUILDINGS ====================
const BUILDINGS = [
  // ST1
  {id:'cottage',   name:'Â∞èÂ±ã',            cost:300,   income:0.5,  pop:2,  score:1,  stage:1},
  {id:'house',     name:'‰∏ÄËà¨‰ΩèÂÆÖ',         cost:800,   income:1.2,  pop:5,  score:3,  stage:1},
  {id:'road',      name:'ÈÅìË∑Ø',             cost:150,   income:0,    pop:0,  score:1,  stage:1, nature:true, mult:0.05, desc:'‰∫∫Âè£√ó0.05/Áßí'},
  {id:'park',      name:'ÂÖ¨Âúí',             cost:600,   income:0,    pop:0,  score:5,  stage:1, nature:true, mult:0.15, desc:'‰∫∫Âè£√ó0.15/Áßí'},
  {id:'mountain',  name:'Â±±',               cost:1000,  income:0,    pop:0,  score:8,  stage:1, nature:true, mult:0.25, desc:'‰∫∫Âè£√ó0.25/Áßí (Ë¶≥ÂÖâ)'},
  {id:'ocean',     name:'Êµ∑„Éª„Éì„Éº„ÉÅ',       cost:1200,  income:0,    pop:0,  score:10, stage:1, nature:true, mult:0.3,  desc:'‰∫∫Âè£√ó0.3/Áßí (Ë¶≥ÂÖâ)'},
  // ST2 - „Åª„Åº„Çº„É≠
  {id:'apartment', name:'„Ç¢„Éë„Éº„Éà',         cost:2500,  income:0.0001, pop:20, score:8,  stage:2},
  {id:'shop',      name:'ÂïÜÂ∫ó',             cost:1800,  income:0.0001, pop:3,  score:6,  stage:2},
  {id:'clinic',    name:'„ÇØ„É™„Éã„ÉÉ„ÇØ',       cost:3000,  income:0.0001, pop:5,  score:10, stage:2},
  {id:'school',    name:'Â∞èÂ≠¶Ê†°',           cost:4000,  income:0.0001, pop:30, score:15, stage:2},
  // ST3 - „Çº„É≠ÂêåÁÑ∂
  {id:'condo',     name:'È´òÁ¥ö„Éû„É≥„Ç∑„Éß„É≥',   cost:10000, income:0.0001, pop:60, score:25, stage:3},
  {id:'office',    name:'„Ç™„Éï„Ç£„Çπ„Éì„É´',     cost:8000,  income:0.0001, pop:0,  score:20, stage:3},
  {id:'hotel',     name:'„Éõ„ÉÜ„É´',           cost:7000,  income:0.0001, pop:0,  score:18, stage:3},
  {id:'stadium',   name:'„Çπ„Çø„Ç∏„Ç¢„É†',       cost:12000, income:0.0001, pop:0,  score:35, stage:3},
  // ST4 - ÂÆåÂÖ®„Å´Âãï„Åã„Å™„ÅÑ
  {id:'skyscraper',name:'Ë∂ÖÂ∑®Â§ß„Éì„É´',       cost:15000, income:0.0001, pop:0,  score:50, stage:4},
  {id:'mall',      name:'„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„É¢„Éº„É´',cost:18000, income:0.0001, pop:0,  score:45, stage:4},
  {id:'luxury',    name:'Ë∂ÖÈ´òÁ¥ö„Éû„É≥„Ç∑„Éß„É≥', cost:10000, income:0.0001, pop:80, score:60, stage:4},
  {id:'airport',   name:'ÂõΩÈöõÁ©∫Ê∏Ø',         cost:25000, income:0.0001, pop:0,  score:80, stage:4},
];

const STAGES=[
  {stage:1,name:'Â∞è„Åï„Å™Êùë',    goal:500},
  {stage:2,name:'ÊàêÈï∑„Åô„ÇãÁî∫',  goal:2000},
  {stage:3,name:'Áô∫Â±ï„Åô„ÇãÈÉΩÂ∏Ç',goal:8000},
  {stage:4,name:'Â§ßÈÉΩÂ∏Ç',      goal:30000},
  {stage:5,name:'„É°„Ç¨„Ç∑„ÉÜ„Ç£',  goal:null},
];

// ==================== STATE ====================
const GRID = 36;
const MAP_COLS = 80;
const MAP_ROWS = 50;
const MAP_W = MAP_COLS * GRID;
const MAP_H = MAP_ROWS * GRID;

let state = {money:10000, totalEarned:0, population:0, stage:1, grid:{}, placedCount:0};
let cam = {x:0, y:0}; // camera offset (pixels)
let selectedType = 'house';
let isDemolish = false;
let animFrame = 0;
let VW, VH; // viewport size
let lastTick = Date.now();
let notifTO;
let dragging = false, dragStart = {x:0,y:0}, camStart = {x:0,y:0};

const bgC   = document.getElementById('cv-bg');
const cityC = document.getElementById('cv-city');
const uiC   = document.getElementById('cv-ui');
const mm    = document.getElementById('minimap');
const bgX   = bgC.getContext('2d');
const cityX = cityC.getContext('2d');
const mmX   = mm.getContext('2d');

// ==================== SIDEBAR ====================
const CATS=[
  {label:'üèò ‰ΩèÂ±Ö',    ids:['cottage','house','apartment','condo','luxury']},
  {label:'üè¨ ÂïÜÊ•≠',    ids:['shop','office','hotel','mall','skyscraper','airport','stadium']},
  {label:'üåø Ëá™ÁÑ∂„ÉªÊñΩË®≠',ids:['road','park','mountain','ocean','clinic','school']},
];

const SVGS={
  cottage:`<svg viewBox="0 0 32 32"><rect x="5" y="17" width="22" height="13" fill="#8B7355" rx="1"/><polygon points="16,5 3,19 29,19" fill="#6B4F35"/><rect x="12" y="24" width="8" height="6" fill="#3D2B1F"/><rect x="6" y="19" width="5" height="5" fill="#C4A882"/></svg>`,
  house:`<svg viewBox="0 0 32 32"><rect x="3" y="15" width="26" height="15" fill="#C4956A" rx="1"/><polygon points="16,3 1,17 31,17" fill="#8B6347"/><rect x="11" y="23" width="10" height="7" fill="#5C3A21"/><rect x="4" y="17" width="6" height="6" fill="#87CEEB" opacity=".8"/><rect x="22" y="17" width="6" height="6" fill="#87CEEB" opacity=".8"/></svg>`,
  road:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#1a1a1a"/><line x1="0" y1="16" x2="32" y2="16" stroke="#F0B429" stroke-width="1.5" stroke-dasharray="5,4"/><line x1="16" y1="0" x2="16" y2="32" stroke="#F0B429" stroke-width="1.5" stroke-dasharray="5,4"/></svg>`,
  park:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#2e7d32"/><circle cx="10" cy="14" r="8" fill="#1b5e20"/><circle cx="24" cy="17" r="6" fill="#1b5e20"/><circle cx="10" cy="14" r="5" fill="#4caf50"/><circle cx="24" cy="17" r="4" fill="#4caf50"/><rect x="9" y="18" width="2" height="12" fill="#5c3a1e"/><rect x="23" y="20" width="2" height="10" fill="#5c3a1e"/></svg>`,
  mountain:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#546e7a"/><polygon points="16,2 2,28 30,28" fill="#78909c"/><polygon points="16,2 10,14 22,14" fill="white"/><polygon points="22,8 14,28 30,28" fill="#607d8b"/><polygon points="22,8 18,18 26,18" fill="#e0e0e0"/></svg>`,
  ocean:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#0277bd"/><rect x="0" y="20" width="32" height="12" fill="#01579b"/><rect x="0" y="24" width="32" height="4" fill="#039be5" opacity=".5"/><rect x="0" y="18" width="32" height="5" fill="#f5deb3"/><circle cx="8" cy="14" r="6" fill="#fff9c4"/><circle cx="22" cy="12" r="4" fill="#fffde7" opacity=".8"/></svg>`,
  apartment:`<svg viewBox="0 0 32 32"><rect x="4" y="3" width="24" height="29" fill="#6B7280" rx="1"/><rect x="4" y="3" width="24" height="4" fill="#4B5563"/><rect x="7" y="9" width="5" height="4" fill="#87CEEB" opacity=".9"/><rect x="15" y="9" width="5" height="4" fill="#FFE082"/><rect x="7" y="17" width="5" height="4" fill="#FFE082"/><rect x="15" y="17" width="5" height="4" fill="#87CEEB"/><rect x="11" y="27" width="10" height="5" fill="#374151"/></svg>`,
  shop:`<svg viewBox="0 0 32 32"><rect x="2" y="13" width="28" height="19" fill="#D97706" rx="1"/><rect x="2" y="9" width="28" height="6" fill="#B45309"/><rect x="2" y="6" width="28" height="5" fill="#F59E0B"/><rect x="7" y="19" width="8" height="9" fill="#92400E"/><rect x="19" y="19" width="9" height="6" fill="#FEF3C7" opacity=".8"/></svg>`,
  clinic:`<svg viewBox="0 0 32 32"><rect x="3" y="7" width="26" height="25" fill="#F8FAFC" rx="1"/><rect x="3" y="7" width="26" height="6" fill="#EF4444"/><rect x="13" y="1" width="6" height="8" fill="#EF4444"/><rect x="14" y="3" width="4" height="4" fill="white"/><rect x="7" y="17" width="8" height="8" fill="#87CEEB"/><rect x="19" y="17" width="8" height="8" fill="#87CEEB"/></svg>`,
  school:`<svg viewBox="0 0 32 32"><rect x="2" y="11" width="28" height="21" fill="#FEF3C7" rx="1"/><rect x="2" y="7" width="28" height="6" fill="#D97706"/><polygon points="16,1 2,9 30,9" fill="#B45309"/><rect x="6" y="17" width="6" height="6" fill="#87CEEB"/><rect x="20" y="17" width="6" height="6" fill="#87CEEB"/><rect x="12" y="25" width="8" height="7" fill="#92400E"/></svg>`,
  condo:`<svg viewBox="0 0 32 32"><rect x="9" y="0" width="14" height="32" fill="#263238" rx="1"/><rect x="4" y="15" width="24" height="17" fill="#37474f" rx="1"/><rect x="10" y="3" width="4" height="3" fill="#93C5FD"/><rect x="16" y="3" width="4" height="3" fill="#FDE68A"/><rect x="10" y="9" width="4" height="3" fill="#FDE68A"/><rect x="16" y="9" width="4" height="3" fill="#93C5FD"/><rect x="6" y="18" width="4" height="3" fill="#93C5FD"/><rect x="13" y="18" width="4" height="3" fill="#FDE68A"/><rect x="20" y="18" width="4" height="3" fill="#93C5FD"/><rect x="6" y="24" width="4" height="3" fill="#FDE68A"/><rect x="13" y="24" width="4" height="3" fill="#93C5FD"/><rect x="20" y="24" width="4" height="3" fill="#FDE68A"/></svg>`,
  office:`<svg viewBox="0 0 32 32"><rect x="5" y="1" width="22" height="31" fill="#1E3A5F" rx="1"/><rect x="7" y="4" width="8" height="4" fill="#93C5FD" opacity=".8"/><rect x="17" y="4" width="8" height="4" fill="#93C5FD" opacity=".8"/><rect x="7" y="11" width="8" height="4" fill="#BAE6FD"/><rect x="17" y="11" width="8" height="4" fill="#93C5FD"/><rect x="7" y="18" width="8" height="4" fill="#93C5FD"/><rect x="17" y="18" width="8" height="4" fill="#BAE6FD"/><rect x="7" y="25" width="18" height="4" fill="#BAE6FD" opacity=".6"/></svg>`,
  hotel:`<svg viewBox="0 0 32 32"><rect x="4" y="5" width="24" height="27" fill="#7C2D12" rx="1"/><rect x="4" y="5" width="24" height="5" fill="#9A3412"/><polygon points="16,0 4,7 28,7" fill="#B45309"/><rect x="7" y="13" width="5" height="4" fill="#FDE68A"/><rect x="14" y="13" width="5" height="4" fill="#FDE68A"/><rect x="21" y="13" width="5" height="4" fill="#FDE68A"/><rect x="7" y="20" width="5" height="4" fill="#FDE68A"/><rect x="14" y="20" width="5" height="4" fill="#FDE68A"/><rect x="21" y="20" width="5" height="4" fill="#FDE68A"/><rect x="12" y="27" width="8" height="5" fill="#6B1A0A"/></svg>`,
  stadium:`<svg viewBox="0 0 32 32"><rect x="1" y="7" width="30" height="20" fill="#374151" rx="9"/><rect x="5" y="11" width="22" height="12" fill="#16A34A" rx="5"/><rect x="10" y="14" width="12" height="6" fill="#22C55E" rx="2"/><rect x="4" y="5" width="2" height="10" fill="#4B5563"/><rect x="26" y="5" width="2" height="10" fill="#4B5563"/><circle cx="5" cy="5" r="3" fill="#4B5563"/><circle cx="27" cy="5" r="3" fill="#4B5563"/></svg>`,
  skyscraper:`<svg viewBox="0 0 32 32"><rect x="7" y="13" width="18" height="19" fill="#334155" rx="1"/><rect x="10" y="0" width="12" height="32" fill="#1E293B" rx="1"/><rect x="11" y="2" width="4" height="3" fill="#BAE6FD"/><rect x="17" y="2" width="4" height="3" fill="#FDE68A"/><rect x="11" y="7" width="4" height="3" fill="#FDE68A"/><rect x="17" y="7" width="4" height="3" fill="#BAE6FD"/><rect x="8" y="15" width="4" height="3" fill="#BAE6FD"/><rect x="14" y="15" width="4" height="3" fill="#FDE68A"/><rect x="20" y="15" width="4" height="3" fill="#BAE6FD"/><rect x="8" y="21" width="4" height="3" fill="#FDE68A"/><rect x="14" y="21" width="4" height="3" fill="#BAE6FD"/><rect x="20" y="21" width="4" height="3" fill="#FDE68A"/><circle cx="16" cy="0" r="2" fill="#EF4444"/></svg>`,
  mall:`<svg viewBox="0 0 32 32"><rect x="0" y="13" width="32" height="19" fill="#475569" rx="2"/><rect x="8" y="5" width="16" height="10" fill="#334155" rx="1"/><rect x="0" y="9" width="32" height="6" fill="#334155"/><rect x="3" y="16" width="9" height="8" fill="#FDE68A" opacity=".7"/><rect x="14" y="16" width="9" height="8" fill="#BAE6FD" opacity=".7"/><rect x="25" y="16" width="5" height="8" fill="#FDE68A" opacity=".5"/></svg>`,
  luxury:`<svg viewBox="0 0 32 32"><rect x="10" y="0" width="12" height="32" fill="#1C1917" rx="1"/><rect x="3" y="19" width="26" height="13" fill="#292524" rx="1"/><rect x="11" y="2" width="4" height="3" fill="#D4AF37"/><rect x="17" y="2" width="4" height="3" fill="#FDE68A"/><rect x="11" y="7" width="4" height="3" fill="#FDE68A"/><rect x="17" y="7" width="4" height="3" fill="#D4AF37"/><rect x="5" y="21" width="5" height="4" fill="#D4AF37"/><rect x="13" y="21" width="5" height="4" fill="#FDE68A"/><rect x="21" y="21" width="5" height="4" fill="#D4AF37"/><rect x="5" y="27" width="5" height="4" fill="#FDE68A"/><rect x="13" y="27" width="5" height="4" fill="#D4AF37"/><rect x="21" y="27" width="5" height="4" fill="#FDE68A"/></svg>`,
  airport:`<svg viewBox="0 0 32 32"><rect x="0" y="21" width="32" height="11" fill="#212121"/><rect x="3" y="13" width="26" height="10" fill="#37474f"/><rect x="8" y="7" width="16" height="8" fill="#1E3A5F" rx="1"/><rect x="4" y="15" width="5" height="5" fill="#BAE6FD" opacity=".8"/><rect x="23" y="15" width="5" height="5" fill="#BAE6FD" opacity=".8"/><polygon points="16,3 10,9 22,9" fill="#334155"/><rect x="27" y="9" width="4" height="14" fill="#546e7a"/><rect x="25" y="9" width="8" height="4" fill="#80cbc4"/></svg>`,
};

function buildSidebar(){
  const sb=document.getElementById('sidebar');
  sb.innerHTML='';
  CATS.forEach(cat=>{
    const sec=document.createElement('div');
    sec.className='sb-sec';
    sec.innerHTML=`<div class="sb-ttl">${cat.label}</div>`;
    cat.ids.forEach(id=>{
      const b=BUILDINGS.find(x=>x.id===id);
      if(!b)return;
      const locked=b.stage>state.stage;
      const btn=document.createElement('button');
      btn.className='bld-btn'+(locked?' locked':'')+(selectedType===id&&!locked?' active':'');
      btn.dataset.id=id;
      const incTxt = b.nature
        ? `<span class="bi">üé°${b.desc||''}</span>`
        : (b.income>0?`<span class="bi">+${b.income}/s</span>`:'');
      btn.innerHTML=`<div class="bld-ico">${SVGS[id]||''}</div>
        <div class="bld-info">
          <div class="bld-name">${b.name}</div>
          <div class="bld-meta">
            <span class="bc">¬•${b.cost.toLocaleString()}</span>
            ${incTxt}
            ${b.pop>0?`<span class="bp">üë•${b.pop}</span>`:''}
          </div>
        </div>
        ${locked?`<div class="lk-badge">ST${b.stage}üîí</div>`:''}`;
      if(!locked) btn.onclick=()=>selectBuilding(id);
      sec.appendChild(btn);
    });
    sb.appendChild(sec);
  });
  // tools
  const ts=document.createElement('div');
  ts.className='sb-sec';
  ts.innerHTML=`<div class="sb-ttl">„ÉÑ„Éº„É´</div><div class="tool-btns">
    <button class="tbtn demo" id="demo-btn" onclick="toggleDemolish()">üóë Âèñ„ÇäÂ£ä„Åó„É¢„Éº„Éâ</button>
    <button class="tbtn rst" onclick="confirmReset()">üîÑ „É™„Çª„ÉÉ„Éà</button>
  </div>`;
  sb.appendChild(ts);
}

function selectBuilding(id){
  selectedType=id; isDemolish=false;
  document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.bld-btn[data-id="${id}"]`).forEach(b=>b.classList.add('active'));
  const db=document.getElementById('demo-btn');
  if(db) db.classList.remove('on');
}
function toggleDemolish(){
  isDemolish=!isDemolish;
  const db=document.getElementById('demo-btn');
  if(db) db.classList.toggle('on',isDemolish);
  notify(isDemolish?'üóë Âèñ„ÇäÂ£ä„Åó„É¢„Éº„Éâ':'‚úèÔ∏è Âª∫Ë®≠„É¢„Éº„Éâ', isDemolish?'rd':'gd');
}

// ==================== RESIZE ====================
function resize(){
  const wrap=document.getElementById('map-wrap');
  VW=wrap.offsetWidth; VH=wrap.offsetHeight;
  bgC.width=cityC.width=uiC.width=VW;
  bgC.height=cityC.height=uiC.height=VH;
  clampCam();
  drawBg(); drawCity();
}

function clampCam(){
  cam.x=Math.max(0,Math.min(cam.x, MAP_W-VW));
  cam.y=Math.max(0,Math.min(cam.y, MAP_H-VH));
}

// ==================== BACKGROUND / MAP ====================
// Pre-generate terrain
const TERRAIN={}; // key -> 'grass'|'water'|'sand'|'mountain_bg'

function generateTerrain(){
  // Simple noise-like terrain using sin/cos combos
  for(let cy=0;cy<MAP_ROWS;cy++){
    for(let cx=0;cx<MAP_COLS;cx++){
      const nx=cx/MAP_COLS, ny=cy/MAP_ROWS;
      // ocean on edges and low noise areas
      const v=Math.sin(nx*6+1.2)*Math.cos(ny*5+0.7)
             +Math.sin(nx*12+0.3)*Math.cos(ny*8+1.5)*0.5
             +Math.sin((nx+ny)*9+2)*0.3;
      // mountains on high noise
      const mv=Math.sin(nx*8+2)*Math.cos(ny*6+1)+Math.sin(nx*3)*0.5;
      let t='grass';
      if(v<-0.7) t='water';
      else if(v<-0.5) t='sand';
      else if(mv>1.2) t='hill';
      TERRAIN[`${cx},${cy}`]=t;
    }
  }
  // force ocean border
  for(let cx=0;cx<MAP_COLS;cx++){
    TERRAIN[`${cx},0`]='water';
    TERRAIN[`${cx},${MAP_ROWS-1}`]='water';
  }
  for(let cy=0;cy<MAP_ROWS;cy++){
    TERRAIN[`0,${cy}`]='water';
    TERRAIN[`${MAP_COLS-1},${cy}`]='water';
  }
}

const TERRAIN_COLORS={
  grass:'#3a6b3a', water:'#1a6fa0', sand:'#c2a46b', hill:'#6b7d6b'
};
const TERRAIN_DARK={
  grass:'#2e5430', water:'#154d72', sand:'#a8884a', hill:'#546059'
};

function drawBg(){
  bgX.clearRect(0,0,VW,VH);
  // sky gradient at top (above map if scrolled)
  const skyH=Math.max(0,-cam.y);
  if(skyH>0){
    const sg=bgX.createLinearGradient(0,0,0,skyH);
    sg.addColorStop(0,'#0a0a1a'); sg.addColorStop(1,'#1a2a4a');
    bgX.fillStyle=sg; bgX.fillRect(0,0,VW,skyH);
  }

  // visible cell range
  const c0=Math.floor(cam.x/GRID), r0=Math.floor(cam.y/GRID);
  const c1=Math.min(MAP_COLS-1, c0+Math.ceil(VW/GRID)+1);
  const r1=Math.min(MAP_ROWS-1, r0+Math.ceil(VH/GRID)+1);

  for(let r=r0;r<=r1;r++){
    for(let c=c0;c<=c1;c++){
      const t=TERRAIN[`${c},${r}`]||'grass';
      const sx=c*GRID-cam.x, sy=r*GRID-cam.y;
      // base color
      bgX.fillStyle=TERRAIN_COLORS[t];
      bgX.fillRect(sx,sy,GRID,GRID);
      // subtle shading
      bgX.fillStyle=TERRAIN_DARK[t];
      bgX.fillRect(sx,sy,1,GRID);
      bgX.fillRect(sx,sy,GRID,1);
      // water waves
      if(t==='water'){
        const wv=(animFrame/40+(c*0.3+r*0.5))%1;
        bgX.fillStyle=`rgba(100,180,255,${0.1+wv*0.15})`;
        bgX.fillRect(sx+3,sy+GRID/2-2,GRID-6,3);
      }
      // grid line
      bgX.strokeStyle='rgba(0,0,0,0.08)'; bgX.lineWidth=0.5;
      bgX.strokeRect(sx,sy,GRID,GRID);
    }
  }
}

// ==================== DRAW BUILDINGS ====================
function drawBuilding(ctx,id,gx,gy,cx,cy){
  const t=animFrame/60;
  ctx.save();
  const G=GRID;
  switch(id){
    case 'cottage':{
      ctx.fillStyle='#5c4033'; ctx.fillRect(gx+4,gy+G-14,G-8,14);
      ctx.fillStyle='#8d6e63'; ctx.fillRect(gx+6,gy+G-20,G-12,10);
      ctx.fillStyle='#4e342e';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+G-26);ctx.lineTo(gx+4,gy+G-18);ctx.lineTo(gx+G-4,gy+G-18);ctx.closePath();ctx.fill();
      ctx.fillStyle=`rgba(255,220,120,${.5+Math.sin(t*2+cx)*.4})`;
      ctx.fillRect(gx+8,gy+G-19,6,5);
      break;}
    case 'house':{
      ctx.fillStyle='#bf8a60'; ctx.fillRect(gx+3,gy+14,G-6,G-15);
      ctx.fillStyle='#795548';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+4);ctx.lineTo(gx+1,gy+16);ctx.lineTo(gx+G-1,gy+16);ctx.closePath();ctx.fill();
      ctx.fillStyle='#4e342e'; ctx.fillRect(gx+G/2-4,gy+G-12,8,12);
      ctx.fillStyle=`rgba(135,206,235,${.7+Math.sin(t+cx*.5)*.2})`;
      ctx.fillRect(gx+5,gy+18,7,6); ctx.fillRect(gx+G-12,gy+18,7,6);
      break;}
    case 'road':{
      ctx.fillStyle='#1a1a1a'; ctx.fillRect(gx,gy,G,G);
      ctx.fillStyle='#252525'; ctx.fillRect(gx+1,gy+1,G-2,G-2);
      // animated cars
      const cp=(animFrame*0.5+cx*7)%(G+10)-5;
      ctx.fillStyle='#ef5350'; ctx.fillRect(gx+cp,gy+G/2-4,8,4);
      const cp2=(animFrame*0.3+cy*11+20)%(G+10)-5;
      ctx.fillStyle='#42a5f5'; ctx.fillRect(gx+G/2-4,gy+G-cp2-4,4,6);
      ctx.strokeStyle='#F0B429'; ctx.setLineDash([5,4]); ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(gx,gy+G/2);ctx.lineTo(gx+G,gy+G/2);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gx+G/2,gy);ctx.lineTo(gx+G/2,gy+G);ctx.stroke();
      ctx.setLineDash([]);
      break;}
    case 'park':{
      ctx.fillStyle='#2e7d32'; ctx.fillRect(gx,gy,G,G);
      ctx.fillStyle='#9e8a6a'; ctx.fillRect(gx+G/2-3,gy,6,G); ctx.fillRect(gx,gy+G/2-3,G,6);
      // animated people
      const pp=(animFrame*0.4+cx*5)%(G-8);
      ctx.fillStyle='#fff'; ctx.beginPath();ctx.arc(gx+4+pp,gy+G/2-1,2,0,Math.PI*2);ctx.fill();
      [[10,G-18,8],[G-10,G-18,8],[G/2,10,10]].forEach(([tx,ty,r])=>{
        ctx.fillStyle='#1b5e20'; ctx.beginPath();ctx.arc(gx+tx,gy+ty,r+2,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#4caf50'; ctx.beginPath();ctx.arc(gx+tx,gy+ty,r-2,0,Math.PI*2);ctx.fill();
      });
      break;}
    case 'mountain':{
      // Snow capped mountain
      ctx.fillStyle='#546e7a'; ctx.fillRect(gx,gy,G,G);
      ctx.fillStyle='#78909c';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+2,gy+G-2);ctx.lineTo(gx+G-2,gy+G-2);ctx.closePath();ctx.fill();
      ctx.fillStyle='#607d8b';
      ctx.beginPath();ctx.moveTo(gx+G*0.7,gy+8);ctx.lineTo(gx+G*0.4,gy+G-2);ctx.lineTo(gx+G-2,gy+G-2);ctx.closePath();ctx.fill();
      // snow cap
      ctx.fillStyle='white';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+G/2-6,gy+12);ctx.lineTo(gx+G/2+6,gy+12);ctx.closePath();ctx.fill();
      // cloud
      const ca=.5+Math.sin(t*.5+cx)*.3;
      ctx.fillStyle=`rgba(255,255,255,${ca})`;
      ctx.beginPath();ctx.ellipse(gx+G/2+4,gy+6,5,3,0,0,Math.PI*2);ctx.fill();
      break;}
    case 'ocean':{
      // Beach + ocean
      // sand
      ctx.fillStyle='#f5deb3'; ctx.fillRect(gx,gy,G,G/3+4);
      // water gradient
      const wg=ctx.createLinearGradient(0,gy+G/3,0,gy+G);
      wg.addColorStop(0,'#039be5'); wg.addColorStop(1,'#01579b');
      ctx.fillStyle=wg; ctx.fillRect(gx,gy+G/3,G,G-G/3);
      // waves
      const wt=(animFrame/30+cx*.5)%1;
      ctx.strokeStyle=`rgba(255,255,255,${.3+wt*.4})`; ctx.lineWidth=1.5; ctx.setLineDash([4,4]);
      ctx.beginPath();ctx.moveTo(gx,gy+G/2+wt*6);ctx.lineTo(gx+G,gy+G/2+wt*6);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gx,gy+G*0.7+(1-wt)*5);ctx.lineTo(gx+G,gy+G*0.7+(1-wt)*5);ctx.stroke();
      ctx.setLineDash([]);
      // sun reflection
      ctx.fillStyle=`rgba(255,220,80,${.1+Math.sin(t+cx)*.05})`;
      ctx.fillRect(gx+G/2-3,gy+G/3,6,G-G/3);
      // umbrella
      ctx.fillStyle='#e53935'; ctx.beginPath();ctx.ellipse(gx+8,gy+8,7,4,-.3,0,Math.PI);ctx.fill();
      ctx.strokeStyle='#795548'; ctx.lineWidth=1; ctx.setLineDash([]);
      ctx.beginPath();ctx.moveTo(gx+8,gy+8);ctx.lineTo(gx+10,gy+18);ctx.stroke();
      break;}
    case 'apartment':{
      ctx.fillStyle='#546e7a'; ctx.fillRect(gx+3,gy+2,G-6,G-3);
      ctx.fillStyle='#37474f'; ctx.fillRect(gx+3,gy+2,G-6,4);
      for(let row=0;row<3;row++) for(let col=0;col<2;col++){
        const lit=Math.sin(t+cx*1.3+cy*.7+row*2+col*4)>0;
        ctx.fillStyle=lit?'#ffe082':'#1a237e';
        ctx.fillRect(gx+6+col*14,gy+8+row*10,8,7);
      }
      ctx.fillStyle='#263238'; ctx.fillRect(gx+G/2-4,gy+G-10,8,10);
      break;}
    case 'shop':{
      ctx.fillStyle='#e65100'; ctx.fillRect(gx+2,gy+G-24,G-4,24);
      ctx.fillStyle='#f57c00'; ctx.fillRect(gx+2,gy+G-27,G-4,4);
      ctx.fillStyle='#ffe082'; ctx.fillRect(gx+5,gy+G-22,G-10,7);
      ctx.fillStyle=`rgba(200,230,255,${.6+Math.sin(t*1.5)*.2})`; ctx.fillRect(gx+5,gy+G-14,G-10,8);
      break;}
    case 'clinic':{
      ctx.fillStyle='#f5f5f5'; ctx.fillRect(gx+3,gy+8,G-6,G-9);
      ctx.fillStyle='#c62828'; ctx.fillRect(gx+3,gy+8,G-6,7);
      ctx.fillStyle='white'; ctx.fillRect(gx+G/2-1.5,gy+9,3,5); ctx.fillRect(gx+G/2-4,gy+10.5,8,2);
      ctx.fillStyle='#90caf9';
      ctx.fillRect(gx+5,gy+18,7,6); ctx.fillRect(gx+G-12,gy+18,7,6);
      break;}
    case 'school':{
      ctx.fillStyle='#fff8e1'; ctx.fillRect(gx+2,gy+12,G-4,G-13);
      ctx.fillStyle='#f9a825'; ctx.fillRect(gx+2,gy+8,G-4,6);
      ctx.fillStyle='#e65100';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+2,gy+10);ctx.lineTo(gx+G-2,gy+10);ctx.closePath();ctx.fill();
      ctx.fillStyle='#90caf9';
      ctx.fillRect(gx+5,gy+16,8,7); ctx.fillRect(gx+G-13,gy+16,8,7);
      break;}
    case 'condo':{
      ctx.fillStyle='#263238'; ctx.fillRect(gx+G/2-8,gy+1,16,G-2);
      ctx.fillStyle='#37474f'; ctx.fillRect(gx+2,gy+G-20,G-4,20);
      for(let row=0;row<5;row++) for(let col=0;col<2;col++){
        const lit=Math.sin(t*.8+cx*2+cy+row*1.7+col*3.2)>-.1;
        ctx.fillStyle=lit?'#ffd54f':'#0d47a1';
        ctx.fillRect(gx+G/2-7+col*8,gy+3+row*8,5,5);
      }
      for(let col=0;col<3;col++){
        ctx.fillStyle=Math.sin(t+col*2)>0?'#ffcc02':'#1565c0';
        ctx.fillRect(gx+4+col*12,gy+G-16,8,8);
      }
      ctx.fillStyle='#00bcd4'; ctx.fillRect(gx+G/2-8,gy,16,2);
      break;}
    case 'office':{
      ctx.fillStyle='#0d47a1'; ctx.fillRect(gx+4,gy+1,G-8,G-2);
      for(let row=0;row<6;row++){
        ctx.fillStyle=`rgba(144,202,249,${.3+Math.sin(t*.3+row*.5)*.15})`;
        ctx.fillRect(gx+6,gy+3+row*6,G-12,4);
      }
      ctx.strokeStyle='#42a5f5'; ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(gx+G/2,gy-5);ctx.lineTo(gx+G/2,gy+2);ctx.stroke();
      ctx.fillStyle='#42a5f5'; ctx.beginPath();ctx.arc(gx+G/2,gy-5,2,0,Math.PI*2);ctx.fill();
      break;}
    case 'hotel':{
      ctx.fillStyle='#4a148c'; ctx.fillRect(gx+3,gy+4,G-6,G-5);
      ctx.fillStyle='#38006b';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy);ctx.lineTo(gx+3,gy+6);ctx.lineTo(gx+G-3,gy+6);ctx.closePath();ctx.fill();
      for(let row=0;row<4;row++) for(let col=0;col<3;col++){
        ctx.fillStyle=Math.sin(t+row*1.3+col*2.1+cx)>0?'#ffe082':'#1a0033';
        ctx.fillRect(gx+5+col*11,gy+10+row*8,7,5);
      }
      break;}
    case 'stadium':{
      ctx.fillStyle='#1c1c1c';
      ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-2,G/3,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#2e7d32';
      ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-7,G/3-4,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#33691e'; ctx.lineWidth=1;
      ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-12,G/3-8,0,0,Math.PI*2);ctx.stroke();
      [[4,4],[G-4,4],[4,G-4],[G-4,G-4]].forEach(([lx,ly])=>{
        ctx.fillStyle=Math.sin(t*2+lx*.1)>.5?'#fff176':'#f57f17';
        ctx.beginPath();ctx.arc(gx+lx,gy+ly,2,0,Math.PI*2);ctx.fill();
      });
      break;}
    case 'skyscraper':{
      ctx.fillStyle='#1a237e'; ctx.fillRect(gx+1,gy+G-18,G-2,18);
      ctx.fillStyle='#0d1b4a'; ctx.fillRect(gx+6,gy+2,G-12,G-18);
      ctx.fillStyle='#1565c0'; ctx.fillRect(gx+G/2-4,gy-4,8,G/3);
      for(let row=0;row<7;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.6+cx*1.5+cy+row*1.2+col*2.8)>0?'#bbdefb':'#0a1433';
        ctx.fillRect(gx+8+col*10,gy+4+row*5,7,3);
      }
      ctx.fillStyle=Math.sin(t*4)>0?'#ef5350':'#b71c1c';
      ctx.beginPath();ctx.arc(gx+G/2,gy-4,2.5,0,Math.PI*2);ctx.fill();
      break;}
    case 'mall':{
      ctx.fillStyle='#37474f'; ctx.fillRect(gx,gy+G-22,G,22);
      ctx.fillStyle='#546e7a'; ctx.fillRect(gx+8,gy+G-36,G-16,14);
      ctx.fillStyle=`rgba(144,202,249,${.3+Math.sin(t*.3)*.15})`; ctx.fillRect(gx+10,gy+G-34,G-20,10);
      ['#ef9a9a','#a5d6a7','#90caf9','#fff59d'].forEach((c,i)=>{
        if(i*10<G-4){ ctx.fillStyle=c; ctx.fillRect(gx+2+i*10,gy+G-18,8,10); }
      });
      break;}
    case 'luxury':{
      ctx.fillStyle='#0a0a0a'; ctx.fillRect(gx+G/2-8,gy,16,G);
      ctx.fillStyle='#111'; ctx.fillRect(gx+1,gy+G-20,G-2,20);
      ctx.strokeStyle='#d4af37'; ctx.lineWidth=.5;
      ctx.strokeRect(gx+G/2-8,gy,16,G); ctx.strokeRect(gx+1,gy+G-20,G-2,20);
      for(let row=0;row<6;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.5+cx*2+row*1.5+col*3)>0?'#d4af37':'#1a1500';
        ctx.fillRect(gx+G/2-7+col*8,gy+2+row*7,5,4);
      }
      ctx.fillStyle='#d4af37'; ctx.fillRect(gx+G/2-1,gy-6,2,6);
      ctx.beginPath();ctx.moveTo(gx+G/2,gy-10);ctx.lineTo(gx+G/2-3,gy-6);ctx.lineTo(gx+G/2+3,gy-6);ctx.closePath();ctx.fill();
      break;}
    case 'airport':{
      ctx.fillStyle='#212121'; ctx.fillRect(gx,gy+G-16,G,16);
      ctx.fillStyle='#37474f'; ctx.fillRect(gx+4,gy+G-30,G-8,16);
      ctx.fillStyle='#455a64';
      ctx.beginPath();ctx.moveTo(gx+4,gy+G-30);ctx.quadraticCurveTo(gx+G/2,gy+G-38,gx+G-4,gy+G-30);
      ctx.lineTo(gx+G-4,gy+G-28);ctx.quadraticCurveTo(gx+G/2,gy+G-36,gx+4,gy+G-28);ctx.closePath();ctx.fill();
      for(let i=0;i<5;i++){
        ctx.fillStyle=`rgba(144,202,249,${.5+Math.sin(t+i)*.3})`;
        ctx.fillRect(gx+5+i*8,gy+G-27,5,8);
      }
      // plane animation
      const px=(animFrame*1.2+cx*13)%(G+20)-10;
      ctx.fillStyle='#eceff1'; ctx.fillRect(gx+px,gy+4,10,4);
      ctx.fillStyle='#b0bec5';
      ctx.beginPath();ctx.moveTo(gx+px+4,gy+4);ctx.lineTo(gx+px+2,gy+1);ctx.lineTo(gx+px+8,gy+4);ctx.closePath();ctx.fill();
      break;}
  }
  ctx.restore();
}

function drawCity(){
  cityX.clearRect(0,0,VW,VH);
  const c0=Math.floor(cam.x/GRID)-1, r0=Math.floor(cam.y/GRID)-1;
  const c1=Math.min(MAP_COLS-1, c0+Math.ceil(VW/GRID)+2);
  const r1=Math.min(MAP_ROWS-1, r0+Math.ceil(VH/GRID)+2);
  for(let r=r0;r<=r1;r++){
    for(let c=c0;c<=c1;c++){
      const key=`${c},${r}`;
      if(state.grid[key]){
        const sx=c*GRID-cam.x, sy=r*GRID-cam.y;
        drawBuilding(cityX, state.grid[key], sx, sy, c, r);
      }
    }
  }
}

// ==================== MINIMAP ====================
function drawMinimap(){
  const mw=160, mh=100;
  const sx=mw/MAP_COLS, sy=mh/MAP_ROWS;
  mmX.clearRect(0,0,mw,mh);
  // terrain
  for(let r=0;r<MAP_ROWS;r++){
    for(let c=0;c<MAP_COLS;c++){
      const t=TERRAIN[`${c},${r}`]||'grass';
      const colors={grass:'#2e6b2e',water:'#1a5f8a',sand:'#b8975a',hill:'#4a5c4a'};
      mmX.fillStyle=colors[t];
      mmX.fillRect(c*sx,r*sy,sx+.5,sy+.5);
    }
  }
  // buildings
  for(const key in state.grid){
    const[c,r]=key.split(',').map(Number);
    mmX.fillStyle='#f0b429';
    mmX.fillRect(c*sx,r*sy,sx+.5,sy+.5);
  }
  // viewport rect
  mmX.strokeStyle='rgba(255,255,255,0.6)'; mmX.lineWidth=1;
  mmX.strokeRect(
    cam.x/MAP_W*mw, cam.y/MAP_H*mh,
    VW/MAP_W*mw, VH/MAP_H*mh
  );
}

// ==================== MOUSE / DRAG ====================
function getMapCell(ex,ey){
  const mx=ex+cam.x, my=ey+cam.y;
  return[Math.floor(mx/GRID), Math.floor(my/GRID)];
}

const wrap=document.getElementById('map-wrap');

wrap.addEventListener('mousedown',e=>{
  dragging=false;
  dragStart={x:e.clientX,y:e.clientY};
  camStart={x:cam.x,y:cam.y};
  wrap.style.cursor='grabbing';
});

wrap.addEventListener('mousemove',e=>{
  const dx=e.clientX-dragStart.x, dy=e.clientY-dragStart.y;
  if(Math.abs(dx)>3||Math.abs(dy)>3) dragging=true;
  if(dragging&&e.buttons===1){
    cam.x=camStart.x-dx;
    cam.y=camStart.y-dy;
    clampCam();
  }
  // tooltip
  const rect=wrap.getBoundingClientRect();
  const[cx,cy]=getMapCell(e.clientX-rect.left, e.clientY-rect.top);
  const key=`${cx},${cy}`;
  const tt=document.getElementById('tooltip');
  if(state.grid[key]&&!dragging){
    const b=BUILDINGS.find(x=>x.id===state.grid[key]);
    document.getElementById('tt-name').textContent=b.name;
    if(b.nature){
      document.getElementById('tt-inc').textContent=`${b.desc} (‰ªä: +${(state.population*b.mult).toLocaleString()}/Áßí)`;
    } else {
      document.getElementById('tt-inc').textContent=`¬•${b.income}/Áßí`;
    }
    document.getElementById('tt-pop').textContent=b.pop;
    tt.style.left=Math.min(e.clientX-rect.left+12,VW-200)+'px';
    tt.style.top=Math.max(e.clientY-rect.top-80,4)+'px';
    tt.style.display='block';
  } else tt.style.display='none';
});

wrap.addEventListener('mouseup',e=>{
  wrap.style.cursor='crosshair';
  if(dragging){dragging=false;return;}
  const rect=wrap.getBoundingClientRect();
  const[cx,cy]=getMapCell(e.clientX-rect.left, e.clientY-rect.top);
  if(cx<0||cy<0||cx>=MAP_COLS||cy>=MAP_ROWS)return;
  const key=`${cx},${cy}`;
  handleClick(key,cx,cy,e.clientX-rect.left,e.clientY-rect.top);
});

wrap.addEventListener('mouseleave',()=>{
  document.getElementById('tooltip').style.display='none';
  dragging=false; wrap.style.cursor='crosshair';
});

// touch drag
let touch0={x:0,y:0};
wrap.addEventListener('touchstart',e=>{
  touch0={x:e.touches[0].clientX,y:e.touches[0].clientY};
  camStart={x:cam.x,y:cam.y}; dragging=false;
},{passive:true});
wrap.addEventListener('touchmove',e=>{
  const dx=e.touches[0].clientX-touch0.x, dy=e.touches[0].clientY-touch0.y;
  if(Math.abs(dx)>5||Math.abs(dy)>5) dragging=true;
  if(dragging){ cam.x=camStart.x-dx; cam.y=camStart.y-dy; clampCam(); }
},{passive:true});
wrap.addEventListener('touchend',e=>{
  if(dragging){dragging=false;return;}
  const rect=wrap.getBoundingClientRect();
  const tx=e.changedTouches[0].clientX-rect.left;
  const ty=e.changedTouches[0].clientY-rect.top;
  const[cx,cy]=getMapCell(tx,ty);
  if(cx>=0&&cy>=0&&cx<MAP_COLS&&cy<MAP_ROWS){
    handleClick(`${cx},${cy}`,cx,cy,tx,ty);
  }
});

// minimap click to teleport
mm.addEventListener('click',e=>{
  const rect=mm.getBoundingClientRect();
  const fx=(e.clientX-rect.left)/160, fy=(e.clientY-rect.top)/100;
  cam.x=fx*MAP_W - VW/2;
  cam.y=fy*MAP_H - VH/2;
  clampCam();
});

function handleClick(key,cx,cy,screenX,screenY){
  if(isDemolish){
    if(state.grid[key]){
      const b=BUILDINGS.find(x=>x.id===state.grid[key]);
      state.money+=Math.floor(b.cost*.4);
      state.population-=b.pop||0;
      delete state.grid[key];
      state.placedCount=Object.keys(state.grid).length;
      updateUI(); notify('üóë Âèñ„ÇäÂ£ä„Åó (+40%ËøîÈÇÑ)','rd');
    }
    return;
  }
  if(state.grid[key]){notify('‚ö† „Åô„Åß„Å´Âª∫Áâ©„Åå„ÅÇ„Çä„Åæ„Åô','rd');return;}
  const b=BUILDINGS.find(x=>x.id===selectedType);
  if(!b)return;
  if(b.stage>state.stage){notify('üîí „Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Åß„ÅØÊú™Ëß£Êîæ','rd');return;}
  if(state.money<b.cost){notify('üí∏ ‰∫àÁÆó„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ','rd');return;}
  // check terrain - can't build on water
  const terrain=TERRAIN[key]||'grass';
  if(terrain==='water'&&!['ocean'].includes(selectedType)){
    notify('üåä Êµ∑„Å´„ÅØÂª∫Áâ©„ÇíÂª∫„Å¶„Çâ„Çå„Åæ„Åõ„ÇìÔºÅ','rd');return;
  }
  state.money-=b.cost;
  state.population+=b.pop||0;
  state.grid[key]=selectedType;
  state.placedCount=Object.keys(state.grid).length;
  updateUI();
  notify(`‚úÖ ${b.name} Âª∫Ë®≠ (-¬•${b.cost.toLocaleString()})`,'gr');
  spawnFloat(screenX,screenY,`-¬•${b.cost.toLocaleString()}`,true);
}

// ==================== INCOME ====================
function calcIncome(){
  let t=0;
  let natureCounts={road:0,park:0,mountain:0,ocean:0};
  for(const id of Object.values(state.grid)){
    const b=BUILDINGS.find(x=>x.id===id);
    if(!b)continue;
    if(b.nature) natureCounts[id]=(natureCounts[id]||0)+1;
    else if(b.stage===1) t+=b.income;
  }
  // ST2‰ª•Èôç„ÅØËá™ÁÑ∂ÊñΩË®≠„ÅÆmult„Çí1/100„Å´„Åô„Çã
  const naturalMultFactor = state.stage >= 2 ? 0.001 : 1;
  for(const [nid,cnt] of Object.entries(natureCounts)){
    const b=BUILDINGS.find(x=>x.id===nid);
    if(b&&b.mult) t+=state.population*b.mult*naturalMultFactor*cnt;
  }
  return t;
}

let lastTick2=Date.now();
function incomeTick(){
  const now=Date.now();
  const dt=(now-lastTick2)/1000;
  lastTick2=now;
  const inc=calcIncome();
  if(inc>0){
    const earned=inc*dt;
    state.money+=earned;
    state.totalEarned+=earned;
    updateUI();
    checkStage();
  }
}

// ==================== STAGE ====================
function checkStage(){
  const stg=STAGES[state.stage-1];
  if(!stg.goal)return;
  if(state.totalEarned>=stg.goal&&state.stage<STAGES.length) showModal();
}
function showModal(){
  document.getElementById('m-title').textContent=`„Çπ„ÉÜ„Éº„Ç∏ ${state.stage} „ÇØ„É™„Ç¢ÔºÅ`;
  document.getElementById('m-desc').textContent=`¬•${Math.floor(state.money).toLocaleString()} Áç≤ÂæóÔºÅ\nÊñ∞„Åó„ÅÑÂª∫Áâ©„ÅåËß£Êîæ„Åï„Çå„Åæ„Åô„ÄÇ`;
  document.getElementById('m-stars').textContent='‚≠ê'.repeat(Math.min(state.stage,5));
  document.getElementById('modal').classList.add('show');
}
function nextStage(){
  document.getElementById('modal').classList.remove('show');
  state.stage++; state.totalEarned=0;
  state.money = 500; // ST2‰ª•Èôç„ÅØÊ•µË≤ß„Çπ„Çø„Éº„ÉàÔºÅ
  updateUI(); buildSidebar();
  notify(`üéâ „Çπ„ÉÜ„Éº„Ç∏${state.stage}„Å∏ÔºÅ‰∫àÁÆó„É™„Çª„ÉÉ„ÉàÔºÅ`,'pu');
}

// ==================== UI ====================
function updateUI(){
  document.getElementById('s-money').textContent=Math.floor(state.money).toLocaleString();
  document.getElementById('s-income').textContent=Math.floor(calcIncome()).toLocaleString();
  document.getElementById('s-pop').textContent=state.population.toLocaleString();
  document.getElementById('s-bld').textContent=state.placedCount;
  document.getElementById('s-stage').textContent=state.stage;
  const stg=STAGES[state.stage-1];
  document.getElementById('stage-name').textContent=`„Çπ„ÉÜ„Éº„Ç∏${state.stage}: ${stg.name}`;
  if(stg.goal){
    const pct=Math.min(state.totalEarned/stg.goal*100,100);
    document.getElementById('stage-fill').style.width=pct+'%';
    document.getElementById('stage-goal-txt').textContent=`ÁõÆÊ®ô: ¬•${stg.goal.toLocaleString()} (${Math.floor(pct)}%)`;
  } else {
    document.getElementById('stage-fill').style.width='100%';
    document.getElementById('stage-goal-txt').textContent='ÊúÄÁµÇ„Çπ„ÉÜ„Éº„Ç∏ ‚Äî Ëá™Áî±Âª∫Ë®≠ÔºÅ';
  }
}

function notify(text,type='gd'){
  const el=document.getElementById('notif');
  el.textContent=text; el.className=`notif show ${type}`;
  clearTimeout(notifTO);
  notifTO=setTimeout(()=>el.classList.remove('show'),2200);
}

function spawnFloat(x,y,text,isDebit){
  const c=document.getElementById('map-wrap');
  const el=document.createElement('div');
  el.className='ifloat';
  el.textContent=text;
  el.style.left=x+'px'; el.style.top=y+'px';
  el.style.color=isDebit?'#f85149':'#3fb950';
  c.appendChild(el);
  setTimeout(()=>el.remove(),1400);
}

// ==================== SAVE / LOAD ====================
const SK='cityArchPro_v3';
function saveGame(){
  try{
    localStorage.setItem(SK,JSON.stringify({...state,money:Math.floor(state.money),cam,savedAt:new Date().toISOString()}));
    notify('üíæ „Çª„Éº„Éñ„Åó„Åæ„Åó„ÅüÔºÅ','gr');
  }catch(e){notify('‚ùå „Çª„Éº„ÉñÂ§±Êïó','rd');}
}
function loadGame(){
  try{
    const raw=localStorage.getItem(SK);
    if(!raw){notify('üìÇ „Çª„Éº„Éñ„Éá„Éº„Çø„Å™„Åó','rd');return;}
    const d=JSON.parse(raw);
    Object.assign(state,{money:d.money||10000,totalEarned:d.totalEarned||0,population:d.population||0,stage:d.stage||1,grid:d.grid||{},placedCount:Object.keys(d.grid||{}).length});
    if(d.cam) Object.assign(cam,d.cam);
    clampCam();
    updateUI(); buildSidebar(); drawBg(); drawCity();
    notify(`üìÇ „É≠„Éº„ÉâÂÆå‰∫ÜÔºÅ`,'gd');
  }catch(e){notify('‚ùå „É≠„Éº„ÉâÂ§±Êïó','rd');}
}
function confirmReset(){
  if(confirm('Êú¨ÂΩì„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')){
    localStorage.removeItem(SK);
    state={money:10000,totalEarned:0,population:0,stage:1,grid:{},placedCount:0};
    cam={x:MAP_W/2-VW/2,y:MAP_H/2-VH/2}; clampCam();
    selectedType='house'; isDemolish=false;
    updateUI(); buildSidebar(); drawBg(); drawCity();
    notify('üîÑ „É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü','gd');
  }
}

// ==================== LOOP ====================
function animate(){
  animFrame++;
  incomeTick();
  if(animFrame%3===0) drawBg();
  drawCity();
  if(animFrame%10===0) drawMinimap();
  requestAnimationFrame(animate);
}

// ==================== INIT ====================
generateTerrain();
window.addEventListener('resize',resize);
resize();

// center camera on start
cam.x=MAP_W/2-VW/2; cam.y=MAP_H/2-VH/2; clampCam();

buildSidebar(); updateUI();
setInterval(saveGame,30000);

const hasSave=localStorage.getItem(SK);
if(hasSave){
  setTimeout(()=>{if(confirm('ÂâçÂõû„ÅÆ„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„É≠„Éº„Éâ„Åó„Åæ„Åô„ÅãÔºü'))loadGame();},400);
}

animate();
</script>

</body>
</html>
