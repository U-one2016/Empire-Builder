<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMPIRE BUILDER - æ±äº¬ä¸å‹•ç”£æŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap');
:root{--bg:#0e1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--gold:#f0b429;--gold2:#d97706;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--purple:#bc8cff;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;user-select:none;}
header{display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;gap:10px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;color:var(--gold);white-space:nowrap;}
.stats-bar{display:flex;gap:5px;flex:1;justify-content:center;flex-wrap:wrap;}
.stat-chip{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 9px;display:flex;align-items:center;gap:5px;font-family:'JetBrains Mono',monospace;font-size:0.75rem;}
.stat-chip .lbl{color:var(--text2);font-size:0.6rem;}
.stat-chip .val{color:var(--gold);font-weight:700;}
.stat-chip.inc .val{color:var(--green);}
.stat-chip.debt .val{color:var(--red);}
.stat-chip.pop .val{color:var(--accent);}
.stat-chip.stg .val{color:var(--purple);}
.hbtns{display:flex;gap:5px;flex-shrink:0;}
.hbtn{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 11px;cursor:pointer;color:var(--text);font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;transition:all .15s;white-space:nowrap;}
.hbtn:hover{border-color:var(--gold);color:var(--gold);}
.hbtn.sv{border-color:var(--green);color:var(--green);}
.hbtn.sv:hover{background:rgba(63,185,80,.15);}
.stage-bar-wrap{padding:4px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;}
.stage-label{font-size:0.62rem;color:var(--text2);margin-bottom:3px;display:flex;justify-content:space-between;}
.stage-track{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.stage-fill{height:100%;background:linear-gradient(90deg,var(--gold2),var(--gold));border-radius:3px;transition:width .4s ease;}
.main{display:flex;flex:1;overflow:hidden;}
#map-wrap{flex:1;position:relative;overflow:hidden;cursor:crosshair;}
canvas{display:block;position:absolute;top:0;left:0;}
#cv-bg{z-index:1;}#cv-city{z-index:2;}#cv-ui{z-index:3;pointer-events:none;}
#minimap{position:absolute;bottom:10px;right:10px;border:1px solid var(--border);border-radius:6px;overflow:hidden;z-index:10;cursor:pointer;}
.sidebar{width:220px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;}
.sidebar::-webkit-scrollbar{width:4px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.sb-sec{padding:9px;border-bottom:1px solid var(--border);}
.sb-ttl{font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:7px;display:flex;align-items:center;gap:5px;}
.sb-ttl::after{content:'';flex:1;height:1px;background:var(--border);}
.bld-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 8px;cursor:pointer;display:flex;align-items:center;gap:7px;color:var(--text);font-family:'Noto Sans JP',sans-serif;margin-bottom:4px;transition:all .15s;position:relative;text-align:left;}
.bld-btn:hover{border-color:rgba(240,180,41,.5);background:var(--surface);}
.bld-btn.active{border-color:var(--gold);background:rgba(240,180,41,.08);}
.bld-btn.locked{opacity:.4;cursor:not-allowed;}
.bld-btn.locked:hover{border-color:var(--border);background:var(--surface2);}
.bld-ico{width:32px;height:32px;flex-shrink:0;border-radius:4px;overflow:hidden;}
.bld-info{flex:1;min-width:0;}
.bld-name{font-size:0.74rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bld-meta{display:flex;gap:4px;margin-top:2px;flex-wrap:wrap;}
.bc{font-size:0.6rem;color:var(--gold);font-family:'JetBrains Mono',monospace;}
.bi{font-size:0.6rem;color:var(--green);font-family:'JetBrains Mono',monospace;}
.bp{font-size:0.6rem;color:var(--accent);font-family:'JetBrains Mono',monospace;}
.br{font-size:0.6rem;color:var(--red);font-family:'JetBrains Mono',monospace;}
.lk-badge{position:absolute;top:3px;right:3px;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1px 3px;font-size:0.52rem;color:var(--text2);}
.tool-btns{display:flex;flex-direction:column;gap:4px;}
.tbtn{width:100%;border-radius:7px;padding:7px 9px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:0.74rem;transition:all .15s;border:1px solid;text-align:center;}
.tbtn.demo{background:rgba(248,81,73,.1);border-color:var(--red);color:var(--red);}
.tbtn.demo:hover,.tbtn.demo.on{background:rgba(248,81,73,.25);}
.tbtn.repair{background:rgba(88,166,255,.1);border-color:var(--accent);color:var(--accent);}
.tbtn.repair:hover,.tbtn.repair.on{background:rgba(88,166,255,.25);}
.tbtn.rst{background:rgba(139,148,158,.1);border-color:var(--border);color:var(--text2);}
.tbtn.rst:hover{background:rgba(139,148,158,.2);color:var(--text);}
.tooltip{position:absolute;background:var(--surface);border:1px solid var(--gold);padding:7px 11px;border-radius:8px;font-size:0.7rem;pointer-events:none;z-index:100;display:none;box-shadow:0 4px 20px rgba(0,0,0,.5);max-width:240px;}
.tooltip .ttn{font-weight:700;margin-bottom:3px;color:var(--gold);}
.tooltip .ttr{color:var(--text2);font-size:0.62rem;line-height:1.7;}
.tooltip .ttr span{color:var(--text);}
.tooltip .ttr .up{color:var(--green);}
.tooltip .ttr .dn{color:var(--red);}
.notif{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);padding:7px 16px;border-radius:20px;font-size:0.77rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:200;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4);}
.notif.show{opacity:1;}
.notif.gd{border-color:var(--gold);color:var(--gold);}
.notif.gr{border-color:var(--green);color:var(--green);}
.notif.rd{border-color:var(--red);color:var(--red);}
.notif.pu{border-color:var(--purple);color:var(--purple);}
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;}
.modal-ov.show{display:flex;}
.modal{background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:32px 44px;text-align:center;max-width:440px;box-shadow:0 0 60px rgba(240,180,41,.25);}
.modal h2{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:4px;color:var(--gold);margin-bottom:6px;}
.modal p{color:var(--text2);margin-bottom:22px;font-size:0.88rem;white-space:pre-line;}
.modal-btn{background:var(--gold);color:#000;border:none;padding:11px 28px;border-radius:8px;font-size:.95rem;font-weight:700;font-family:'Noto Sans JP',sans-serif;cursor:pointer;margin:4px;}
.modal-btn:hover{background:var(--gold2);}
.modal-btn.secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.modal-btn.secondary:hover{border-color:var(--gold);}
.mstars{font-size:1.8rem;margin-bottom:10px;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-45px)}}
.ifloat{position:absolute;font-family:'JetBrains Mono',monospace;font-size:0.72rem;pointer-events:none;z-index:150;animation:floatUp 1.4s ease forwards;font-weight:700;}
.scroll-hint{position:absolute;bottom:46px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.35);font-size:0.65rem;pointer-events:none;z-index:10;}
.event-log{position:absolute;bottom:10px;left:10px;z-index:10;display:flex;flex-direction:column;gap:3px;max-width:280px;pointer-events:none;}
.ev-item{background:rgba(22,27,34,.92);border:1px solid var(--border);border-radius:5px;padding:3px 7px;font-size:0.6rem;backdrop-filter:blur(4px);display:flex;gap:5px;align-items:center;}
.ev-item.good{border-color:var(--green);color:var(--green);}
.ev-item.bad{border-color:var(--red);color:var(--red);}
.ev-item.neutral{border-color:var(--gold);color:var(--gold);}
.ev-item .ev-date{color:var(--text2);font-family:'JetBrains Mono',monospace;font-size:0.55rem;flex-shrink:0;}
.loan-body{text-align:left;margin-bottom:18px;}
.loan-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;margin-bottom:14px;}
.loan-lbl{font-size:0.65rem;color:var(--text2);}
.loan-val{font-size:0.85rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
.loan-val.green{color:var(--green);}
.loan-val.red{color:var(--red);}
.loan-val.gold{color:var(--gold);}
.loan-sep{border:none;border-top:1px solid var(--border);margin:10px 0;}
.loan-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
.loan-row label{font-size:0.72rem;color:var(--text2);white-space:nowrap;}
.loan-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:0.85rem;outline:none;}
.loan-row input:focus{border-color:var(--gold);}
.port-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px 8px;}
.port-item{display:flex;flex-direction:column;}
.port-lbl{font-size:0.52rem;color:var(--text2);}
.port-val{font-size:0.7rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text);}
</style>
</head>
<body>
<header>
  <div class="logo">ğŸ™ æ±äº¬ EMPIRE BUILDER</div>
  <div class="stats-bar">
    <div class="stat-chip"><span class="lbl">ğŸ’° ç¾é‡‘</span><span class="val" id="s-money">1å„„å††</span></div>
    <div class="stat-chip inc"><span class="lbl">ğŸ  è³‡ç”£ç·é¡</span><span class="val" id="s-assets">0</span></div>
    <div class="stat-chip debt"><span class="lbl">ğŸ’³ å€Ÿå…¥æ®‹é«˜</span><span class="val" id="s-debt">0</span></div>
    <div class="stat-chip pop"><span class="lbl">ğŸ“Š ç´”è³‡ç”£</span><span class="val" id="s-networth">1å„„å††</span></div>
    <div class="stat-chip stg"><span class="lbl">ğŸ“…</span><span class="val" id="s-date">1å¹´ 1æœˆ</span></div>
  </div>
  <div class="hbtns">
    <button class="hbtn" onclick="openLoanDialog()">ğŸ’³ å€Ÿå…¥</button>
    <button class="hbtn sv" onclick="saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
    <button class="hbtn" onclick="loadGame()">ğŸ“‚ ãƒ­ãƒ¼ãƒ‰</button>
  </div>
</header>
<div class="stage-bar-wrap">
  <div class="stage-label">
    <span id="milestone-name">åˆå¿ƒè€…æŠ•è³‡å®¶</span>
    <span id="milestone-goal">æ¬¡: ç´”è³‡ç”£ 5å„„å††</span>
  </div>
  <div class="stage-track"><div class="stage-fill" id="milestone-fill" style="width:0%"></div></div>
</div>
<div class="main">
  <div id="map-wrap">
    <canvas id="cv-bg"></canvas>
    <canvas id="cv-city"></canvas>
    <canvas id="cv-ui"></canvas>
    <canvas id="minimap" width="160" height="100"></canvas>
    <div class="tooltip" id="tooltip">
      <div class="ttn" id="tt-name"></div>
      <div class="ttr" id="tt-val-row">è©•ä¾¡é¡: <span id="tt-val"></span></div>
      <div class="ttr" id="tt-cost-row">è³¼å…¥ä¾¡æ ¼: <span id="tt-cost"></span> (<span id="tt-change"></span>)</div>
      <div class="ttr" id="tt-rent-row">æœˆé¡è³ƒæ–™: <span id="tt-rent"></span></div>
      <div class="ttr" id="tt-vac-row">ç©ºå®¤ç‡: <span id="tt-vac"></span></div>
      <div class="ttr" id="tt-cond-row">çŠ¶æ…‹: <span id="tt-cond"></span></div>
      <div class="ttr" id="tt-dist-row">åœ°åŒº: <span id="tt-dist"></span></div>
    </div>
    <div class="notif" id="notif"></div>
    <div class="event-log" id="event-log"></div>
    <div class="scroll-hint">ğŸ–± ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</div>
  </div>
  <div class="sidebar" id="sidebar"></div>
</div>
<div class="modal-ov" id="modal">
  <div class="modal">
    <div class="mstars" id="m-stars">â­â­â­</div>
    <h2 id="m-title">MILESTONE!</h2>
    <p id="m-desc">æ–°ã—ã„å»ºç‰©ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚</p>
    <button class="modal-btn" id="m-btn" onclick="closeModal()">OK â†’</button>
  </div>
</div>
<div class="modal-ov" id="loan-modal">
  <div class="modal" style="max-width:440px">
    <h2>ğŸ’³ èè³‡ã‚»ãƒ³ã‚¿ãƒ¼</h2>
    <div class="loan-body" id="loan-body"></div>
    <button class="modal-btn secondary" onclick="closeLoanDialog()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ==================== MONEY FORMAT (ä¸‡å††) ====================
function fmtMoney(v){
  v=Math.floor(v);
  const abs=Math.abs(v), sign=v<0?'-':'';
  if(abs>=10000){
    const oku=Math.floor(abs/10000), man=abs%10000;
    if(man===0) return sign+oku.toLocaleString()+'å„„å††';
    return sign+oku+'å„„'+man.toLocaleString()+'ä¸‡å††';
  }
  return sign+abs.toLocaleString()+'ä¸‡å††';
}

// ==================== BUILDINGS (prices in ä¸‡å††, based on real Tokyo data) ====================
// å…¬ç¤ºåœ°ä¾¡ 2024: åƒä»£ç”°åŒº ~520ä¸‡/ã¡, æ¸¯åŒº ~340ä¸‡/ã¡, æ¸‹è°·åŒº ~300ä¸‡/ã¡,
// ä¸–ç”°è°·åŒº ~55ä¸‡/ã¡, è¶³ç«‹åŒº ~30ä¸‡/ã¡, ç·´é¦¬åŒº ~35ä¸‡/ã¡
// Cap rates: residential 3-5%, commercial 3-6%, hotel 4-6%
const BUILDINGS = [
  // Tier 0 (start) - æ‰‹é ƒãªç‰©ä»¶
  {id:'cottage',   name:'å°è¦æ¨¡æˆ¸å»º',        cost:2500,   baseRent:10,   pop:3,   risk:1, tier:0, cat:'residential'},
  {id:'house',     name:'ä¸€èˆ¬ä½å®…',          cost:5000,   baseRent:18,   pop:5,   risk:1, tier:0, cat:'residential'},
  {id:'road',      name:'é“è·¯æ•´å‚™',          cost:800,    baseRent:0,    pop:0,   risk:0, tier:0, cat:'infra', repBonus:2},
  {id:'park',      name:'å…¬åœ’ãƒ»ç·‘åœ°',        cost:2000,   baseRent:0,    pop:0,   risk:0, tier:0, cat:'infra', repBonus:5},
  // Tier 1 (5å„„å†† net worth)
  {id:'apartment', name:'ã‚¢ãƒ‘ãƒ¼ãƒˆä¸€æ£Ÿ',      cost:12000,  baseRent:50,   pop:20,  risk:2, tier:1, cat:'residential'},
  {id:'shop',      name:'å•†åº—ãƒ»åº—èˆ—',        cost:8000,   baseRent:35,   pop:3,   risk:2, tier:1, cat:'commercial'},
  {id:'mountain',  name:'å±±æ—ãƒ»è¦³å…‰åœ°',      cost:3000,   baseRent:0,    pop:0,   risk:0, tier:1, cat:'infra', repBonus:8},
  {id:'ocean',     name:'ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ',cost:5000,   baseRent:0,    pop:0,   risk:0, tier:1, cat:'infra', repBonus:10},
  // Tier 2 (20å„„å††)
  {id:'clinic',    name:'ã‚¯ãƒªãƒ‹ãƒƒã‚¯',        cost:15000,  baseRent:65,   pop:5,   risk:2, tier:2, cat:'commercial'},
  {id:'school',    name:'å­¦æ ¡',              cost:20000,  baseRent:0,    pop:30,  risk:1, tier:2, cat:'infra', repBonus:12},
  {id:'condo',     name:'åˆ†è­²ãƒãƒ³ã‚·ãƒ§ãƒ³',    cost:40000,  baseRent:150,  pop:60,  risk:2, tier:2, cat:'residential'},
  {id:'office',    name:'ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«',      cost:50000,  baseRent:200,  pop:0,   risk:2, tier:2, cat:'commercial'},
  // Tier 3 (100å„„å††)
  {id:'hotel',     name:'ãƒ›ãƒ†ãƒ«',            cost:80000,  baseRent:350,  pop:0,   risk:3, tier:3, cat:'commercial'},
  {id:'stadium',   name:'ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',        cost:150000, baseRent:600,  pop:0,   risk:3, tier:3, cat:'commercial'},
  // Tier 4 (500å„„å††)
  {id:'skyscraper',name:'è¶…é«˜å±¤ãƒ“ãƒ«',        cost:300000, baseRent:1200, pop:0,   risk:3, tier:4, cat:'commercial'},
  {id:'mall',      name:'å•†æ¥­æ–½è¨­',          cost:200000, baseRent:800,  pop:0,   risk:3, tier:4, cat:'commercial'},
  {id:'luxury',    name:'ã‚¿ãƒ¯ãƒ¼ãƒãƒ³ã‚·ãƒ§ãƒ³',  cost:100000, baseRent:400,  pop:80,  risk:3, tier:4, cat:'residential'},
  {id:'airport',   name:'å›½éš›ç©ºæ¸¯',          cost:500000, baseRent:2000, pop:0,   risk:3, tier:4, cat:'commercial'},
];

const MILESTONES = [
  {threshold:10000,     title:'åˆå¿ƒè€…æŠ•è³‡å®¶'},   // 1å„„å††
  {threshold:50000,     title:'ä¸å‹•ç”£ã‚ªãƒ¼ãƒŠãƒ¼'}, // 5å„„å††
  {threshold:200000,    title:'åœ°åŸŸé–‹ç™ºè€…'},     // 20å„„å††
  {threshold:1000000,   title:'ä¸å‹•ç”£ç‹'},       // 100å„„å††
  {threshold:5000000,   title:'ãƒ¡ã‚¬æŠ•è³‡å®¶'},     // 500å„„å††
];

const EVENT_TYPES = [
  {id:'boom',   name:'æ±äº¬å¸‚å ´å¥½æ³',   weight:5, type:'good',    icon:'ğŸ“ˆ'},
  {id:'crash',  name:'ä¸å‹•ç”£å¸‚å ´æš´è½', weight:3, type:'bad',     icon:'ğŸ“‰'},
  {id:'quake',  name:'åœ°éœ‡',           weight:2, type:'bad',     icon:'ğŸŒ‹'},
  {id:'fire',   name:'ç«ç½',           weight:3, type:'bad',     icon:'ğŸ”¥'},
  {id:'exodus', name:'äººå£æµå‡º',       weight:4, type:'bad',     icon:'ğŸšª'},
  {id:'redev',  name:'å†é–‹ç™ºäº‹æ¥­',     weight:5, type:'good',    icon:'ğŸ—'},
  {id:'rate',   name:'æ—¥éŠ€é‡‘åˆ©å¤‰å‹•',   weight:8, type:'neutral', icon:'ğŸ’¹'},
  {id:'vacancy',name:'ç©ºå®¤å¢—åŠ ',       weight:6, type:'bad',     icon:'ğŸš'},
];

// Real Tokyo district data: base reputation from å…¬ç¤ºåœ°ä¾¡/åœ°ä¾¡å…¬ç¤º trends
// trend = monthly reputation drift (reflects 2015-2024 appreciation trends)
const DIST_DATA = [
  // Row 0 (north) â€” x=0-19,y=0-16 | x=20-39 | x=40-59 | x=60-79
  {name:'ç·´é¦¬ãƒ»æ¿æ©‹',   baseRep:48, trend:0.06, desc:'ä½å®…è¡— åœ°ä¾¡~35ä¸‡/ã¡'},
  {name:'ä¸­é‡ãƒ»æ‰ä¸¦',   baseRep:58, trend:0.08, desc:'æ–‡åŒ–ãƒ»ä½å®… åœ°ä¾¡~55ä¸‡/ã¡'},
  {name:'è±Šå³¶ãƒ»æ–‡äº¬',   baseRep:65, trend:0.12, desc:'æ± è¢‹ åœ°ä¾¡~90ä¸‡/ã¡'},
  {name:'è¶³ç«‹ãƒ»è‘›é£¾',   baseRep:35, trend:0.05, desc:'ä¸‹ç”º åœ°ä¾¡~28ä¸‡/ã¡'},
  // Row 1 (center) â€” y=17-33
  {name:'ä¸–ç”°è°·',       baseRep:70, trend:0.08, desc:'é«˜ç´šä½å®… åœ°ä¾¡~55ä¸‡/ã¡'},
  {name:'æ¸‹è°·ãƒ»æ–°å®¿',   baseRep:88, trend:0.18, desc:'éƒ½å¿ƒä¸€ç­‰åœ° åœ°ä¾¡~300ä¸‡/ã¡'},
  {name:'åƒä»£ç”°ãƒ»ä¸­å¤®',  baseRep:92, trend:0.15, desc:'ä¸¸ã®å†…ãƒ»éŠ€åº§ åœ°ä¾¡~520ä¸‡/ã¡'},
  {name:'å¢¨ç”°ãƒ»æ±Ÿæ±',   baseRep:52, trend:0.15, desc:'æ¹¾å²¸å†é–‹ç™º åœ°ä¾¡~45ä¸‡/ã¡'},
  // Row 2 (south) â€” y=34-49
  {name:'èª¿å¸ƒãƒ»åºœä¸­',   baseRep:42, trend:0.04, desc:'éƒŠå¤–ä½å®… åœ°ä¾¡~30ä¸‡/ã¡'},
  {name:'ç›®é»’ãƒ»å¤§ç”°',   baseRep:65, trend:0.10, desc:'ä½å®…å•†æ¥­ åœ°ä¾¡~65ä¸‡/ã¡'},
  {name:'å“å·ãƒ»æ¸¯åŒº',   baseRep:80, trend:0.16, desc:'å†é–‹ç™º åœ°ä¾¡~280ä¸‡/ã¡'},
  {name:'å°å ´ãƒ»æ¹¾å²¸',   baseRep:55, trend:0.12, desc:'ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ãƒ­ãƒ³ãƒˆ'},
];

const CATS = [
  {label:'ğŸ˜ ä½å±…',    ids:['cottage','house','apartment','condo','luxury']},
  {label:'ğŸ¬ å•†æ¥­',    ids:['shop','clinic','office','hotel','stadium','skyscraper','mall','airport']},
  {label:'ğŸŒ¿ ã‚¤ãƒ³ãƒ•ãƒ©',ids:['road','park','mountain','ocean','school']},
];

// ==================== SVG ICONS ====================
const SVGS={
  cottage:`<svg viewBox="0 0 32 32"><rect x="5" y="17" width="22" height="13" fill="#8B7355" rx="1"/><polygon points="16,5 3,19 29,19" fill="#6B4F35"/><rect x="12" y="24" width="8" height="6" fill="#3D2B1F"/><rect x="6" y="19" width="5" height="5" fill="#C4A882"/></svg>`,
  house:`<svg viewBox="0 0 32 32"><rect x="3" y="15" width="26" height="15" fill="#C4956A" rx="1"/><polygon points="16,3 1,17 31,17" fill="#8B6347"/><rect x="11" y="23" width="10" height="7" fill="#5C3A21"/><rect x="4" y="17" width="6" height="6" fill="#87CEEB" opacity=".8"/><rect x="22" y="17" width="6" height="6" fill="#87CEEB" opacity=".8"/></svg>`,
  road:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#1a1a1a"/><line x1="0" y1="16" x2="32" y2="16" stroke="#F0B429" stroke-width="1.5" stroke-dasharray="5,4"/><line x1="16" y1="0" x2="16" y2="32" stroke="#F0B429" stroke-width="1.5" stroke-dasharray="5,4"/></svg>`,
  park:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#2e7d32"/><circle cx="10" cy="14" r="8" fill="#1b5e20"/><circle cx="24" cy="17" r="6" fill="#1b5e20"/><circle cx="10" cy="14" r="5" fill="#4caf50"/><circle cx="24" cy="17" r="4" fill="#4caf50"/><rect x="9" y="18" width="2" height="12" fill="#5c3a1e"/><rect x="23" y="20" width="2" height="10" fill="#5c3a1e"/></svg>`,
  mountain:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#546e7a"/><polygon points="16,2 2,28 30,28" fill="#78909c"/><polygon points="16,2 10,14 22,14" fill="white"/><polygon points="22,8 14,28 30,28" fill="#607d8b"/><polygon points="22,8 18,18 26,18" fill="#e0e0e0"/></svg>`,
  ocean:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#0277bd"/><rect x="0" y="20" width="32" height="12" fill="#01579b"/><rect x="0" y="24" width="32" height="4" fill="#039be5" opacity=".5"/><rect x="0" y="18" width="32" height="5" fill="#f5deb3"/><circle cx="8" cy="14" r="6" fill="#fff9c4"/><circle cx="22" cy="12" r="4" fill="#fffde7" opacity=".8"/></svg>`,
  apartment:`<svg viewBox="0 0 32 32"><rect x="4" y="3" width="24" height="29" fill="#6B7280" rx="1"/><rect x="4" y="3" width="24" height="4" fill="#4B5563"/><rect x="7" y="9" width="5" height="4" fill="#87CEEB" opacity=".9"/><rect x="15" y="9" width="5" height="4" fill="#FFE082"/><rect x="7" y="17" width="5" height="4" fill="#FFE082"/><rect x="15" y="17" width="5" height="4" fill="#87CEEB"/><rect x="11" y="27" width="10" height="5" fill="#374151"/></svg>`,
  shop:`<svg viewBox="0 0 32 32"><rect x="2" y="13" width="28" height="19" fill="#D97706" rx="1"/><rect x="2" y="9" width="28" height="6" fill="#B45309"/><rect x="2" y="6" width="28" height="5" fill="#F59E0B"/><rect x="7" y="19" width="8" height="9" fill="#92400E"/><rect x="19" y="19" width="9" height="6" fill="#FEF3C7" opacity=".8"/></svg>`,
  clinic:`<svg viewBox="0 0 32 32"><rect x="3" y="7" width="26" height="25" fill="#F8FAFC" rx="1"/><rect x="3" y="7" width="26" height="6" fill="#EF4444"/><rect x="13" y="1" width="6" height="8" fill="#EF4444"/><rect x="14" y="3" width="4" height="4" fill="white"/><rect x="7" y="17" width="8" height="8" fill="#87CEEB"/><rect x="19" y="17" width="8" height="8" fill="#87CEEB"/></svg>`,
  school:`<svg viewBox="0 0 32 32"><rect x="2" y="11" width="28" height="21" fill="#FEF3C7" rx="1"/><rect x="2" y="7" width="28" height="6" fill="#D97706"/><polygon points="16,1 2,9 30,9" fill="#B45309"/><rect x="6" y="17" width="6" height="6" fill="#87CEEB"/><rect x="20" y="17" width="6" height="6" fill="#87CEEB"/><rect x="12" y="25" width="8" height="7" fill="#92400E"/></svg>`,
  condo:`<svg viewBox="0 0 32 32"><rect x="9" y="0" width="14" height="32" fill="#263238" rx="1"/><rect x="4" y="15" width="24" height="17" fill="#37474f" rx="1"/><rect x="10" y="3" width="4" height="3" fill="#93C5FD"/><rect x="16" y="3" width="4" height="3" fill="#FDE68A"/><rect x="10" y="9" width="4" height="3" fill="#FDE68A"/><rect x="16" y="9" width="4" height="3" fill="#93C5FD"/><rect x="6" y="18" width="4" height="3" fill="#93C5FD"/><rect x="13" y="18" width="4" height="3" fill="#FDE68A"/><rect x="20" y="18" width="4" height="3" fill="#93C5FD"/><rect x="6" y="24" width="4" height="3" fill="#FDE68A"/><rect x="13" y="24" width="4" height="3" fill="#93C5FD"/><rect x="20" y="24" width="4" height="3" fill="#FDE68A"/></svg>`,
  office:`<svg viewBox="0 0 32 32"><rect x="5" y="1" width="22" height="31" fill="#1E3A5F" rx="1"/><rect x="7" y="4" width="8" height="4" fill="#93C5FD" opacity=".8"/><rect x="17" y="4" width="8" height="4" fill="#93C5FD" opacity=".8"/><rect x="7" y="11" width="8" height="4" fill="#BAE6FD"/><rect x="17" y="11" width="8" height="4" fill="#93C5FD"/><rect x="7" y="18" width="8" height="4" fill="#93C5FD"/><rect x="17" y="18" width="8" height="4" fill="#BAE6FD"/><rect x="7" y="25" width="18" height="4" fill="#BAE6FD" opacity=".6"/></svg>`,
  hotel:`<svg viewBox="0 0 32 32"><rect x="4" y="5" width="24" height="27" fill="#7C2D12" rx="1"/><rect x="4" y="5" width="24" height="5" fill="#9A3412"/><polygon points="16,0 4,7 28,7" fill="#B45309"/><rect x="7" y="13" width="5" height="4" fill="#FDE68A"/><rect x="14" y="13" width="5" height="4" fill="#FDE68A"/><rect x="21" y="13" width="5" height="4" fill="#FDE68A"/><rect x="7" y="20" width="5" height="4" fill="#FDE68A"/><rect x="14" y="20" width="5" height="4" fill="#FDE68A"/><rect x="21" y="20" width="5" height="4" fill="#FDE68A"/><rect x="12" y="27" width="8" height="5" fill="#6B1A0A"/></svg>`,
  stadium:`<svg viewBox="0 0 32 32"><rect x="1" y="7" width="30" height="20" fill="#374151" rx="9"/><rect x="5" y="11" width="22" height="12" fill="#16A34A" rx="5"/><rect x="10" y="14" width="12" height="6" fill="#22C55E" rx="2"/><rect x="4" y="5" width="2" height="10" fill="#4B5563"/><rect x="26" y="5" width="2" height="10" fill="#4B5563"/><circle cx="5" cy="5" r="3" fill="#4B5563"/><circle cx="27" cy="5" r="3" fill="#4B5563"/></svg>`,
  skyscraper:`<svg viewBox="0 0 32 32"><rect x="7" y="13" width="18" height="19" fill="#334155" rx="1"/><rect x="10" y="0" width="12" height="32" fill="#1E293B" rx="1"/><rect x="11" y="2" width="4" height="3" fill="#BAE6FD"/><rect x="17" y="2" width="4" height="3" fill="#FDE68A"/><rect x="11" y="7" width="4" height="3" fill="#FDE68A"/><rect x="17" y="7" width="4" height="3" fill="#BAE6FD"/><rect x="8" y="15" width="4" height="3" fill="#BAE6FD"/><rect x="14" y="15" width="4" height="3" fill="#FDE68A"/><rect x="20" y="15" width="4" height="3" fill="#BAE6FD"/><rect x="8" y="21" width="4" height="3" fill="#FDE68A"/><rect x="14" y="21" width="4" height="3" fill="#BAE6FD"/><rect x="20" y="21" width="4" height="3" fill="#FDE68A"/><circle cx="16" cy="0" r="2" fill="#EF4444"/></svg>`,
  mall:`<svg viewBox="0 0 32 32"><rect x="0" y="13" width="32" height="19" fill="#475569" rx="2"/><rect x="8" y="5" width="16" height="10" fill="#334155" rx="1"/><rect x="0" y="9" width="32" height="6" fill="#334155"/><rect x="3" y="16" width="9" height="8" fill="#FDE68A" opacity=".7"/><rect x="14" y="16" width="9" height="8" fill="#BAE6FD" opacity=".7"/><rect x="25" y="16" width="5" height="8" fill="#FDE68A" opacity=".5"/></svg>`,
  luxury:`<svg viewBox="0 0 32 32"><rect x="10" y="0" width="12" height="32" fill="#1C1917" rx="1"/><rect x="3" y="19" width="26" height="13" fill="#292524" rx="1"/><rect x="11" y="2" width="4" height="3" fill="#D4AF37"/><rect x="17" y="2" width="4" height="3" fill="#FDE68A"/><rect x="11" y="7" width="4" height="3" fill="#FDE68A"/><rect x="17" y="7" width="4" height="3" fill="#D4AF37"/><rect x="5" y="21" width="5" height="4" fill="#D4AF37"/><rect x="13" y="21" width="5" height="4" fill="#FDE68A"/><rect x="21" y="21" width="5" height="4" fill="#D4AF37"/><rect x="5" y="27" width="5" height="4" fill="#FDE68A"/><rect x="13" y="27" width="5" height="4" fill="#D4AF37"/><rect x="21" y="27" width="5" height="4" fill="#FDE68A"/></svg>`,
  airport:`<svg viewBox="0 0 32 32"><rect x="0" y="21" width="32" height="11" fill="#212121"/><rect x="3" y="13" width="26" height="10" fill="#37474f"/><rect x="8" y="7" width="16" height="8" fill="#1E3A5F" rx="1"/><rect x="4" y="15" width="5" height="5" fill="#BAE6FD" opacity=".8"/><rect x="23" y="15" width="5" height="5" fill="#BAE6FD" opacity=".8"/><polygon points="16,3 10,9 22,9" fill="#334155"/><rect x="27" y="9" width="4" height="14" fill="#546e7a"/><rect x="25" y="9" width="8" height="4" fill="#80cbc4"/></svg>`,
};

// ==================== GRID CONSTANTS ====================
const GRID = 36;
const MAP_COLS = 80;
const MAP_ROWS = 50;
const MAP_W = MAP_COLS * GRID;
const MAP_H = MAP_ROWS * GRID;
const DIST_COLS = 4;
const DIST_ROWS = 3;
const DIST_W = MAP_COLS / DIST_COLS;
const DIST_H = Math.ceil(MAP_ROWS / DIST_ROWS);
const MONTH_MS = 5000;

// ==================== STATE ====================
function defaultState(){
  return {
    money: 10000, // 1å„„å†† in ä¸‡å†† units
    year: 1, month: 1,
    loanBalance: 0, loanRate: 0,
    creditScore: 600,
    maxMilestone: 0,
    population: 0,
    grid: {}, properties: {}, districts: {},
    eventLog: [],
    marketMod: 0, marketModMonths: 0,
    vacancyMod: 0, vacancyModMonths: 0,
    rateMod: 0, bankruptMonths: 0,
  };
}

let state = defaultState();
let cam = {x:0, y:0};
let selectedType = 'house';
let isDemolish = false;
let isRepairMode = false;
let animFrame = 0;
let VW, VH;
let lastMonthTime = Date.now();
let notifTO;
let dragging = false, dragStart = {x:0,y:0}, camStart = {x:0,y:0};
let gamePaused = false;

const bgC   = document.getElementById('cv-bg');
const cityC = document.getElementById('cv-city');
const uiC   = document.getElementById('cv-ui');
const mm    = document.getElementById('minimap');
const bgX   = bgC.getContext('2d');
const cityX = cityC.getContext('2d');
const uiX   = uiC.getContext('2d');
const mmX   = mm.getContext('2d');

// ==================== TOKYO TERRAIN ====================
const TERRAIN = {};
const TERRAIN_COLORS = {grass:'#3a6b3a', water:'#1a6fa0', sand:'#c2a46b', hill:'#6b7d6b'};
const TERRAIN_DARK = {grass:'#2e5430', water:'#154d72', sand:'#a8884a', hill:'#546059'};

function generateTerrain(){
  // Fill with grass
  for(let cy=0;cy<MAP_ROWS;cy++)
    for(let cx=0;cx<MAP_COLS;cx++)
      TERRAIN[`${cx},${cy}`]='grass';

  // === Tokyo Bay (æ±äº¬æ¹¾) â€” southeast curved coastline ===
  for(let cy=0;cy<MAP_ROWS;cy++){
    let bayX;
    if(cy<8) bayX=80;
    else if(cy<16) bayX=75-(cy-8)*1.0;
    else if(cy<24) bayX=67-(cy-16)*0.9;
    else if(cy<32) bayX=59.8-(cy-24)*0.6;
    else if(cy<40) bayX=55-(cy-32)*0.4;
    else bayX=51.8-(cy-40)*0.3;
    bayX+=Math.sin(cy*0.5)*1.2+Math.sin(cy*1.3)*0.6;
    for(let cx=Math.max(0,Math.floor(bayX));cx<MAP_COLS;cx++)
      TERRAIN[`${cx},${cy}`]='water';
  }

  // Reclaimed land: ãŠå°å ´ area
  for(let cy=33;cy<39;cy++)
    for(let cx=57;cx<63;cx++)
      if(Math.sqrt((cx-60)**2+(cy-36)**2)<3.2) TERRAIN[`${cx},${cy}`]='grass';
  // è±Šæ´² bump
  for(let cy=28;cy<33;cy++)
    for(let cx=56;cx<60;cx++)
      if(cy<31||cx<58) TERRAIN[`${cx},${cy}`]='grass';

  // === éš…ç”°å· (Sumida River) â€” north to south ===
  for(let cy=2;cy<45;cy++){
    const rx=50+Math.sin(cy*0.25)*1.8+Math.sin(cy*0.6)*0.5;
    const k=`${Math.round(rx)},${cy}`;
    if(TERRAIN[k]==='water') break; // reached bay
    TERRAIN[k]='water';
  }

  // === è’å· (Arakawa) â€” wider, parallel east of Sumida ===
  for(let cy=0;cy<42;cy++){
    const rx=54+cy*0.06+Math.sin(cy*0.2)*1.5;
    const r=Math.round(rx);
    if(r>=MAP_COLS) continue;
    const k=`${r},${cy}`;
    if(TERRAIN[k]==='water'&&cy>20) break;
    TERRAIN[k]='water';
    if(r+1<MAP_COLS) TERRAIN[`${r+1},${cy}`]='water'; // wider
  }

  // === å¤šæ‘©å· (Tama River) â€” southern border ===
  for(let cx=0;cx<48;cx++){
    const ry=47+Math.sin(cx*0.12)*0.8;
    const r=Math.round(ry);
    if(r<MAP_ROWS) TERRAIN[`${cx},${r}`]='water';
    if(r+1<MAP_ROWS) TERRAIN[`${cx},${r+1}`]='water';
  }

  // === çš‡å±… (Imperial Palace moat) ===
  for(let cy=20;cy<25;cy++)
    for(let cx=41;cx<46;cx++)
      if(Math.sqrt((cx-43.5)**2+(cy-22.5)**2)<2.2) TERRAIN[`${cx},${cy}`]='water';
  // Gardens
  for(let cy=19;cy<26;cy++)
    for(let cx=40;cx<47;cx++){
      const d=Math.sqrt((cx-43.5)**2+(cy-22.5)**2);
      if(d>=2.2&&d<3.5&&TERRAIN[`${cx},${cy}`]==='grass') TERRAIN[`${cx},${cy}`]='hill';
    }

  // === æ­¦è”µé‡å°åœ° (Musashino Plateau â€” western hills) ===
  for(let cy=0;cy<MAP_ROWS;cy++)
    for(let cx=0;cx<22;cx++){
      if(TERRAIN[`${cx},${cy}`]!=='grass') continue;
      const n=Math.sin(cx*0.4+cy*0.3)*Math.cos(cy*0.35+cx*0.2)+Math.sin(cx*0.7+cy*0.5)*0.4;
      if((cx<12&&n>0.3)||(cx<18&&n>0.6)||(cx<22&&n>0.8)) TERRAIN[`${cx},${cy}`]='hill';
    }

  // === Sand along all water edges ===
  const sandKeys=[];
  for(let cy=0;cy<MAP_ROWS;cy++)
    for(let cx=0;cx<MAP_COLS;cx++){
      if(TERRAIN[`${cx},${cy}`]!=='grass') continue;
      for(const[dx,dy] of [[-1,0],[1,0],[0,-1],[0,1]]){
        const nx=cx+dx,ny=cy+dy;
        if(nx>=0&&nx<MAP_COLS&&ny>=0&&ny<MAP_ROWS&&TERRAIN[`${nx},${ny}`]==='water'){
          sandKeys.push(`${cx},${cy}`); break;
        }
      }
    }
  sandKeys.forEach(k=>TERRAIN[k]='sand');
}

// ==================== DISTRICT SYSTEM ====================
function getDistrictKey(cx,cy){
  const dx=Math.min(Math.floor(cx/DIST_W), DIST_COLS-1);
  const dy=Math.min(Math.floor(cy/DIST_H), DIST_ROWS-1);
  return `${dx},${dy}`;
}
function getDistrictIdx(dk){
  const[dx,dy]=dk.split(',').map(Number);
  return dy*DIST_COLS+dx;
}
function getDistrictName(dk){ return DIST_DATA[getDistrictIdx(dk)]?.name||'ä¸æ˜'; }
function getDistrictInfo(dk){ return DIST_DATA[getDistrictIdx(dk)]; }

function initDistricts(){
  state.districts={};
  for(let dy=0;dy<DIST_ROWS;dy++)
    for(let dx=0;dx<DIST_COLS;dx++){
      const dd=DIST_DATA[dy*DIST_COLS+dx];
      state.districts[`${dx},${dy}`]={reputation:dd.baseRep};
    }
}

function getDistrictPriceMult(cx,cy){
  const dk=getDistrictKey(cx,cy);
  const dist=state.districts[dk];
  if(!dist) return 1;
  return 0.5+dist.reputation/100; // 0.5x to 1.5x
}

function updateDistricts(){
  for(let dy=0;dy<DIST_ROWS;dy++)
    for(let dx=0;dx<DIST_COLS;dx++){
      const dk=`${dx},${dy}`;
      const dist=state.districts[dk];
      const dd=DIST_DATA[dy*DIST_COLS+dx];
      if(!dist||!dd) continue;
      let infraCount=0, buildingCount=0, totalCond=0;
      for(let cy=dy*DIST_H;cy<Math.min((dy+1)*DIST_H,MAP_ROWS);cy++)
        for(let cx=dx*DIST_W;cx<Math.min((dx+1)*DIST_W,MAP_COLS);cx++){
          const prop=state.properties[`${cx},${cy}`];
          if(prop){
            buildingCount++; totalCond+=prop.condition;
            const b=BUILDINGS.find(x=>x.id===prop.type);
            if(b&&b.cat==='infra') infraCount+=(b.repBonus||1);
          }
        }
      let delta=dd.trend; // base historical trend
      if(infraCount>0) delta+=Math.min(infraCount*0.2,2);
      if(buildingCount>0){
        const avgCond=totalCond/buildingCount;
        if(avgCond<40) delta-=0.5;
        if(avgCond>70) delta+=0.3;
      }
      dist.reputation=Math.max(5,Math.min(98,dist.reputation+delta));
    }
}

// ==================== SIDEBAR ====================
function buildSidebar(){
  const sb=document.getElementById('sidebar');
  sb.innerHTML='';
  // Portfolio
  const ps=document.createElement('div'); ps.className='sb-sec';
  const propKeys=Object.keys(state.properties);
  const rentProps=propKeys.filter(k=>{const b=BUILDINGS.find(x=>x.id===state.properties[k].type);return b&&b.baseRent>0;});
  const avgVac=rentProps.length>0?rentProps.reduce((s,k)=>s+state.properties[k].vacancy,0)/rentProps.length:0;
  const avgCond=propKeys.length>0?propKeys.reduce((s,k)=>s+state.properties[k].condition,0)/propKeys.length:0;
  const monthlyInc=calcTotalMonthlyRent();
  ps.innerHTML=`<div class="sb-ttl">ğŸ“‹ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</div>
    <div class="port-grid">
      <div class="port-item"><span class="port-lbl">ç‰©ä»¶æ•°</span><span class="port-val">${propKeys.length}</span></div>
      <div class="port-item"><span class="port-lbl">ä¿¡ç”¨ã‚¹ã‚³ã‚¢</span><span class="port-val">${state.creditScore}</span></div>
      <div class="port-item"><span class="port-lbl">æœˆå</span><span class="port-val" style="color:var(--green)">${fmtMoney(monthlyInc)}</span></div>
      <div class="port-item"><span class="port-lbl">å¹³å‡çŠ¶æ…‹</span><span class="port-val">${avgCond.toFixed(0)}/100</span></div>
    </div>`;
  sb.appendChild(ps);

  CATS.forEach(cat=>{
    const sec=document.createElement('div'); sec.className='sb-sec';
    sec.innerHTML=`<div class="sb-ttl">${cat.label}</div>`;
    cat.ids.forEach(id=>{
      const b=BUILDINGS.find(x=>x.id===id); if(!b) return;
      const locked=b.tier>state.maxMilestone;
      const btn=document.createElement('button');
      btn.className='bld-btn'+(locked?' locked':'')+(selectedType===id&&!locked&&!isDemolish&&!isRepairMode?' active':'');
      btn.dataset.id=id;
      const riskStars=b.risk>0?`<span class="br">${'â˜…'.repeat(b.risk)}${'â˜†'.repeat(3-b.risk)}</span>`:'';
      let incTxt='';
      if(b.cat==='infra') incTxt=`<span class="bi">è©•ä¾¡+${b.repBonus||0}</span>`;
      else if(b.baseRent>0) incTxt=`<span class="bi">${fmtMoney(b.baseRent)}/æœˆ</span>`;
      btn.innerHTML=`<div class="bld-ico">${SVGS[id]||''}</div>
        <div class="bld-info"><div class="bld-name">${b.name}</div>
          <div class="bld-meta"><span class="bc">${fmtMoney(b.cost)}</span>${incTxt}${b.pop>0?`<span class="bp">ğŸ‘¥${b.pop}</span>`:''}${riskStars}</div>
        </div>${locked?`<div class="lk-badge">T${b.tier}ğŸ”’</div>`:''}`;
      if(!locked) btn.onclick=()=>selectBuilding(id);
      sec.appendChild(btn);
    });
    sb.appendChild(sec);
  });

  const ts=document.createElement('div'); ts.className='sb-sec';
  ts.innerHTML=`<div class="sb-ttl">ãƒ„ãƒ¼ãƒ«</div><div class="tool-btns">
    <button class="tbtn demo${isDemolish?' on':''}" id="demo-btn" onclick="toggleDemolish()">ğŸ—‘ å–ã‚Šå£Šã—ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="tbtn repair${isRepairMode?' on':''}" id="repair-btn" onclick="toggleRepair()">ğŸ”§ ä¿®ç†ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="tbtn rst" onclick="confirmReset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>`;
  sb.appendChild(ts);
}

function selectBuilding(id){
  selectedType=id; isDemolish=false; isRepairMode=false;
  document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.bld-btn[data-id="${id}"]`).forEach(b=>b.classList.add('active'));
  const db=document.getElementById('demo-btn'); if(db) db.classList.remove('on');
  const rb=document.getElementById('repair-btn'); if(rb) rb.classList.remove('on');
}
function toggleDemolish(){
  isDemolish=!isDemolish; isRepairMode=false;
  const db=document.getElementById('demo-btn'); if(db) db.classList.toggle('on',isDemolish);
  const rb=document.getElementById('repair-btn'); if(rb) rb.classList.remove('on');
  if(isDemolish) document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  notify(isDemolish?'ğŸ—‘ å–ã‚Šå£Šã—ãƒ¢ãƒ¼ãƒ‰':'âœï¸ å»ºè¨­ãƒ¢ãƒ¼ãƒ‰', isDemolish?'rd':'gd');
}
function toggleRepair(){
  isRepairMode=!isRepairMode; isDemolish=false;
  const rb=document.getElementById('repair-btn'); if(rb) rb.classList.toggle('on',isRepairMode);
  const db=document.getElementById('demo-btn'); if(db) db.classList.remove('on');
  if(isRepairMode) document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  notify(isRepairMode?'ğŸ”§ ä¿®ç†ãƒ¢ãƒ¼ãƒ‰':'âœï¸ å»ºè¨­ãƒ¢ãƒ¼ãƒ‰', isRepairMode?'pu':'gd');
}

// ==================== RESIZE ====================
function resize(){
  const wrap=document.getElementById('map-wrap');
  VW=wrap.offsetWidth; VH=wrap.offsetHeight;
  bgC.width=cityC.width=uiC.width=VW;
  bgC.height=cityC.height=uiC.height=VH;
  clampCam(); drawBg(); drawCity();
}
function clampCam(){
  cam.x=Math.max(0,Math.min(cam.x, MAP_W-VW));
  cam.y=Math.max(0,Math.min(cam.y, MAP_H-VH));
}

// ==================== BACKGROUND ====================
function drawBg(){
  bgX.clearRect(0,0,VW,VH);
  const skyH=Math.max(0,-cam.y);
  if(skyH>0){
    const sg=bgX.createLinearGradient(0,0,0,skyH);
    sg.addColorStop(0,'#0a0a1a'); sg.addColorStop(1,'#1a2a4a');
    bgX.fillStyle=sg; bgX.fillRect(0,0,VW,skyH);
  }
  const c0=Math.floor(cam.x/GRID), r0=Math.floor(cam.y/GRID);
  const c1=Math.min(MAP_COLS-1,c0+Math.ceil(VW/GRID)+1);
  const r1=Math.min(MAP_ROWS-1,r0+Math.ceil(VH/GRID)+1);
  for(let r=r0;r<=r1;r++)
    for(let c=c0;c<=c1;c++){
      const t=TERRAIN[`${c},${r}`]||'grass';
      const sx=c*GRID-cam.x, sy=r*GRID-cam.y;
      bgX.fillStyle=TERRAIN_COLORS[t]; bgX.fillRect(sx,sy,GRID,GRID);
      bgX.fillStyle=TERRAIN_DARK[t]; bgX.fillRect(sx,sy,1,GRID); bgX.fillRect(sx,sy,GRID,1);
      if(t==='water'){
        const wv=(animFrame/40+(c*0.3+r*0.5))%1;
        bgX.fillStyle=`rgba(100,180,255,${0.1+wv*0.15})`;
        bgX.fillRect(sx+3,sy+GRID/2-2,GRID-6,3);
      }
      bgX.strokeStyle='rgba(0,0,0,0.08)'; bgX.lineWidth=0.5; bgX.strokeRect(sx,sy,GRID,GRID);
    }
  // District boundaries
  bgX.strokeStyle='rgba(255,255,255,0.12)'; bgX.lineWidth=1; bgX.setLineDash([6,4]);
  for(let dx=1;dx<DIST_COLS;dx++){
    const sx=dx*DIST_W*GRID-cam.x;
    if(sx>0&&sx<VW){bgX.beginPath();bgX.moveTo(sx,0);bgX.lineTo(sx,VH);bgX.stroke();}
  }
  for(let dy=1;dy<DIST_ROWS;dy++){
    const sy=dy*DIST_H*GRID-cam.y;
    if(sy>0&&sy<VH){bgX.beginPath();bgX.moveTo(0,sy);bgX.lineTo(VW,sy);bgX.stroke();}
  }
  bgX.setLineDash([]);
}

// ==================== DRAW BUILDINGS ====================
function drawBuilding(ctx,id,gx,gy,cx,cy){
  const t=animFrame/60; ctx.save(); const G=GRID;
  switch(id){
    case 'cottage':{
      ctx.fillStyle='#5c4033';ctx.fillRect(gx+4,gy+G-14,G-8,14);ctx.fillStyle='#8d6e63';ctx.fillRect(gx+6,gy+G-20,G-12,10);ctx.fillStyle='#4e342e';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+G-26);ctx.lineTo(gx+4,gy+G-18);ctx.lineTo(gx+G-4,gy+G-18);ctx.closePath();ctx.fill();
      ctx.fillStyle=`rgba(255,220,120,${.5+Math.sin(t*2+cx)*.4})`;ctx.fillRect(gx+8,gy+G-19,6,5);break;}
    case 'house':{
      ctx.fillStyle='#bf8a60';ctx.fillRect(gx+3,gy+14,G-6,G-15);ctx.fillStyle='#795548';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+4);ctx.lineTo(gx+1,gy+16);ctx.lineTo(gx+G-1,gy+16);ctx.closePath();ctx.fill();
      ctx.fillStyle='#4e342e';ctx.fillRect(gx+G/2-4,gy+G-12,8,12);
      ctx.fillStyle=`rgba(135,206,235,${.7+Math.sin(t+cx*.5)*.2})`;ctx.fillRect(gx+5,gy+18,7,6);ctx.fillRect(gx+G-12,gy+18,7,6);break;}
    case 'road':{
      ctx.fillStyle='#1a1a1a';ctx.fillRect(gx,gy,G,G);ctx.fillStyle='#252525';ctx.fillRect(gx+1,gy+1,G-2,G-2);
      const cp=(animFrame*0.5+cx*7)%(G+10)-5;ctx.fillStyle='#ef5350';ctx.fillRect(gx+cp,gy+G/2-4,8,4);
      const cp2=(animFrame*0.3+cy*11+20)%(G+10)-5;ctx.fillStyle='#42a5f5';ctx.fillRect(gx+G/2-4,gy+G-cp2-4,4,6);
      ctx.strokeStyle='#F0B429';ctx.setLineDash([5,4]);ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(gx,gy+G/2);ctx.lineTo(gx+G,gy+G/2);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gx+G/2,gy);ctx.lineTo(gx+G/2,gy+G);ctx.stroke();ctx.setLineDash([]);break;}
    case 'park':{
      ctx.fillStyle='#2e7d32';ctx.fillRect(gx,gy,G,G);ctx.fillStyle='#9e8a6a';ctx.fillRect(gx+G/2-3,gy,6,G);ctx.fillRect(gx,gy+G/2-3,G,6);
      const pp=(animFrame*0.4+cx*5)%(G-8);ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(gx+4+pp,gy+G/2-1,2,0,Math.PI*2);ctx.fill();
      [[10,G-18,8],[G-10,G-18,8],[G/2,10,10]].forEach(([tx,ty,r])=>{
        ctx.fillStyle='#1b5e20';ctx.beginPath();ctx.arc(gx+tx,gy+ty,r+2,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#4caf50';ctx.beginPath();ctx.arc(gx+tx,gy+ty,r-2,0,Math.PI*2);ctx.fill();
      });break;}
    case 'mountain':{
      ctx.fillStyle='#546e7a';ctx.fillRect(gx,gy,G,G);ctx.fillStyle='#78909c';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+2,gy+G-2);ctx.lineTo(gx+G-2,gy+G-2);ctx.closePath();ctx.fill();
      ctx.fillStyle='#607d8b';ctx.beginPath();ctx.moveTo(gx+G*0.7,gy+8);ctx.lineTo(gx+G*0.4,gy+G-2);ctx.lineTo(gx+G-2,gy+G-2);ctx.closePath();ctx.fill();
      ctx.fillStyle='white';ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+G/2-6,gy+12);ctx.lineTo(gx+G/2+6,gy+12);ctx.closePath();ctx.fill();
      ctx.fillStyle=`rgba(255,255,255,${.5+Math.sin(t*.5+cx)*.3})`;ctx.beginPath();ctx.ellipse(gx+G/2+4,gy+6,5,3,0,0,Math.PI*2);ctx.fill();break;}
    case 'ocean':{
      ctx.fillStyle='#f5deb3';ctx.fillRect(gx,gy,G,G/3+4);
      const wg=ctx.createLinearGradient(0,gy+G/3,0,gy+G);wg.addColorStop(0,'#039be5');wg.addColorStop(1,'#01579b');
      ctx.fillStyle=wg;ctx.fillRect(gx,gy+G/3,G,G-G/3);
      const wt=(animFrame/30+cx*.5)%1;ctx.strokeStyle=`rgba(255,255,255,${.3+wt*.4})`;ctx.lineWidth=1.5;ctx.setLineDash([4,4]);
      ctx.beginPath();ctx.moveTo(gx,gy+G/2+wt*6);ctx.lineTo(gx+G,gy+G/2+wt*6);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gx,gy+G*0.7+(1-wt)*5);ctx.lineTo(gx+G,gy+G*0.7+(1-wt)*5);ctx.stroke();ctx.setLineDash([]);
      ctx.fillStyle=`rgba(255,220,80,${.1+Math.sin(t+cx)*.05})`;ctx.fillRect(gx+G/2-3,gy+G/3,6,G-G/3);
      ctx.fillStyle='#e53935';ctx.beginPath();ctx.ellipse(gx+8,gy+8,7,4,-.3,0,Math.PI);ctx.fill();
      ctx.strokeStyle='#795548';ctx.lineWidth=1;ctx.setLineDash([]);ctx.beginPath();ctx.moveTo(gx+8,gy+8);ctx.lineTo(gx+10,gy+18);ctx.stroke();break;}
    case 'apartment':{
      ctx.fillStyle='#546e7a';ctx.fillRect(gx+3,gy+2,G-6,G-3);ctx.fillStyle='#37474f';ctx.fillRect(gx+3,gy+2,G-6,4);
      for(let row=0;row<3;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t+cx*1.3+cy*.7+row*2+col*4)>0?'#ffe082':'#1a237e';
        ctx.fillRect(gx+6+col*14,gy+8+row*10,8,7);}
      ctx.fillStyle='#263238';ctx.fillRect(gx+G/2-4,gy+G-10,8,10);break;}
    case 'shop':{
      ctx.fillStyle='#e65100';ctx.fillRect(gx+2,gy+G-24,G-4,24);ctx.fillStyle='#f57c00';ctx.fillRect(gx+2,gy+G-27,G-4,4);
      ctx.fillStyle='#ffe082';ctx.fillRect(gx+5,gy+G-22,G-10,7);
      ctx.fillStyle=`rgba(200,230,255,${.6+Math.sin(t*1.5)*.2})`;ctx.fillRect(gx+5,gy+G-14,G-10,8);break;}
    case 'clinic':{
      ctx.fillStyle='#f5f5f5';ctx.fillRect(gx+3,gy+8,G-6,G-9);ctx.fillStyle='#c62828';ctx.fillRect(gx+3,gy+8,G-6,7);
      ctx.fillStyle='white';ctx.fillRect(gx+G/2-1.5,gy+9,3,5);ctx.fillRect(gx+G/2-4,gy+10.5,8,2);
      ctx.fillStyle='#90caf9';ctx.fillRect(gx+5,gy+18,7,6);ctx.fillRect(gx+G-12,gy+18,7,6);break;}
    case 'school':{
      ctx.fillStyle='#fff8e1';ctx.fillRect(gx+2,gy+12,G-4,G-13);ctx.fillStyle='#f9a825';ctx.fillRect(gx+2,gy+8,G-4,6);
      ctx.fillStyle='#e65100';ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+2,gy+10);ctx.lineTo(gx+G-2,gy+10);ctx.closePath();ctx.fill();
      ctx.fillStyle='#90caf9';ctx.fillRect(gx+5,gy+16,8,7);ctx.fillRect(gx+G-13,gy+16,8,7);break;}
    case 'condo':{
      ctx.fillStyle='#263238';ctx.fillRect(gx+G/2-8,gy+1,16,G-2);ctx.fillStyle='#37474f';ctx.fillRect(gx+2,gy+G-20,G-4,20);
      for(let row=0;row<5;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.8+cx*2+cy+row*1.7+col*3.2)>-.1?'#ffd54f':'#0d47a1';
        ctx.fillRect(gx+G/2-7+col*8,gy+3+row*8,5,5);}
      for(let col=0;col<3;col++){ctx.fillStyle=Math.sin(t+col*2)>0?'#ffcc02':'#1565c0';ctx.fillRect(gx+4+col*12,gy+G-16,8,8);}
      ctx.fillStyle='#00bcd4';ctx.fillRect(gx+G/2-8,gy,16,2);break;}
    case 'office':{
      ctx.fillStyle='#0d47a1';ctx.fillRect(gx+4,gy+1,G-8,G-2);
      for(let row=0;row<6;row++){ctx.fillStyle=`rgba(144,202,249,${.3+Math.sin(t*.3+row*.5)*.15})`;ctx.fillRect(gx+6,gy+3+row*6,G-12,4);}
      ctx.strokeStyle='#42a5f5';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(gx+G/2,gy-5);ctx.lineTo(gx+G/2,gy+2);ctx.stroke();
      ctx.fillStyle='#42a5f5';ctx.beginPath();ctx.arc(gx+G/2,gy-5,2,0,Math.PI*2);ctx.fill();break;}
    case 'hotel':{
      ctx.fillStyle='#4a148c';ctx.fillRect(gx+3,gy+4,G-6,G-5);ctx.fillStyle='#38006b';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy);ctx.lineTo(gx+3,gy+6);ctx.lineTo(gx+G-3,gy+6);ctx.closePath();ctx.fill();
      for(let row=0;row<4;row++) for(let col=0;col<3;col++){
        ctx.fillStyle=Math.sin(t+row*1.3+col*2.1+cx)>0?'#ffe082':'#1a0033';ctx.fillRect(gx+5+col*11,gy+10+row*8,7,5);}break;}
    case 'stadium':{
      ctx.fillStyle='#1c1c1c';ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-2,G/3,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#2e7d32';ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-7,G/3-4,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#33691e';ctx.lineWidth=1;ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-12,G/3-8,0,0,Math.PI*2);ctx.stroke();
      [[4,4],[G-4,4],[4,G-4],[G-4,G-4]].forEach(([lx,ly])=>{
        ctx.fillStyle=Math.sin(t*2+lx*.1)>.5?'#fff176':'#f57f17';ctx.beginPath();ctx.arc(gx+lx,gy+ly,2,0,Math.PI*2);ctx.fill();});break;}
    case 'skyscraper':{
      ctx.fillStyle='#1a237e';ctx.fillRect(gx+1,gy+G-18,G-2,18);ctx.fillStyle='#0d1b4a';ctx.fillRect(gx+6,gy+2,G-12,G-18);
      ctx.fillStyle='#1565c0';ctx.fillRect(gx+G/2-4,gy-4,8,G/3);
      for(let row=0;row<7;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.6+cx*1.5+cy+row*1.2+col*2.8)>0?'#bbdefb':'#0a1433';ctx.fillRect(gx+8+col*10,gy+4+row*5,7,3);}
      ctx.fillStyle=Math.sin(t*4)>0?'#ef5350':'#b71c1c';ctx.beginPath();ctx.arc(gx+G/2,gy-4,2.5,0,Math.PI*2);ctx.fill();break;}
    case 'mall':{
      ctx.fillStyle='#37474f';ctx.fillRect(gx,gy+G-22,G,22);ctx.fillStyle='#546e7a';ctx.fillRect(gx+8,gy+G-36,G-16,14);
      ctx.fillStyle=`rgba(144,202,249,${.3+Math.sin(t*.3)*.15})`;ctx.fillRect(gx+10,gy+G-34,G-20,10);
      ['#ef9a9a','#a5d6a7','#90caf9','#fff59d'].forEach((c,i)=>{if(i*10<G-4){ctx.fillStyle=c;ctx.fillRect(gx+2+i*10,gy+G-18,8,10);}});break;}
    case 'luxury':{
      ctx.fillStyle='#0a0a0a';ctx.fillRect(gx+G/2-8,gy,16,G);ctx.fillStyle='#111';ctx.fillRect(gx+1,gy+G-20,G-2,20);
      ctx.strokeStyle='#d4af37';ctx.lineWidth=.5;ctx.strokeRect(gx+G/2-8,gy,16,G);ctx.strokeRect(gx+1,gy+G-20,G-2,20);
      for(let row=0;row<6;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.5+cx*2+row*1.5+col*3)>0?'#d4af37':'#1a1500';ctx.fillRect(gx+G/2-7+col*8,gy+2+row*7,5,4);}
      ctx.fillStyle='#d4af37';ctx.fillRect(gx+G/2-1,gy-6,2,6);
      ctx.beginPath();ctx.moveTo(gx+G/2,gy-10);ctx.lineTo(gx+G/2-3,gy-6);ctx.lineTo(gx+G/2+3,gy-6);ctx.closePath();ctx.fill();break;}
    case 'airport':{
      ctx.fillStyle='#212121';ctx.fillRect(gx,gy+G-16,G,16);ctx.fillStyle='#37474f';ctx.fillRect(gx+4,gy+G-30,G-8,16);
      ctx.fillStyle='#455a64';ctx.beginPath();ctx.moveTo(gx+4,gy+G-30);ctx.quadraticCurveTo(gx+G/2,gy+G-38,gx+G-4,gy+G-30);
      ctx.lineTo(gx+G-4,gy+G-28);ctx.quadraticCurveTo(gx+G/2,gy+G-36,gx+4,gy+G-28);ctx.closePath();ctx.fill();
      for(let i=0;i<5;i++){ctx.fillStyle=`rgba(144,202,249,${.5+Math.sin(t+i)*.3})`;ctx.fillRect(gx+5+i*8,gy+G-27,5,8);}
      const px=(animFrame*1.2+cx*13)%(G+20)-10;ctx.fillStyle='#eceff1';ctx.fillRect(gx+px,gy+4,10,4);
      ctx.fillStyle='#b0bec5';ctx.beginPath();ctx.moveTo(gx+px+4,gy+4);ctx.lineTo(gx+px+2,gy+1);ctx.lineTo(gx+px+8,gy+4);ctx.closePath();ctx.fill();break;}
  }
  ctx.restore();
}

function drawCity(){
  cityX.clearRect(0,0,VW,VH);
  const c0=Math.floor(cam.x/GRID)-1,r0=Math.floor(cam.y/GRID)-1;
  const c1=Math.min(MAP_COLS-1,c0+Math.ceil(VW/GRID)+2);
  const r1=Math.min(MAP_ROWS-1,r0+Math.ceil(VH/GRID)+2);
  for(let r=r0;r<=r1;r++)
    for(let c=c0;c<=c1;c++){
      const key=`${c},${r}`;
      if(state.grid[key]){
        const sx=c*GRID-cam.x,sy=r*GRID-cam.y;
        drawBuilding(cityX,state.grid[key],sx,sy,c,r);
        const prop=state.properties[key];
        if(prop){
          const cond=prop.condition;
          const color=cond>=70?'#3fb950':cond>=40?'#f0b429':cond>=20?'#f85149':'#666';
          cityX.fillStyle=color;cityX.beginPath();cityX.arc(sx+GRID-5,sy+5,3,0,Math.PI*2);cityX.fill();
          cityX.strokeStyle='rgba(0,0,0,0.5)';cityX.lineWidth=0.5;cityX.beginPath();cityX.arc(sx+GRID-5,sy+5,3,0,Math.PI*2);cityX.stroke();
        }
      }
    }
}

// ==================== MINIMAP ====================
function drawMinimap(){
  const mw=160,mh=100,sx=mw/MAP_COLS,sy=mh/MAP_ROWS;
  mmX.clearRect(0,0,mw,mh);
  for(let r=0;r<MAP_ROWS;r++)
    for(let c=0;c<MAP_COLS;c++){
      const t=TERRAIN[`${c},${r}`]||'grass';
      mmX.fillStyle={grass:'#2e6b2e',water:'#1a5f8a',sand:'#b8975a',hill:'#4a5c4a'}[t];
      mmX.fillRect(c*sx,r*sy,sx+.5,sy+.5);
    }
  const dsx=DIST_W*sx,dsy=DIST_H*sy;
  for(let dy=0;dy<DIST_ROWS;dy++)
    for(let dx=0;dx<DIST_COLS;dx++){
      const dist=state.districts[`${dx},${dy}`];
      if(!dist) continue;
      const rep=dist.reputation;
      if(rep>55) mmX.fillStyle=`rgba(63,185,80,${(rep-55)/100*0.3})`;
      else if(rep<45) mmX.fillStyle=`rgba(248,81,73,${(45-rep)/100*0.3})`;
      else continue;
      mmX.fillRect(dx*dsx,dy*dsy,dsx,dsy);
    }
  for(const key in state.grid){
    const[c,r]=key.split(',').map(Number);
    mmX.fillStyle='#f0b429';mmX.fillRect(c*sx,r*sy,sx+.5,sy+.5);
  }
  mmX.strokeStyle='rgba(255,255,255,0.6)';mmX.lineWidth=1;
  mmX.strokeRect(cam.x/MAP_W*mw,cam.y/MAP_H*mh,VW/MAP_W*mw,VH/MAP_H*mh);
}

// ==================== MOUSE / INPUT ====================
function getMapCell(ex,ey){ return[Math.floor((ex+cam.x)/GRID),Math.floor((ey+cam.y)/GRID)]; }
const wrap=document.getElementById('map-wrap');

wrap.addEventListener('mousedown',e=>{
  dragging=false;dragStart={x:e.clientX,y:e.clientY};camStart={x:cam.x,y:cam.y};wrap.style.cursor='grabbing';
});
wrap.addEventListener('mousemove',e=>{
  const dx=e.clientX-dragStart.x,dy=e.clientY-dragStart.y;
  if(Math.abs(dx)>3||Math.abs(dy)>3) dragging=true;
  if(dragging&&e.buttons===1){cam.x=camStart.x-dx;cam.y=camStart.y-dy;clampCam();}
  const rect=wrap.getBoundingClientRect();
  const[cx,cy]=getMapCell(e.clientX-rect.left,e.clientY-rect.top);
  const key=`${cx},${cy}`;
  const tt=document.getElementById('tooltip');
  if(state.grid[key]&&!dragging){
    const prop=state.properties[key];
    const b=BUILDINGS.find(x=>x.id===state.grid[key]);
    if(!b||!prop){tt.style.display='none';return;}
    document.getElementById('tt-name').textContent=b.name;
    document.getElementById('tt-val').innerHTML=`<span>${fmtMoney(prop.value)}</span>`;
    const changePct=((prop.value-prop.purchasePrice)/prop.purchasePrice*100).toFixed(1);
    document.getElementById('tt-cost').textContent=fmtMoney(prop.purchasePrice);
    document.getElementById('tt-change').innerHTML=`<span class="${changePct>=0?'up':'dn'}">${changePct>=0?'+':''}${changePct}%</span>`;
    if(b.baseRent>0){
      document.getElementById('tt-rent').textContent=fmtMoney(Math.floor(calcPropertyRent(key)))+'/æœˆ';
      document.getElementById('tt-rent-row').style.display='';
      document.getElementById('tt-vac').textContent=`${prop.vacancy.toFixed(1)}%`;
      document.getElementById('tt-vac-row').style.display='';
    } else { document.getElementById('tt-rent-row').style.display='none'; document.getElementById('tt-vac-row').style.display='none'; }
    document.getElementById('tt-cond').textContent=`${Math.floor(prop.condition)}/100`;
    const dk=getDistrictKey(cx,cy);
    const di=getDistrictInfo(dk);
    document.getElementById('tt-dist').textContent=`${getDistrictName(dk)} (${Math.floor(state.districts[dk]?.reputation||50)}) ${di?.desc||''}`;
    tt.style.left=Math.min(e.clientX-rect.left+12,VW-250)+'px';
    tt.style.top=Math.max(e.clientY-rect.top-130,4)+'px';
    tt.style.display='block';
  } else tt.style.display='none';
});
wrap.addEventListener('mouseup',e=>{
  wrap.style.cursor='crosshair';if(dragging){dragging=false;return;}
  const rect=wrap.getBoundingClientRect();
  const[cx,cy]=getMapCell(e.clientX-rect.left,e.clientY-rect.top);
  if(cx<0||cy<0||cx>=MAP_COLS||cy>=MAP_ROWS)return;
  handleClick(`${cx},${cy}`,cx,cy,e.clientX-rect.left,e.clientY-rect.top);
});
wrap.addEventListener('mouseleave',()=>{document.getElementById('tooltip').style.display='none';dragging=false;wrap.style.cursor='crosshair';});

let touch0={x:0,y:0};
wrap.addEventListener('touchstart',e=>{touch0={x:e.touches[0].clientX,y:e.touches[0].clientY};camStart={x:cam.x,y:cam.y};dragging=false;},{passive:true});
wrap.addEventListener('touchmove',e=>{
  const dx=e.touches[0].clientX-touch0.x,dy=e.touches[0].clientY-touch0.y;
  if(Math.abs(dx)>5||Math.abs(dy)>5)dragging=true;
  if(dragging){cam.x=camStart.x-dx;cam.y=camStart.y-dy;clampCam();}
},{passive:true});
wrap.addEventListener('touchend',e=>{
  if(dragging){dragging=false;return;}
  const rect=wrap.getBoundingClientRect();
  const tx=e.changedTouches[0].clientX-rect.left,ty=e.changedTouches[0].clientY-rect.top;
  const[cx,cy]=getMapCell(tx,ty);
  if(cx>=0&&cy>=0&&cx<MAP_COLS&&cy<MAP_ROWS) handleClick(`${cx},${cy}`,cx,cy,tx,ty);
});
mm.addEventListener('click',e=>{
  const rect=mm.getBoundingClientRect();
  cam.x=(e.clientX-rect.left)/160*MAP_W-VW/2;cam.y=(e.clientY-rect.top)/100*MAP_H-VH/2;clampCam();
});

// ==================== CLICK HANDLING ====================
function handleClick(key,cx,cy,screenX,screenY){
  if(isDemolish){
    if(state.grid[key]){
      const prop=state.properties[key];
      const refund=Math.floor((prop?prop.value:0)*0.4);
      const b=BUILDINGS.find(x=>x.id===state.grid[key]);
      state.money+=refund; state.population-=(b?b.pop:0);
      delete state.grid[key]; delete state.properties[key];
      updateUI();buildSidebar();
      notify(`ğŸ—‘ å–ã‚Šå£Šã— (+${fmtMoney(refund)} è¿”é‚„)`,'rd');
    } return;
  }
  if(isRepairMode){
    if(state.grid[key]&&state.properties[key]){
      const prop=state.properties[key];
      if(prop.condition>=99){notify('âœ… ä¿®ç†ä¸è¦','gd');return;}
      const b=BUILDINGS.find(x=>x.id===prop.type);
      const cost=Math.floor(b.cost*(100-prop.condition)/100*0.3);
      if(state.money<cost){notify(`ğŸ’¸ ä¿®ç†è²» ${fmtMoney(cost)} ä¸è¶³`,'rd');return;}
      state.money-=cost; prop.condition=100;
      updateUI();buildSidebar();
      notify(`ğŸ”§ ä¿®ç†å®Œäº† (-${fmtMoney(cost)})`,'gr');
      spawnFloat(screenX,screenY,`-${fmtMoney(cost)}`,true);
    } return;
  }
  // Build
  if(state.grid[key]){notify('âš  ã™ã§ã«å»ºç‰©ãŒã‚ã‚Šã¾ã™','rd');return;}
  const b=BUILDINGS.find(x=>x.id===selectedType);
  if(!b) return;
  if(b.tier>state.maxMilestone){notify('ğŸ”’ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æœªé”ã§æœªè§£æ”¾','rd');return;}
  const terrain=TERRAIN[key]||'grass';
  if(terrain==='water'&&selectedType!=='ocean'){notify('ğŸŒŠ æ°´åŸŸã«ã¯å»ºã¦ã‚‰ã‚Œã¾ã›ã‚“','rd');return;}

  // District price adjustment
  const distMult=getDistrictPriceMult(cx,cy);
  const adjustedCost=Math.floor(b.cost*distMult);

  // === Require 20% minimum down payment ===
  const minDown=Math.floor(adjustedCost*0.2);
  if(state.money<minDown){
    notify(`ğŸ’¸ é ­é‡‘ ${fmtMoney(minDown)} ãŒå¿…è¦`,'rd');
    return;
  }

  // Auto-borrow if needed (up to 80% of cost)
  if(state.money<adjustedCost){
    const needed=adjustedCost-state.money;
    const maxBorrow=calcMaxLoan()-state.loanBalance;
    if(needed<=maxBorrow){
      borrowMoney(needed);
      notify(`ğŸ’³ ${fmtMoney(Math.floor(needed))} è‡ªå‹•å€Ÿå…¥`,'gd');
    } else {
      notify(`ğŸ’¸ å€Ÿå…¥æ ä¸è¶³ (æ®‹ã‚Š${fmtMoney(Math.max(0,Math.floor(maxBorrow)))})`,'rd');
      return;
    }
  }

  state.money-=adjustedCost;
  state.population+=(b.pop||0);
  state.grid[key]=selectedType;
  state.properties[key]={
    type:selectedType, purchasePrice:adjustedCost, value:adjustedCost,
    vacancy:b.baseRent>0?30:0, condition:100, monthsOwned:0,
  };
  updateUI();buildSidebar();
  notify(`âœ… ${b.name} å»ºè¨­ (-${fmtMoney(adjustedCost)})`,'gr');
  spawnFloat(screenX,screenY,`-${fmtMoney(adjustedCost)}`,true);
}

// ==================== NET WORTH & MILESTONES ====================
function calcTotalAssets(){
  let t=0; for(const p of Object.values(state.properties)) t+=p.value; return t;
}
function calcNetWorth(){ return state.money+calcTotalAssets()-state.loanBalance; }
function calcTotalMonthlyRent(){
  let t=0; for(const k of Object.keys(state.properties)) t+=calcPropertyRent(k); return t;
}
function getMilestoneIndex(){
  const nw=calcNetWorth();
  for(let i=MILESTONES.length-1;i>=0;i--) if(nw>=MILESTONES[i].threshold) return i;
  return -1;
}
function checkMilestones(){
  const idx=getMilestoneIndex();
  if(idx>state.maxMilestone){state.maxMilestone=idx;showMilestoneModal(idx);buildSidebar();}
}
function showMilestoneModal(idx){
  gamePaused=true;
  document.getElementById('m-stars').textContent='â­'.repeat(idx+1);
  document.getElementById('m-title').textContent='MILESTONE!';
  document.getElementById('m-desc').textContent=`ã€Œ${MILESTONES[idx].title}ã€ã«æ˜‡æ ¼ï¼\næ–°ã—ã„å»ºç‰©ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚\nç´”è³‡ç”£: ${fmtMoney(Math.floor(calcNetWorth()))}`;
  document.getElementById('m-btn').textContent='OK â†’';
  document.getElementById('m-btn').onclick=closeModal;
  document.getElementById('modal').classList.add('show');
}
function closeModal(){document.getElementById('modal').classList.remove('show');gamePaused=false;}

// ==================== LOAN SYSTEM (with LTV/DTI caps) ====================
function calcLoanRate(){
  const risk=(850-state.creditScore)/850*7;
  return Math.max(0.5,(3+risk+state.rateMod))/100;
}
function calcMaxLoan(){
  const assets=calcTotalAssets();
  // Starter capacity based on credit (allows first purchase)
  const starterCap=(state.creditScore/850)*5000; // up to 5,000ä¸‡å††
  // LTV cap: total loans â‰¤ 70% of total property value
  const ltvCap=assets*0.7;
  const maxTotalDebt=Math.max(starterCap,ltvCap);
  return Math.max(0,maxTotalDebt-state.loanBalance);
}
function borrowMoney(amount){
  const newRate=calcLoanRate();
  if(state.loanBalance>0) state.loanRate=(state.loanBalance*state.loanRate+amount*newRate)/(state.loanBalance+amount);
  else state.loanRate=newRate;
  state.loanBalance+=amount; state.money+=amount;
}
function repayLoan(amount){
  const actual=Math.min(amount,state.loanBalance,state.money);
  if(actual<=0) return;
  state.money-=actual; state.loanBalance-=actual;
  if(state.loanBalance<=0){state.loanBalance=0;state.loanRate=0;}
}
function openLoanDialog(){gamePaused=true;updateLoanDialog();document.getElementById('loan-modal').classList.add('show');}
function closeLoanDialog(){document.getElementById('loan-modal').classList.remove('show');gamePaused=false;updateUI();buildSidebar();}
function updateLoanDialog(){
  const maxNew=Math.floor(calcMaxLoan());
  const rate=calcLoanRate();
  const mp=state.loanBalance>0?state.loanBalance*(state.loanRate/12+0.005):0;
  document.getElementById('loan-body').innerHTML=`
    <div class="loan-grid">
      <div><span class="loan-lbl">ä¿¡ç”¨ã‚¹ã‚³ã‚¢</span><div class="loan-val gold">${state.creditScore}</div></div>
      <div><span class="loan-lbl">å€Ÿå…¥æ®‹é«˜</span><div class="loan-val red">${fmtMoney(Math.floor(state.loanBalance))}</div></div>
      <div><span class="loan-lbl">é‡‘åˆ© (å¹´)</span><div class="loan-val">${(rate*100).toFixed(2)}%</div></div>
      <div><span class="loan-lbl">æœˆã€…ã®è¿”æ¸ˆ</span><div class="loan-val red">${fmtMoney(Math.floor(mp))}</div></div>
      <div><span class="loan-lbl">è¿½åŠ å€Ÿå…¥å¯èƒ½é¡</span><div class="loan-val green">${fmtMoney(maxNew)}</div></div>
      <div><span class="loan-lbl">ç¾é‡‘</span><div class="loan-val gold">${fmtMoney(Math.floor(state.money))}</div></div>
    </div><hr class="loan-sep">
    <div class="loan-row"><label>å€Ÿå…¥é¡:</label><input type="number" id="borrow-amt" min="0" max="${maxNew}" value="${Math.min(maxNew,5000)}" step="100"></div>
    <button class="modal-btn" style="width:100%;margin-bottom:12px" onclick="doBorrow()">ğŸ’° å€Ÿå…¥ã™ã‚‹</button>
    ${state.loanBalance>0?`<hr class="loan-sep">
    <div class="loan-row"><label>è¿”æ¸ˆé¡:</label><input type="number" id="repay-amt" min="0" max="${Math.floor(Math.min(state.loanBalance,state.money))}" value="${Math.floor(Math.min(state.loanBalance,state.money))}" step="100"></div>
    <button class="modal-btn secondary" style="width:100%" onclick="doRepay()">ğŸ’³ è¿”æ¸ˆã™ã‚‹</button>`:''}`;
}
function doBorrow(){
  const amt=Math.floor(Number(document.getElementById('borrow-amt').value));
  const maxNew=Math.floor(calcMaxLoan());
  if(amt<=0||amt>maxNew){notify('âš  ç„¡åŠ¹ãªå€Ÿå…¥é¡','rd');return;}
  borrowMoney(amt);notify(`ğŸ’° ${fmtMoney(amt)} å€Ÿå…¥å®Œäº†`,'gr');updateLoanDialog();
}
function doRepay(){
  const amt=Math.floor(Number(document.getElementById('repay-amt').value));
  if(amt<=0){notify('âš  ç„¡åŠ¹ãªè¿”æ¸ˆé¡','rd');return;}
  repayLoan(amt);notify(`ğŸ’³ ${fmtMoney(amt)} è¿”æ¸ˆå®Œäº†`,'gr');updateLoanDialog();
}

// ==================== RENT & VACANCY ====================
function calcPropertyRent(key){
  const prop=state.properties[key]; if(!prop) return 0;
  const b=BUILDINGS.find(x=>x.id===prop.type); if(!b||b.baseRent<=0) return 0;
  const[cx,cy]=key.split(',').map(Number);
  const dk=getDistrictKey(cx,cy);
  const distRep=(state.districts[dk]?state.districts[dk].reputation:50)/50;
  const condMult=prop.condition>=20?Math.max(0.3,prop.condition/100):0;
  const popMult=1+state.population/5000;
  return b.baseRent*(1-prop.vacancy/100)*distRep*condMult*popMult;
}
function updateVacancy(){
  for(const[key,prop] of Object.entries(state.properties)){
    const b=BUILDINGS.find(x=>x.id===prop.type); if(!b||b.baseRent<=0) continue;
    const[cx,cy]=key.split(',').map(Number);
    const dk=getDistrictKey(cx,cy);
    const distRep=state.districts[dk]?state.districts[dk].reputation:50;
    let delta=-2;
    delta+=(distRep-50)/100*5;
    if(prop.condition<50) delta+=(50-prop.condition)/50*5;
    delta+=(Math.random()-0.5)*6;
    if(state.vacancyModMonths>0) delta+=state.vacancyMod;
    prop.vacancy=Math.max(0,Math.min(100,prop.vacancy+delta));
  }
}

// ==================== PROPERTY VALUES ====================
function calcAdjacencyBonus(cx,cy){
  let bonus=0;
  for(let dx=-1;dx<=1;dx++) for(let dy=-1;dy<=1;dy++){
    if(dx===0&&dy===0) continue;
    const np=state.properties[`${cx+dx},${cy+dy}`];
    if(np){const nb=BUILDINGS.find(x=>x.id===np.type);bonus+=(nb&&nb.cat==='infra')?0.003:0.001;}
  }
  return bonus;
}
function updatePropertyValues(){
  for(const[key,prop] of Object.entries(state.properties)){
    const[cx,cy]=key.split(',').map(Number);
    const dk=getDistrictKey(cx,cy);
    const distRep=state.districts[dk]?state.districts[dk].reputation:50;
    const distGrowth=(distRep-50)/5000; // -1% to +1% from district
    const adjBonus=calcAdjacencyBonus(cx,cy);
    const noise=(Math.random()-0.5)*0.02; // Â±1%
    let mktEv=0; if(state.marketModMonths>0) mktEv=state.marketMod;
    prop.value=Math.max(prop.purchasePrice*0.2, prop.value*(1+distGrowth+adjBonus+noise+mktEv));
  }
}

// ==================== BUILDING CONDITION ====================
function degradeBuildings(){
  for(const prop of Object.values(state.properties)){
    const b=BUILDINGS.find(x=>x.id===prop.type);
    prop.condition=Math.max(0,prop.condition-(b&&b.cat==='infra'?0.5:1));
  }
}

// ==================== EVENTS ====================
function rollForEvent(){
  if(Math.random()>0.30) return;
  const tw=EVENT_TYPES.reduce((s,e)=>s+e.weight,0);
  let roll=Math.random()*tw;
  for(const ev of EVENT_TYPES){roll-=ev.weight;if(roll<=0){executeEvent(ev);return;}}
}
function executeEvent(ev){
  let detail='';
  switch(ev.id){
    case 'boom': state.marketMod=0.02;state.marketModMonths=3;detail='å…¨ç‰©ä»¶ã®ä¾¡å€¤ä¸Šæ˜‡ä¸­ (3ãƒ¶æœˆ)';break;
    case 'crash': state.marketMod=-0.03;state.marketModMonths=6;detail='å…¨ç‰©ä»¶ã®ä¾¡å€¤ä¸‹è½ä¸­ (6ãƒ¶æœˆ)';break;
    case 'quake':{
      const dks=Object.keys(state.districts);const dk=dks[Math.floor(Math.random()*dks.length)];
      const[ddx,ddy]=dk.split(',').map(Number); let dmg=0;
      for(let cy=ddy*DIST_H;cy<Math.min((ddy+1)*DIST_H,MAP_ROWS);cy++)
        for(let cx=ddx*DIST_W;cx<Math.min((ddx+1)*DIST_W,MAP_COLS);cx++){
          const p=state.properties[`${cx},${cy}`];if(p){p.condition=Math.max(0,p.condition-(20+Math.random()*30));dmg++;}}
      detail=`${getDistrictName(dk)}: ${dmg}æ£Ÿã«è¢«å®³`;break;}
    case 'fire':{
      const keys=Object.keys(state.properties);if(!keys.length){detail='è¢«å®³ãªã—';break;}
      const k=keys[Math.floor(Math.random()*keys.length)];const p=state.properties[k];
      const b=BUILDINGS.find(x=>x.id===p.type);p.condition=Math.max(0,p.condition-60-Math.random()*30);
      detail=`${b?b.name:'å»ºç‰©'}ãŒè¢«å®³`;break;}
    case 'exodus':{
      const dks=Object.keys(state.districts);const dk=dks[Math.floor(Math.random()*dks.length)];
      state.districts[dk].reputation=Math.max(5,state.districts[dk].reputation-30);
      detail=`${getDistrictName(dk)}ã®è©•åˆ¤ãŒå¤§å¹…ä½ä¸‹`;break;}
    case 'redev':{
      const dks=Object.keys(state.districts);const dk=dks[Math.floor(Math.random()*dks.length)];
      state.districts[dk].reputation=Math.min(98,state.districts[dk].reputation+20);
      detail=`${getDistrictName(dk)}ãŒå†é–‹ç™ºã§æ´»æ€§åŒ–`;break;}
    case 'rate':{
      const c=Math.random()>0.5?1:-1;state.rateMod=Math.max(-2,Math.min(3,state.rateMod+c));
      if(state.loanBalance>0) state.loanRate=calcLoanRate();
      detail=`é‡‘åˆ©ãŒ${c>0?'ä¸Šæ˜‡':'ä½ä¸‹'}`;break;}
    case 'vacancy':{
      const cats=['residential','commercial'];const tc=cats[Math.floor(Math.random()*cats.length)];let n=0;
      for(const p of Object.values(state.properties)){
        const b=BUILDINGS.find(x=>x.id===p.type);if(b&&b.cat===tc&&b.baseRent>0){p.vacancy=Math.min(100,p.vacancy+40);n++;}}
      detail=`${tc==='residential'?'ä½å±…':'å•†æ¥­'}ç‰©ä»¶ã®ç©ºå®¤æ€¥å¢— (${n}æ£Ÿ)`;break;}
  }
  addEventLog(`${ev.icon} ${ev.name}: ${detail}`,ev.type);
  notify(`${ev.icon} ${ev.name}`,ev.type==='good'?'gr':ev.type==='bad'?'rd':'gd');
}
function addEventLog(text,type){
  state.eventLog.unshift({text,type,year:state.year,month:state.month});
  if(state.eventLog.length>20) state.eventLog.pop();
  renderEventLog();
}
function renderEventLog(){
  document.getElementById('event-log').innerHTML=state.eventLog.slice(0,5).map(e=>
    `<div class="ev-item ${e.type}"><span class="ev-date">${e.year}Y${e.month}M</span>${e.text}</div>`
  ).join('');
}

// ==================== MONTHLY TICK ====================
function monthlyTick(){
  state.month++; if(state.month>12){state.month=1;state.year++;}
  for(const p of Object.values(state.properties)) p.monthsOwned++;
  updateDistricts();
  updatePropertyValues();
  updateVacancy();
  let totalRent=0;
  for(const k of Object.keys(state.properties)){const r=calcPropertyRent(k);if(r>0) totalRent+=r;}
  state.money+=totalRent;
  // Loan payments
  if(state.loanBalance>0){
    const interest=state.loanBalance*state.loanRate/12;
    const principal=state.loanBalance*0.005;
    const payment=interest+principal;
    if(state.money>=payment){
      state.money-=payment;state.loanBalance=Math.max(0,state.loanBalance-principal);
      if(state.loanBalance<=0) state.loanRate=0;
      state.creditScore=Math.min(850,state.creditScore+2);
    } else {
      state.loanBalance+=interest;state.creditScore=Math.max(300,state.creditScore-20);
      addEventLog('âš ï¸ è¿”æ¸ˆä¸èƒ½: åˆ©æ¯åŠ ç®—','bad');
    }
  }
  degradeBuildings();
  if(state.marketModMonths>0){state.marketModMonths--;if(state.marketModMonths<=0)state.marketMod=0;}
  if(state.vacancyModMonths>0){state.vacancyModMonths--;if(state.vacancyModMonths<=0)state.vacancyMod=0;}
  rollForEvent();
  if(calcTotalAssets()>0) state.creditScore=Math.min(850,state.creditScore+Math.min(3,Math.floor(calcTotalAssets()/100000)));
  checkMilestones();
  const nw=calcNetWorth();
  if(nw<-5000){state.bankruptMonths++;if(state.bankruptMonths>=6) showBankruptModal();
    else if(state.bankruptMonths>=3) addEventLog('âš ï¸ ç ´ç”£è­¦å‘Šï¼','bad');
  } else state.bankruptMonths=0;
  updateUI();buildSidebar();
}
function showBankruptModal(){
  gamePaused=true;
  document.getElementById('m-stars').textContent='ğŸ’¸ğŸ’¸ğŸ’¸';
  document.getElementById('m-title').textContent='ç ´ç”£ï¼';
  document.getElementById('m-desc').textContent=`å€Ÿå…¥é‡‘ãŒè³‡ç”£ã‚’å¤§å¹…ã«ä¸Šå›ã‚Šã¾ã—ãŸã€‚\n\næœ€çµ‚ç´”è³‡ç”£: ${fmtMoney(Math.floor(calcNetWorth()))}`;
  document.getElementById('m-btn').textContent='ãƒªã‚»ãƒƒãƒˆã—ã¦å†æŒ‘æˆ¦';
  document.getElementById('m-btn').onclick=function(){closeModal();confirmReset();};
  document.getElementById('modal').classList.add('show');
}

// ==================== UI ====================
function updateUI(){
  document.getElementById('s-money').textContent=fmtMoney(Math.floor(state.money));
  document.getElementById('s-assets').textContent=fmtMoney(Math.floor(calcTotalAssets()));
  document.getElementById('s-debt').textContent=fmtMoney(Math.floor(state.loanBalance));
  const nw=calcNetWorth();
  document.getElementById('s-networth').textContent=fmtMoney(Math.floor(nw));
  document.getElementById('s-date').textContent=`${state.year}å¹´ ${state.month}æœˆ`;
  const idx=state.maxMilestone;
  document.getElementById('milestone-name').textContent=MILESTONES[idx]?.title||'åˆå¿ƒè€…';
  if(idx<MILESTONES.length-1){
    const next=MILESTONES[idx+1],prev=MILESTONES[idx]?.threshold||0;
    const pct=Math.max(0,Math.min(100,(nw-prev)/(next.threshold-prev)*100));
    document.getElementById('milestone-fill').style.width=pct+'%';
    document.getElementById('milestone-goal').textContent=`æ¬¡: ${fmtMoney(next.threshold)} (${Math.floor(pct)}%)`;
  } else {
    document.getElementById('milestone-fill').style.width='100%';
    document.getElementById('milestone-goal').textContent='æœ€é«˜ãƒ©ãƒ³ã‚¯é”æˆï¼';
  }
}
function notify(text,type='gd'){
  const el=document.getElementById('notif');el.textContent=text;el.className=`notif show ${type}`;
  clearTimeout(notifTO);notifTO=setTimeout(()=>el.classList.remove('show'),2200);
}
function spawnFloat(x,y,text,isDebit){
  const el=document.createElement('div');el.className='ifloat';el.textContent=text;
  el.style.left=x+'px';el.style.top=y+'px';el.style.color=isDebit?'#f85149':'#3fb950';
  document.getElementById('map-wrap').appendChild(el);setTimeout(()=>el.remove(),1400);
}

// ==================== SAVE / LOAD ====================
const SK='empireBuilder_tokyo_v2';
function saveGame(){
  try{
    localStorage.setItem(SK,JSON.stringify({...state,money:Math.floor(state.money*100)/100,cam,savedAt:new Date().toISOString()}));
    notify('ğŸ’¾ ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼','gr');
  }catch(e){notify('âŒ ã‚»ãƒ¼ãƒ–å¤±æ•—','rd');}
}
function loadGame(){
  try{
    const raw=localStorage.getItem(SK); if(!raw){notify('ğŸ“‚ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—','rd');return;}
    const d=JSON.parse(raw);
    state={money:d.money||10000,year:d.year||1,month:d.month||1,loanBalance:d.loanBalance||0,loanRate:d.loanRate||0,
      creditScore:d.creditScore||600,maxMilestone:d.maxMilestone||0,population:d.population||0,
      grid:d.grid||{},properties:d.properties||{},districts:d.districts||{},eventLog:d.eventLog||[],
      marketMod:d.marketMod||0,marketModMonths:d.marketModMonths||0,vacancyMod:d.vacancyMod||0,
      vacancyModMonths:d.vacancyModMonths||0,rateMod:d.rateMod||0,bankruptMonths:d.bankruptMonths||0};
    if(d.cam) Object.assign(cam,d.cam);
    clampCam();updateUI();buildSidebar();renderEventLog();drawBg();drawCity();
    notify('ğŸ“‚ ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼','gd');
  }catch(e){notify('âŒ ãƒ­ãƒ¼ãƒ‰å¤±æ•—','rd');}
}
function confirmReset(){
  if(confirm('æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚')){
    localStorage.removeItem(SK);state=defaultState();initDistricts();
    cam={x:MAP_W/2-VW/2,y:MAP_H/2-VH/2};clampCam();
    selectedType='house';isDemolish=false;isRepairMode=false;lastMonthTime=Date.now();
    updateUI();buildSidebar();renderEventLog();drawBg();drawCity();
    notify('ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ','gd');
  }
}

// ==================== GAME LOOP ====================
function animate(){
  animFrame++;
  if(!gamePaused&&Date.now()-lastMonthTime>=MONTH_MS){lastMonthTime=Date.now();monthlyTick();}
  if(animFrame%3===0) drawBg();
  drawCity();
  if(animFrame%10===0) drawMinimap();
  requestAnimationFrame(animate);
}

// ==================== INIT ====================
generateTerrain();
window.addEventListener('resize',resize);
resize();
cam.x=MAP_W/2-VW/2;cam.y=MAP_H/2-VH/2;clampCam();

const hasSave=localStorage.getItem(SK);
if(hasSave){
  setTimeout(()=>{if(confirm('å‰å›ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ'))loadGame();else{initDistricts();buildSidebar();updateUI();}},400);
} else initDistricts();

buildSidebar();updateUI();
setInterval(()=>{if(!gamePaused)saveGame();},60000);
animate();
</script>
</body>
</html>
