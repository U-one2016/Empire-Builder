<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMPIRE BUILDER - ä¸å‹•ç”£æŠ•è³‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap');
:root{--bg:#0e1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--gold:#f0b429;--gold2:#d97706;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--purple:#bc8cff;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;user-select:none;}
header{display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;gap:10px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;color:var(--gold);white-space:nowrap;}
.stats-bar{display:flex;gap:5px;flex:1;justify-content:center;flex-wrap:wrap;}
.stat-chip{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 9px;display:flex;align-items:center;gap:5px;font-family:'JetBrains Mono',monospace;font-size:0.75rem;}
.stat-chip .lbl{color:var(--text2);font-size:0.6rem;}
.stat-chip .val{color:var(--gold);font-weight:700;}
.stat-chip.inc .val{color:var(--green);}
.stat-chip.debt .val{color:var(--red);}
.stat-chip.pop .val{color:var(--accent);}
.stat-chip.stg .val{color:var(--purple);}
.hbtns{display:flex;gap:5px;flex-shrink:0;}
.hbtn{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 11px;cursor:pointer;color:var(--text);font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;transition:all .15s;white-space:nowrap;}
.hbtn:hover{border-color:var(--gold);color:var(--gold);}
.hbtn.sv{border-color:var(--green);color:var(--green);}
.hbtn.sv:hover{background:rgba(63,185,80,.15);}
.stage-bar-wrap{padding:4px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;}
.stage-label{font-size:0.62rem;color:var(--text2);margin-bottom:3px;display:flex;justify-content:space-between;}
.stage-track{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.stage-fill{height:100%;background:linear-gradient(90deg,var(--gold2),var(--gold));border-radius:3px;transition:width .4s ease;}
.main{display:flex;flex:1;overflow:hidden;}
#map-wrap{flex:1;position:relative;overflow:hidden;cursor:crosshair;}
canvas{display:block;position:absolute;top:0;left:0;}
#cv-bg{z-index:1;}#cv-city{z-index:2;}#cv-ui{z-index:3;pointer-events:none;}
#minimap{position:absolute;bottom:10px;right:10px;border:1px solid var(--border);border-radius:6px;overflow:hidden;z-index:10;cursor:pointer;}
.sidebar{width:210px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;}
.sidebar::-webkit-scrollbar{width:4px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.sb-sec{padding:9px;border-bottom:1px solid var(--border);}
.sb-ttl{font-size:0.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:7px;display:flex;align-items:center;gap:5px;}
.sb-ttl::after{content:'';flex:1;height:1px;background:var(--border);}
.bld-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:6px 8px;cursor:pointer;display:flex;align-items:center;gap:7px;color:var(--text);font-family:'Noto Sans JP',sans-serif;margin-bottom:4px;transition:all .15s;position:relative;text-align:left;}
.bld-btn:hover{border-color:rgba(240,180,41,.5);background:var(--surface);}
.bld-btn.active{border-color:var(--gold);background:rgba(240,180,41,.08);}
.bld-btn.locked{opacity:.4;cursor:not-allowed;}
.bld-btn.locked:hover{border-color:var(--border);background:var(--surface2);}
.bld-ico{width:32px;height:32px;flex-shrink:0;border-radius:4px;overflow:hidden;}
.bld-info{flex:1;min-width:0;}
.bld-name{font-size:0.74rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bld-meta{display:flex;gap:4px;margin-top:2px;flex-wrap:wrap;}
.bc{font-size:0.6rem;color:var(--gold);font-family:'JetBrains Mono',monospace;}
.bi{font-size:0.6rem;color:var(--green);font-family:'JetBrains Mono',monospace;}
.bp{font-size:0.6rem;color:var(--accent);font-family:'JetBrains Mono',monospace;}
.br{font-size:0.6rem;color:var(--red);font-family:'JetBrains Mono',monospace;}
.lk-badge{position:absolute;top:3px;right:3px;background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:1px 3px;font-size:0.52rem;color:var(--text2);}
.tool-btns{display:flex;flex-direction:column;gap:4px;}
.tbtn{width:100%;border-radius:7px;padding:7px 9px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:0.74rem;transition:all .15s;border:1px solid;text-align:center;}
.tbtn.demo{background:rgba(248,81,73,.1);border-color:var(--red);color:var(--red);}
.tbtn.demo:hover,.tbtn.demo.on{background:rgba(248,81,73,.25);}
.tbtn.repair{background:rgba(88,166,255,.1);border-color:var(--accent);color:var(--accent);}
.tbtn.repair:hover,.tbtn.repair.on{background:rgba(88,166,255,.25);}
.tbtn.rst{background:rgba(139,148,158,.1);border-color:var(--border);color:var(--text2);}
.tbtn.rst:hover{background:rgba(139,148,158,.2);color:var(--text);}
.tooltip{position:absolute;background:var(--surface);border:1px solid var(--gold);padding:7px 11px;border-radius:8px;font-size:0.7rem;pointer-events:none;z-index:100;display:none;box-shadow:0 4px 20px rgba(0,0,0,.5);max-width:220px;}
.tooltip .ttn{font-weight:700;margin-bottom:3px;color:var(--gold);}
.tooltip .ttr{color:var(--text2);font-size:0.62rem;line-height:1.7;}
.tooltip .ttr span{color:var(--text);}
.tooltip .ttr .up{color:var(--green);}
.tooltip .ttr .dn{color:var(--red);}
.notif{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);padding:7px 16px;border-radius:20px;font-size:0.77rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:200;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4);}
.notif.show{opacity:1;}
.notif.gd{border-color:var(--gold);color:var(--gold);}
.notif.gr{border-color:var(--green);color:var(--green);}
.notif.rd{border-color:var(--red);color:var(--red);}
.notif.pu{border-color:var(--purple);color:var(--purple);}
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;}
.modal-ov.show{display:flex;}
.modal{background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:32px 44px;text-align:center;max-width:440px;box-shadow:0 0 60px rgba(240,180,41,.25);}
.modal h2{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:4px;color:var(--gold);margin-bottom:6px;}
.modal p{color:var(--text2);margin-bottom:22px;font-size:0.88rem;white-space:pre-line;}
.modal-btn{background:var(--gold);color:#000;border:none;padding:11px 28px;border-radius:8px;font-size:.95rem;font-weight:700;font-family:'Noto Sans JP',sans-serif;cursor:pointer;margin:4px;}
.modal-btn:hover{background:var(--gold2);}
.modal-btn.secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.modal-btn.secondary:hover{border-color:var(--gold);}
.mstars{font-size:1.8rem;margin-bottom:10px;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-45px)}}
.ifloat{position:absolute;font-family:'JetBrains Mono',monospace;font-size:0.72rem;pointer-events:none;z-index:150;animation:floatUp 1.4s ease forwards;font-weight:700;}
.scroll-hint{position:absolute;bottom:46px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.35);font-size:0.65rem;pointer-events:none;z-index:10;}
.event-log{position:absolute;bottom:10px;left:10px;z-index:10;display:flex;flex-direction:column;gap:3px;max-width:260px;pointer-events:none;}
.ev-item{background:rgba(22,27,34,.92);border:1px solid var(--border);border-radius:5px;padding:3px 7px;font-size:0.6rem;backdrop-filter:blur(4px);display:flex;gap:5px;align-items:center;}
.ev-item.good{border-color:var(--green);color:var(--green);}
.ev-item.bad{border-color:var(--red);color:var(--red);}
.ev-item.neutral{border-color:var(--gold);color:var(--gold);}
.ev-item .ev-date{color:var(--text2);font-family:'JetBrains Mono',monospace;font-size:0.55rem;flex-shrink:0;}
.loan-body{text-align:left;margin-bottom:18px;}
.loan-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;margin-bottom:14px;}
.loan-lbl{font-size:0.65rem;color:var(--text2);}
.loan-val{font-size:0.85rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
.loan-val.green{color:var(--green);}
.loan-val.red{color:var(--red);}
.loan-val.gold{color:var(--gold);}
.loan-sep{border:none;border-top:1px solid var(--border);margin:10px 0;}
.loan-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
.loan-row label{font-size:0.72rem;color:var(--text2);white-space:nowrap;}
.loan-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:0.85rem;outline:none;}
.loan-row input:focus{border-color:var(--gold);}
.port-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px 8px;}
.port-item{display:flex;flex-direction:column;}
.port-lbl{font-size:0.52rem;color:var(--text2);}
.port-val{font-size:0.7rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--text);}
</style>
</head>
<body>
<header>
  <div class="logo">ğŸ™ EMPIRE BUILDER</div>
  <div class="stats-bar">
    <div class="stat-chip"><span class="lbl">ğŸ’° ç¾é‡‘</span><span class="val" id="s-money">10,000</span></div>
    <div class="stat-chip inc"><span class="lbl">ğŸ  è³‡ç”£ç·é¡</span><span class="val" id="s-assets">0</span></div>
    <div class="stat-chip debt"><span class="lbl">ğŸ’³ å€Ÿå…¥æ®‹é«˜</span><span class="val" id="s-debt">0</span></div>
    <div class="stat-chip pop"><span class="lbl">ğŸ“Š ç´”è³‡ç”£</span><span class="val" id="s-networth">10,000</span></div>
    <div class="stat-chip stg"><span class="lbl">ğŸ“…</span><span class="val" id="s-date">1å¹´ 1æœˆ</span></div>
  </div>
  <div class="hbtns">
    <button class="hbtn" onclick="openLoanDialog()">ğŸ’³ å€Ÿå…¥</button>
    <button class="hbtn sv" onclick="saveGame()">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
    <button class="hbtn" onclick="loadGame()">ğŸ“‚ ãƒ­ãƒ¼ãƒ‰</button>
  </div>
</header>
<div class="stage-bar-wrap">
  <div class="stage-label">
    <span id="milestone-name">åˆå¿ƒè€…æŠ•è³‡å®¶</span>
    <span id="milestone-goal">æ¬¡: ç´”è³‡ç”£ Â¥50,000</span>
  </div>
  <div class="stage-track"><div class="stage-fill" id="milestone-fill" style="width:0%"></div></div>
</div>
<div class="main">
  <div id="map-wrap">
    <canvas id="cv-bg"></canvas>
    <canvas id="cv-city"></canvas>
    <canvas id="cv-ui"></canvas>
    <canvas id="minimap" width="160" height="100"></canvas>
    <div class="tooltip" id="tooltip">
      <div class="ttn" id="tt-name"></div>
      <div class="ttr" id="tt-val-row">è©•ä¾¡é¡: <span id="tt-val"></span></div>
      <div class="ttr" id="tt-cost-row">è³¼å…¥ä¾¡æ ¼: <span id="tt-cost"></span> (<span id="tt-change"></span>)</div>
      <div class="ttr" id="tt-rent-row">æœˆé¡è³ƒæ–™: <span id="tt-rent"></span></div>
      <div class="ttr" id="tt-vac-row">ç©ºå®¤ç‡: <span id="tt-vac"></span></div>
      <div class="ttr" id="tt-cond-row">çŠ¶æ…‹: <span id="tt-cond"></span></div>
      <div class="ttr" id="tt-dist-row">åœ°åŒºè©•ä¾¡: <span id="tt-dist"></span></div>
    </div>
    <div class="notif" id="notif"></div>
    <div class="event-log" id="event-log"></div>
    <div class="scroll-hint">ğŸ–± ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</div>
  </div>
  <div class="sidebar" id="sidebar"></div>
</div>
<div class="modal-ov" id="modal">
  <div class="modal">
    <div class="mstars" id="m-stars">â­â­â­</div>
    <h2 id="m-title">MILESTONE!</h2>
    <p id="m-desc">æ–°ã—ã„å»ºç‰©ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚</p>
    <button class="modal-btn" id="m-btn" onclick="closeModal()">OK â†’</button>
  </div>
</div>
<div class="modal-ov" id="loan-modal">
  <div class="modal" style="max-width:440px">
    <h2>ğŸ’³ èè³‡ã‚»ãƒ³ã‚¿ãƒ¼</h2>
    <div class="loan-body" id="loan-body"></div>
    <button class="modal-btn secondary" onclick="closeLoanDialog()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ==================== BUILDINGS ====================
const BUILDINGS = [
  // Tier 0 (start)
  {id:'cottage',   name:'å°å±‹',              cost:300,   baseRent:15,   pop:2,   risk:1, tier:0, cat:'residential'},
  {id:'house',     name:'ä¸€èˆ¬ä½å®…',          cost:800,   baseRent:40,   pop:5,   risk:1, tier:0, cat:'residential'},
  {id:'road',      name:'é“è·¯',              cost:150,   baseRent:0,    pop:0,   risk:0, tier:0, cat:'infra', repBonus:2},
  {id:'park',      name:'å…¬åœ’',              cost:600,   baseRent:0,    pop:0,   risk:0, tier:0, cat:'infra', repBonus:5},
  // Tier 1 (Â¥50K net worth)
  {id:'apartment', name:'ã‚¢ãƒ‘ãƒ¼ãƒˆ',          cost:2500,  baseRent:125,  pop:20,  risk:2, tier:1, cat:'residential'},
  {id:'shop',      name:'å•†åº—',              cost:1800,  baseRent:90,   pop:3,   risk:2, tier:1, cat:'commercial'},
  {id:'mountain',  name:'å±±',                cost:1000,  baseRent:0,    pop:0,   risk:0, tier:1, cat:'infra', repBonus:8},
  {id:'ocean',     name:'æµ·ãƒ»ãƒ“ãƒ¼ãƒ',        cost:1200,  baseRent:0,    pop:0,   risk:0, tier:1, cat:'infra', repBonus:10},
  // Tier 2 (Â¥200K)
  {id:'clinic',    name:'ã‚¯ãƒªãƒ‹ãƒƒã‚¯',        cost:3000,  baseRent:150,  pop:5,   risk:2, tier:2, cat:'commercial'},
  {id:'school',    name:'å°å­¦æ ¡',            cost:4000,  baseRent:0,    pop:30,  risk:1, tier:2, cat:'infra', repBonus:12},
  {id:'condo',     name:'é«˜ç´šãƒãƒ³ã‚·ãƒ§ãƒ³',    cost:10000, baseRent:500,  pop:60,  risk:2, tier:2, cat:'residential'},
  {id:'office',    name:'ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«',      cost:8000,  baseRent:400,  pop:0,   risk:2, tier:2, cat:'commercial'},
  // Tier 3 (Â¥1M)
  {id:'hotel',     name:'ãƒ›ãƒ†ãƒ«',            cost:7000,  baseRent:350,  pop:0,   risk:3, tier:3, cat:'commercial'},
  {id:'stadium',   name:'ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',        cost:12000, baseRent:600,  pop:0,   risk:3, tier:3, cat:'commercial'},
  // Tier 4 (Â¥10M)
  {id:'skyscraper',name:'è¶…å·¨å¤§ãƒ“ãƒ«',        cost:15000, baseRent:750,  pop:0,   risk:3, tier:4, cat:'commercial'},
  {id:'mall',      name:'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«',cost:18000, baseRent:900,  pop:0,   risk:3, tier:4, cat:'commercial'},
  {id:'luxury',    name:'è¶…é«˜ç´šãƒãƒ³ã‚·ãƒ§ãƒ³',  cost:10000, baseRent:500,  pop:80,  risk:3, tier:4, cat:'residential'},
  {id:'airport',   name:'å›½éš›ç©ºæ¸¯',          cost:25000, baseRent:1250, pop:0,   risk:3, tier:4, cat:'commercial'},
];

const MILESTONES = [
  {threshold:10000,    title:'åˆå¿ƒè€…æŠ•è³‡å®¶'},
  {threshold:50000,    title:'ä¸å‹•ç”£ã‚ªãƒ¼ãƒŠãƒ¼'},
  {threshold:200000,   title:'åœ°åŸŸé–‹ç™ºè€…'},
  {threshold:1000000,  title:'ä¸å‹•ç”£ç‹'},
  {threshold:10000000, title:'ãƒ¡ã‚¬æŠ•è³‡å®¶'},
];

const EVENT_TYPES = [
  {id:'boom',   name:'å¸‚å ´å¥½æ³',   weight:5, type:'good',    icon:'ğŸ“ˆ'},
  {id:'crash',  name:'å¸‚å ´æš´è½',   weight:3, type:'bad',     icon:'ğŸ“‰'},
  {id:'quake',  name:'åœ°éœ‡',       weight:2, type:'bad',     icon:'ğŸŒ‹'},
  {id:'fire',   name:'ç«ç½',       weight:3, type:'bad',     icon:'ğŸ”¥'},
  {id:'exodus', name:'äººå£æµå‡º',   weight:4, type:'bad',     icon:'ğŸšª'},
  {id:'redev',  name:'å†é–‹ç™º',     weight:5, type:'good',    icon:'ğŸ—'},
  {id:'rate',   name:'é‡‘åˆ©å¤‰å‹•',   weight:8, type:'neutral', icon:'ğŸ’¹'},
  {id:'vacancy',name:'ç©ºå®¤å¢—åŠ ',   weight:6, type:'bad',     icon:'ğŸš'},
];

const DIST_NAMES = [
  'æ¸¯åŒ—','ä¸­å¤®','éƒ½å¿ƒ','æ¸¯å—',
  'è¥¿éƒ¨','æœ¬ç”º','æ „','æ±éƒ¨',
  'å—è¥¿','ä¸‹ç”º','å•†æ¥­','å—æ±',
];

const CATS = [
  {label:'ğŸ˜ ä½å±…',    ids:['cottage','house','apartment','condo','luxury']},
  {label:'ğŸ¬ å•†æ¥­',    ids:['shop','clinic','office','hotel','stadium','skyscraper','mall','airport']},
  {label:'ğŸŒ¿ ã‚¤ãƒ³ãƒ•ãƒ©',ids:['road','park','mountain','ocean','school']},
];

// ==================== SVG ICONS ====================
const SVGS={
  cottage:`<svg viewBox="0 0 32 32"><rect x="5" y="17" width="22" height="13" fill="#8B7355" rx="1"/><polygon points="16,5 3,19 29,19" fill="#6B4F35"/><rect x="12" y="24" width="8" height="6" fill="#3D2B1F"/><rect x="6" y="19" width="5" height="5" fill="#C4A882"/></svg>`,
  house:`<svg viewBox="0 0 32 32"><rect x="3" y="15" width="26" height="15" fill="#C4956A" rx="1"/><polygon points="16,3 1,17 31,17" fill="#8B6347"/><rect x="11" y="23" width="10" height="7" fill="#5C3A21"/><rect x="4" y="17" width="6" height="6" fill="#87CEEB" opacity=".8"/><rect x="22" y="17" width="6" height="6" fill="#87CEEB" opacity=".8"/></svg>`,
  road:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#1a1a1a"/><line x1="0" y1="16" x2="32" y2="16" stroke="#F0B429" stroke-width="1.5" stroke-dasharray="5,4"/><line x1="16" y1="0" x2="16" y2="32" stroke="#F0B429" stroke-width="1.5" stroke-dasharray="5,4"/></svg>`,
  park:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#2e7d32"/><circle cx="10" cy="14" r="8" fill="#1b5e20"/><circle cx="24" cy="17" r="6" fill="#1b5e20"/><circle cx="10" cy="14" r="5" fill="#4caf50"/><circle cx="24" cy="17" r="4" fill="#4caf50"/><rect x="9" y="18" width="2" height="12" fill="#5c3a1e"/><rect x="23" y="20" width="2" height="10" fill="#5c3a1e"/></svg>`,
  mountain:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#546e7a"/><polygon points="16,2 2,28 30,28" fill="#78909c"/><polygon points="16,2 10,14 22,14" fill="white"/><polygon points="22,8 14,28 30,28" fill="#607d8b"/><polygon points="22,8 18,18 26,18" fill="#e0e0e0"/></svg>`,
  ocean:`<svg viewBox="0 0 32 32"><rect width="32" height="32" fill="#0277bd"/><rect x="0" y="20" width="32" height="12" fill="#01579b"/><rect x="0" y="24" width="32" height="4" fill="#039be5" opacity=".5"/><rect x="0" y="18" width="32" height="5" fill="#f5deb3"/><circle cx="8" cy="14" r="6" fill="#fff9c4"/><circle cx="22" cy="12" r="4" fill="#fffde7" opacity=".8"/></svg>`,
  apartment:`<svg viewBox="0 0 32 32"><rect x="4" y="3" width="24" height="29" fill="#6B7280" rx="1"/><rect x="4" y="3" width="24" height="4" fill="#4B5563"/><rect x="7" y="9" width="5" height="4" fill="#87CEEB" opacity=".9"/><rect x="15" y="9" width="5" height="4" fill="#FFE082"/><rect x="7" y="17" width="5" height="4" fill="#FFE082"/><rect x="15" y="17" width="5" height="4" fill="#87CEEB"/><rect x="11" y="27" width="10" height="5" fill="#374151"/></svg>`,
  shop:`<svg viewBox="0 0 32 32"><rect x="2" y="13" width="28" height="19" fill="#D97706" rx="1"/><rect x="2" y="9" width="28" height="6" fill="#B45309"/><rect x="2" y="6" width="28" height="5" fill="#F59E0B"/><rect x="7" y="19" width="8" height="9" fill="#92400E"/><rect x="19" y="19" width="9" height="6" fill="#FEF3C7" opacity=".8"/></svg>`,
  clinic:`<svg viewBox="0 0 32 32"><rect x="3" y="7" width="26" height="25" fill="#F8FAFC" rx="1"/><rect x="3" y="7" width="26" height="6" fill="#EF4444"/><rect x="13" y="1" width="6" height="8" fill="#EF4444"/><rect x="14" y="3" width="4" height="4" fill="white"/><rect x="7" y="17" width="8" height="8" fill="#87CEEB"/><rect x="19" y="17" width="8" height="8" fill="#87CEEB"/></svg>`,
  school:`<svg viewBox="0 0 32 32"><rect x="2" y="11" width="28" height="21" fill="#FEF3C7" rx="1"/><rect x="2" y="7" width="28" height="6" fill="#D97706"/><polygon points="16,1 2,9 30,9" fill="#B45309"/><rect x="6" y="17" width="6" height="6" fill="#87CEEB"/><rect x="20" y="17" width="6" height="6" fill="#87CEEB"/><rect x="12" y="25" width="8" height="7" fill="#92400E"/></svg>`,
  condo:`<svg viewBox="0 0 32 32"><rect x="9" y="0" width="14" height="32" fill="#263238" rx="1"/><rect x="4" y="15" width="24" height="17" fill="#37474f" rx="1"/><rect x="10" y="3" width="4" height="3" fill="#93C5FD"/><rect x="16" y="3" width="4" height="3" fill="#FDE68A"/><rect x="10" y="9" width="4" height="3" fill="#FDE68A"/><rect x="16" y="9" width="4" height="3" fill="#93C5FD"/><rect x="6" y="18" width="4" height="3" fill="#93C5FD"/><rect x="13" y="18" width="4" height="3" fill="#FDE68A"/><rect x="20" y="18" width="4" height="3" fill="#93C5FD"/><rect x="6" y="24" width="4" height="3" fill="#FDE68A"/><rect x="13" y="24" width="4" height="3" fill="#93C5FD"/><rect x="20" y="24" width="4" height="3" fill="#FDE68A"/></svg>`,
  office:`<svg viewBox="0 0 32 32"><rect x="5" y="1" width="22" height="31" fill="#1E3A5F" rx="1"/><rect x="7" y="4" width="8" height="4" fill="#93C5FD" opacity=".8"/><rect x="17" y="4" width="8" height="4" fill="#93C5FD" opacity=".8"/><rect x="7" y="11" width="8" height="4" fill="#BAE6FD"/><rect x="17" y="11" width="8" height="4" fill="#93C5FD"/><rect x="7" y="18" width="8" height="4" fill="#93C5FD"/><rect x="17" y="18" width="8" height="4" fill="#BAE6FD"/><rect x="7" y="25" width="18" height="4" fill="#BAE6FD" opacity=".6"/></svg>`,
  hotel:`<svg viewBox="0 0 32 32"><rect x="4" y="5" width="24" height="27" fill="#7C2D12" rx="1"/><rect x="4" y="5" width="24" height="5" fill="#9A3412"/><polygon points="16,0 4,7 28,7" fill="#B45309"/><rect x="7" y="13" width="5" height="4" fill="#FDE68A"/><rect x="14" y="13" width="5" height="4" fill="#FDE68A"/><rect x="21" y="13" width="5" height="4" fill="#FDE68A"/><rect x="7" y="20" width="5" height="4" fill="#FDE68A"/><rect x="14" y="20" width="5" height="4" fill="#FDE68A"/><rect x="21" y="20" width="5" height="4" fill="#FDE68A"/><rect x="12" y="27" width="8" height="5" fill="#6B1A0A"/></svg>`,
  stadium:`<svg viewBox="0 0 32 32"><rect x="1" y="7" width="30" height="20" fill="#374151" rx="9"/><rect x="5" y="11" width="22" height="12" fill="#16A34A" rx="5"/><rect x="10" y="14" width="12" height="6" fill="#22C55E" rx="2"/><rect x="4" y="5" width="2" height="10" fill="#4B5563"/><rect x="26" y="5" width="2" height="10" fill="#4B5563"/><circle cx="5" cy="5" r="3" fill="#4B5563"/><circle cx="27" cy="5" r="3" fill="#4B5563"/></svg>`,
  skyscraper:`<svg viewBox="0 0 32 32"><rect x="7" y="13" width="18" height="19" fill="#334155" rx="1"/><rect x="10" y="0" width="12" height="32" fill="#1E293B" rx="1"/><rect x="11" y="2" width="4" height="3" fill="#BAE6FD"/><rect x="17" y="2" width="4" height="3" fill="#FDE68A"/><rect x="11" y="7" width="4" height="3" fill="#FDE68A"/><rect x="17" y="7" width="4" height="3" fill="#BAE6FD"/><rect x="8" y="15" width="4" height="3" fill="#BAE6FD"/><rect x="14" y="15" width="4" height="3" fill="#FDE68A"/><rect x="20" y="15" width="4" height="3" fill="#BAE6FD"/><rect x="8" y="21" width="4" height="3" fill="#FDE68A"/><rect x="14" y="21" width="4" height="3" fill="#BAE6FD"/><rect x="20" y="21" width="4" height="3" fill="#FDE68A"/><circle cx="16" cy="0" r="2" fill="#EF4444"/></svg>`,
  mall:`<svg viewBox="0 0 32 32"><rect x="0" y="13" width="32" height="19" fill="#475569" rx="2"/><rect x="8" y="5" width="16" height="10" fill="#334155" rx="1"/><rect x="0" y="9" width="32" height="6" fill="#334155"/><rect x="3" y="16" width="9" height="8" fill="#FDE68A" opacity=".7"/><rect x="14" y="16" width="9" height="8" fill="#BAE6FD" opacity=".7"/><rect x="25" y="16" width="5" height="8" fill="#FDE68A" opacity=".5"/></svg>`,
  luxury:`<svg viewBox="0 0 32 32"><rect x="10" y="0" width="12" height="32" fill="#1C1917" rx="1"/><rect x="3" y="19" width="26" height="13" fill="#292524" rx="1"/><rect x="11" y="2" width="4" height="3" fill="#D4AF37"/><rect x="17" y="2" width="4" height="3" fill="#FDE68A"/><rect x="11" y="7" width="4" height="3" fill="#FDE68A"/><rect x="17" y="7" width="4" height="3" fill="#D4AF37"/><rect x="5" y="21" width="5" height="4" fill="#D4AF37"/><rect x="13" y="21" width="5" height="4" fill="#FDE68A"/><rect x="21" y="21" width="5" height="4" fill="#D4AF37"/><rect x="5" y="27" width="5" height="4" fill="#FDE68A"/><rect x="13" y="27" width="5" height="4" fill="#D4AF37"/><rect x="21" y="27" width="5" height="4" fill="#FDE68A"/></svg>`,
  airport:`<svg viewBox="0 0 32 32"><rect x="0" y="21" width="32" height="11" fill="#212121"/><rect x="3" y="13" width="26" height="10" fill="#37474f"/><rect x="8" y="7" width="16" height="8" fill="#1E3A5F" rx="1"/><rect x="4" y="15" width="5" height="5" fill="#BAE6FD" opacity=".8"/><rect x="23" y="15" width="5" height="5" fill="#BAE6FD" opacity=".8"/><polygon points="16,3 10,9 22,9" fill="#334155"/><rect x="27" y="9" width="4" height="14" fill="#546e7a"/><rect x="25" y="9" width="8" height="4" fill="#80cbc4"/></svg>`,
};

// ==================== GRID CONSTANTS ====================
const GRID = 36;
const MAP_COLS = 80;
const MAP_ROWS = 50;
const MAP_W = MAP_COLS * GRID;
const MAP_H = MAP_ROWS * GRID;
const DIST_COLS = 4;
const DIST_ROWS = 3;
const DIST_W = MAP_COLS / DIST_COLS; // 20
const DIST_H = Math.ceil(MAP_ROWS / DIST_ROWS); // 17
const MONTH_MS = 5000;

// ==================== STATE ====================
function defaultState(){
  return {
    money: 10000,
    year: 1,
    month: 1,
    loanBalance: 0,
    loanRate: 0,
    creditScore: 600,
    maxMilestone: 0,
    population: 0,
    grid: {},
    properties: {},
    districts: {},
    eventLog: [],
    marketMod: 0,
    marketModMonths: 0,
    vacancyMod: 0,
    vacancyModMonths: 0,
    rateMod: 0,
    bankruptMonths: 0,
  };
}

let state = defaultState();
let cam = {x:0, y:0};
let selectedType = 'house';
let isDemolish = false;
let isRepairMode = false;
let animFrame = 0;
let VW, VH;
let lastMonthTime = Date.now();
let notifTO;
let dragging = false, dragStart = {x:0,y:0}, camStart = {x:0,y:0};
let gamePaused = false;

const bgC   = document.getElementById('cv-bg');
const cityC = document.getElementById('cv-city');
const uiC   = document.getElementById('cv-ui');
const mm    = document.getElementById('minimap');
const bgX   = bgC.getContext('2d');
const cityX = cityC.getContext('2d');
const uiX   = uiC.getContext('2d');
const mmX   = mm.getContext('2d');

// ==================== TERRAIN ====================
const TERRAIN = {};
const TERRAIN_COLORS = {grass:'#3a6b3a', water:'#1a6fa0', sand:'#c2a46b', hill:'#6b7d6b'};
const TERRAIN_DARK = {grass:'#2e5430', water:'#154d72', sand:'#a8884a', hill:'#546059'};

function generateTerrain(){
  for(let cy=0;cy<MAP_ROWS;cy++){
    for(let cx=0;cx<MAP_COLS;cx++){
      const nx=cx/MAP_COLS, ny=cy/MAP_ROWS;
      const v=Math.sin(nx*6+1.2)*Math.cos(ny*5+0.7)+Math.sin(nx*12+0.3)*Math.cos(ny*8+1.5)*0.5+Math.sin((nx+ny)*9+2)*0.3;
      const mv=Math.sin(nx*8+2)*Math.cos(ny*6+1)+Math.sin(nx*3)*0.5;
      let t='grass';
      if(v<-0.7) t='water'; else if(v<-0.5) t='sand'; else if(mv>1.2) t='hill';
      TERRAIN[`${cx},${cy}`]=t;
    }
  }
  for(let cx=0;cx<MAP_COLS;cx++){ TERRAIN[`${cx},0`]='water'; TERRAIN[`${cx},${MAP_ROWS-1}`]='water'; }
  for(let cy=0;cy<MAP_ROWS;cy++){ TERRAIN[`0,${cy}`]='water'; TERRAIN[`${MAP_COLS-1},${cy}`]='water'; }
}

// ==================== DISTRICT SYSTEM ====================
function getDistrictKey(cx,cy){
  const dx=Math.min(Math.floor(cx/DIST_W), DIST_COLS-1);
  const dy=Math.min(Math.floor(cy/DIST_H), DIST_ROWS-1);
  return `${dx},${dy}`;
}

function getDistrictName(dk){
  const[dx,dy]=dk.split(',').map(Number);
  return DIST_NAMES[dy*DIST_COLS+dx]||'ä¸æ˜';
}

function initDistricts(){
  state.districts={};
  for(let dy=0;dy<DIST_ROWS;dy++){
    for(let dx=0;dx<DIST_COLS;dx++){
      let water=0, hill=0, total=0;
      for(let cy=dy*DIST_H; cy<Math.min((dy+1)*DIST_H, MAP_ROWS); cy++){
        for(let cx=dx*DIST_W; cx<Math.min((dx+1)*DIST_W, MAP_COLS); cx++){
          total++;
          const t=TERRAIN[`${cx},${cy}`];
          if(t==='water') water++;
          if(t==='hill') hill++;
        }
      }
      let baseRep=40;
      if(water/total>0.05 && water/total<0.4) baseRep+=15;
      if(hill/total>0.1) baseRep+=8;
      state.districts[`${dx},${dy}`]={reputation:Math.min(baseRep,80)};
    }
  }
}

function updateDistricts(){
  for(let dy=0;dy<DIST_ROWS;dy++){
    for(let dx=0;dx<DIST_COLS;dx++){
      const dk=`${dx},${dy}`;
      const dist=state.districts[dk];
      if(!dist) continue;
      let infraCount=0, buildingCount=0, totalCondition=0;
      for(let cy=dy*DIST_H; cy<Math.min((dy+1)*DIST_H, MAP_ROWS); cy++){
        for(let cx=dx*DIST_W; cx<Math.min((dx+1)*DIST_W, MAP_COLS); cx++){
          const prop=state.properties[`${cx},${cy}`];
          if(prop){
            buildingCount++;
            totalCondition+=prop.condition;
            const b=BUILDINGS.find(x=>x.id===prop.type);
            if(b&&b.cat==='infra') infraCount+=(b.repBonus||1);
          }
        }
      }
      let delta=0;
      if(infraCount>0) delta+=Math.min(infraCount*0.3, 3);
      if(buildingCount>0){
        const avgCond=totalCondition/buildingCount;
        if(avgCond<40) delta-=1;
        if(avgCond>70) delta+=0.5;
      }
      if(buildingCount>5) delta+=0.3;
      dist.reputation=Math.max(0, Math.min(100, dist.reputation+delta));
    }
  }
}

// ==================== SIDEBAR ====================
function buildSidebar(){
  const sb=document.getElementById('sidebar');
  sb.innerHTML='';

  // Portfolio summary
  const ps=document.createElement('div');
  ps.className='sb-sec';
  const propKeys=Object.keys(state.properties);
  const rentProps=propKeys.filter(k=>{const b=BUILDINGS.find(x=>x.id===state.properties[k].type);return b&&b.baseRent>0;});
  const avgVac=rentProps.length>0 ? rentProps.reduce((s,k)=>s+state.properties[k].vacancy,0)/rentProps.length : 0;
  const avgCond=propKeys.length>0 ? propKeys.reduce((s,k)=>s+state.properties[k].condition,0)/propKeys.length : 0;
  ps.innerHTML=`<div class="sb-ttl">ğŸ“‹ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</div>
    <div class="port-grid">
      <div class="port-item"><span class="port-lbl">ç‰©ä»¶æ•°</span><span class="port-val">${propKeys.length}</span></div>
      <div class="port-item"><span class="port-lbl">ä¿¡ç”¨ã‚¹ã‚³ã‚¢</span><span class="port-val">${state.creditScore}</span></div>
      <div class="port-item"><span class="port-lbl">å¹³å‡ç©ºå®¤ç‡</span><span class="port-val">${avgVac.toFixed(1)}%</span></div>
      <div class="port-item"><span class="port-lbl">å¹³å‡çŠ¶æ…‹</span><span class="port-val">${avgCond.toFixed(0)}/100</span></div>
    </div>`;
  sb.appendChild(ps);

  // Building categories
  CATS.forEach(cat=>{
    const sec=document.createElement('div');
    sec.className='sb-sec';
    sec.innerHTML=`<div class="sb-ttl">${cat.label}</div>`;
    cat.ids.forEach(id=>{
      const b=BUILDINGS.find(x=>x.id===id);
      if(!b)return;
      const locked=b.tier>state.maxMilestone;
      const btn=document.createElement('button');
      btn.className='bld-btn'+(locked?' locked':'')+(selectedType===id&&!locked&&!isDemolish&&!isRepairMode?' active':'');
      btn.dataset.id=id;
      const riskStars=b.risk>0?`<span class="br">${'â˜…'.repeat(b.risk)}${'â˜†'.repeat(3-b.risk)}</span>`:'';
      let incTxt='';
      if(b.cat==='infra'){
        incTxt=`<span class="bi">è©•ä¾¡+${b.repBonus||0}</span>`;
      } else if(b.baseRent>0){
        incTxt=`<span class="bi">Â¥${b.baseRent}/æœˆ</span>`;
      }
      btn.innerHTML=`<div class="bld-ico">${SVGS[id]||''}</div>
        <div class="bld-info">
          <div class="bld-name">${b.name}</div>
          <div class="bld-meta">
            <span class="bc">Â¥${b.cost.toLocaleString()}</span>
            ${incTxt}
            ${b.pop>0?`<span class="bp">ğŸ‘¥${b.pop}</span>`:''}
            ${riskStars}
          </div>
        </div>
        ${locked?`<div class="lk-badge">T${b.tier}ğŸ”’</div>`:''}`;
      if(!locked) btn.onclick=()=>selectBuilding(id);
      sec.appendChild(btn);
    });
    sb.appendChild(sec);
  });

  // Tools
  const ts=document.createElement('div');
  ts.className='sb-sec';
  ts.innerHTML=`<div class="sb-ttl">ãƒ„ãƒ¼ãƒ«</div><div class="tool-btns">
    <button class="tbtn demo${isDemolish?' on':''}" id="demo-btn" onclick="toggleDemolish()">ğŸ—‘ å–ã‚Šå£Šã—ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="tbtn repair${isRepairMode?' on':''}" id="repair-btn" onclick="toggleRepair()">ğŸ”§ ä¿®ç†ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="tbtn rst" onclick="confirmReset()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>`;
  sb.appendChild(ts);
}

function selectBuilding(id){
  selectedType=id; isDemolish=false; isRepairMode=false;
  document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.bld-btn[data-id="${id}"]`).forEach(b=>b.classList.add('active'));
  const db=document.getElementById('demo-btn'); if(db) db.classList.remove('on');
  const rb=document.getElementById('repair-btn'); if(rb) rb.classList.remove('on');
}

function toggleDemolish(){
  isDemolish=!isDemolish; isRepairMode=false;
  const db=document.getElementById('demo-btn'); if(db) db.classList.toggle('on',isDemolish);
  const rb=document.getElementById('repair-btn'); if(rb) rb.classList.remove('on');
  if(isDemolish) document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  notify(isDemolish?'ğŸ—‘ å–ã‚Šå£Šã—ãƒ¢ãƒ¼ãƒ‰':'âœï¸ å»ºè¨­ãƒ¢ãƒ¼ãƒ‰', isDemolish?'rd':'gd');
}

function toggleRepair(){
  isRepairMode=!isRepairMode; isDemolish=false;
  const rb=document.getElementById('repair-btn'); if(rb) rb.classList.toggle('on',isRepairMode);
  const db=document.getElementById('demo-btn'); if(db) db.classList.remove('on');
  if(isRepairMode) document.querySelectorAll('.bld-btn').forEach(b=>b.classList.remove('active'));
  notify(isRepairMode?'ğŸ”§ ä¿®ç†ãƒ¢ãƒ¼ãƒ‰':'âœï¸ å»ºè¨­ãƒ¢ãƒ¼ãƒ‰', isRepairMode?'pu':'gd');
}

// ==================== RESIZE ====================
function resize(){
  const wrap=document.getElementById('map-wrap');
  VW=wrap.offsetWidth; VH=wrap.offsetHeight;
  bgC.width=cityC.width=uiC.width=VW;
  bgC.height=cityC.height=uiC.height=VH;
  clampCam(); drawBg(); drawCity();
}
function clampCam(){
  cam.x=Math.max(0,Math.min(cam.x, MAP_W-VW));
  cam.y=Math.max(0,Math.min(cam.y, MAP_H-VH));
}

// ==================== BACKGROUND DRAWING ====================
function drawBg(){
  bgX.clearRect(0,0,VW,VH);
  const skyH=Math.max(0,-cam.y);
  if(skyH>0){
    const sg=bgX.createLinearGradient(0,0,0,skyH);
    sg.addColorStop(0,'#0a0a1a'); sg.addColorStop(1,'#1a2a4a');
    bgX.fillStyle=sg; bgX.fillRect(0,0,VW,skyH);
  }
  const c0=Math.floor(cam.x/GRID), r0=Math.floor(cam.y/GRID);
  const c1=Math.min(MAP_COLS-1, c0+Math.ceil(VW/GRID)+1);
  const r1=Math.min(MAP_ROWS-1, r0+Math.ceil(VH/GRID)+1);
  for(let r=r0;r<=r1;r++){
    for(let c=c0;c<=c1;c++){
      const t=TERRAIN[`${c},${r}`]||'grass';
      const sx=c*GRID-cam.x, sy=r*GRID-cam.y;
      bgX.fillStyle=TERRAIN_COLORS[t]; bgX.fillRect(sx,sy,GRID,GRID);
      bgX.fillStyle=TERRAIN_DARK[t]; bgX.fillRect(sx,sy,1,GRID); bgX.fillRect(sx,sy,GRID,1);
      if(t==='water'){
        const wv=(animFrame/40+(c*0.3+r*0.5))%1;
        bgX.fillStyle=`rgba(100,180,255,${0.1+wv*0.15})`;
        bgX.fillRect(sx+3,sy+GRID/2-2,GRID-6,3);
      }
      bgX.strokeStyle='rgba(0,0,0,0.08)'; bgX.lineWidth=0.5; bgX.strokeRect(sx,sy,GRID,GRID);
    }
  }
  // District boundary lines
  bgX.strokeStyle='rgba(255,255,255,0.12)'; bgX.lineWidth=1; bgX.setLineDash([6,4]);
  for(let dx=1;dx<DIST_COLS;dx++){
    const sx=dx*DIST_W*GRID-cam.x;
    if(sx>0&&sx<VW){ bgX.beginPath(); bgX.moveTo(sx,0); bgX.lineTo(sx,VH); bgX.stroke(); }
  }
  for(let dy=1;dy<DIST_ROWS;dy++){
    const sy=dy*DIST_H*GRID-cam.y;
    if(sy>0&&sy<VH){ bgX.beginPath(); bgX.moveTo(0,sy); bgX.lineTo(VW,sy); bgX.stroke(); }
  }
  bgX.setLineDash([]);
}

// ==================== DRAW BUILDINGS ====================
function drawBuilding(ctx,id,gx,gy,cx,cy){
  const t=animFrame/60;
  ctx.save();
  const G=GRID;
  switch(id){
    case 'cottage':{
      ctx.fillStyle='#5c4033'; ctx.fillRect(gx+4,gy+G-14,G-8,14);
      ctx.fillStyle='#8d6e63'; ctx.fillRect(gx+6,gy+G-20,G-12,10);
      ctx.fillStyle='#4e342e';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+G-26);ctx.lineTo(gx+4,gy+G-18);ctx.lineTo(gx+G-4,gy+G-18);ctx.closePath();ctx.fill();
      ctx.fillStyle=`rgba(255,220,120,${.5+Math.sin(t*2+cx)*.4})`;
      ctx.fillRect(gx+8,gy+G-19,6,5);
      break;}
    case 'house':{
      ctx.fillStyle='#bf8a60'; ctx.fillRect(gx+3,gy+14,G-6,G-15);
      ctx.fillStyle='#795548';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+4);ctx.lineTo(gx+1,gy+16);ctx.lineTo(gx+G-1,gy+16);ctx.closePath();ctx.fill();
      ctx.fillStyle='#4e342e'; ctx.fillRect(gx+G/2-4,gy+G-12,8,12);
      ctx.fillStyle=`rgba(135,206,235,${.7+Math.sin(t+cx*.5)*.2})`;
      ctx.fillRect(gx+5,gy+18,7,6); ctx.fillRect(gx+G-12,gy+18,7,6);
      break;}
    case 'road':{
      ctx.fillStyle='#1a1a1a'; ctx.fillRect(gx,gy,G,G);
      ctx.fillStyle='#252525'; ctx.fillRect(gx+1,gy+1,G-2,G-2);
      const cp=(animFrame*0.5+cx*7)%(G+10)-5;
      ctx.fillStyle='#ef5350'; ctx.fillRect(gx+cp,gy+G/2-4,8,4);
      const cp2=(animFrame*0.3+cy*11+20)%(G+10)-5;
      ctx.fillStyle='#42a5f5'; ctx.fillRect(gx+G/2-4,gy+G-cp2-4,4,6);
      ctx.strokeStyle='#F0B429'; ctx.setLineDash([5,4]); ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(gx,gy+G/2);ctx.lineTo(gx+G,gy+G/2);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gx+G/2,gy);ctx.lineTo(gx+G/2,gy+G);ctx.stroke();
      ctx.setLineDash([]);
      break;}
    case 'park':{
      ctx.fillStyle='#2e7d32'; ctx.fillRect(gx,gy,G,G);
      ctx.fillStyle='#9e8a6a'; ctx.fillRect(gx+G/2-3,gy,6,G); ctx.fillRect(gx,gy+G/2-3,G,6);
      const pp=(animFrame*0.4+cx*5)%(G-8);
      ctx.fillStyle='#fff'; ctx.beginPath();ctx.arc(gx+4+pp,gy+G/2-1,2,0,Math.PI*2);ctx.fill();
      [[10,G-18,8],[G-10,G-18,8],[G/2,10,10]].forEach(([tx,ty,r])=>{
        ctx.fillStyle='#1b5e20'; ctx.beginPath();ctx.arc(gx+tx,gy+ty,r+2,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#4caf50'; ctx.beginPath();ctx.arc(gx+tx,gy+ty,r-2,0,Math.PI*2);ctx.fill();
      });
      break;}
    case 'mountain':{
      ctx.fillStyle='#546e7a'; ctx.fillRect(gx,gy,G,G);
      ctx.fillStyle='#78909c';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+2,gy+G-2);ctx.lineTo(gx+G-2,gy+G-2);ctx.closePath();ctx.fill();
      ctx.fillStyle='#607d8b';
      ctx.beginPath();ctx.moveTo(gx+G*0.7,gy+8);ctx.lineTo(gx+G*0.4,gy+G-2);ctx.lineTo(gx+G-2,gy+G-2);ctx.closePath();ctx.fill();
      ctx.fillStyle='white';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+G/2-6,gy+12);ctx.lineTo(gx+G/2+6,gy+12);ctx.closePath();ctx.fill();
      const ca=.5+Math.sin(t*.5+cx)*.3;
      ctx.fillStyle=`rgba(255,255,255,${ca})`;
      ctx.beginPath();ctx.ellipse(gx+G/2+4,gy+6,5,3,0,0,Math.PI*2);ctx.fill();
      break;}
    case 'ocean':{
      ctx.fillStyle='#f5deb3'; ctx.fillRect(gx,gy,G,G/3+4);
      const wg=ctx.createLinearGradient(0,gy+G/3,0,gy+G);
      wg.addColorStop(0,'#039be5'); wg.addColorStop(1,'#01579b');
      ctx.fillStyle=wg; ctx.fillRect(gx,gy+G/3,G,G-G/3);
      const wt=(animFrame/30+cx*.5)%1;
      ctx.strokeStyle=`rgba(255,255,255,${.3+wt*.4})`; ctx.lineWidth=1.5; ctx.setLineDash([4,4]);
      ctx.beginPath();ctx.moveTo(gx,gy+G/2+wt*6);ctx.lineTo(gx+G,gy+G/2+wt*6);ctx.stroke();
      ctx.beginPath();ctx.moveTo(gx,gy+G*0.7+(1-wt)*5);ctx.lineTo(gx+G,gy+G*0.7+(1-wt)*5);ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle=`rgba(255,220,80,${.1+Math.sin(t+cx)*.05})`;
      ctx.fillRect(gx+G/2-3,gy+G/3,6,G-G/3);
      ctx.fillStyle='#e53935'; ctx.beginPath();ctx.ellipse(gx+8,gy+8,7,4,-.3,0,Math.PI);ctx.fill();
      ctx.strokeStyle='#795548'; ctx.lineWidth=1; ctx.setLineDash([]);
      ctx.beginPath();ctx.moveTo(gx+8,gy+8);ctx.lineTo(gx+10,gy+18);ctx.stroke();
      break;}
    case 'apartment':{
      ctx.fillStyle='#546e7a'; ctx.fillRect(gx+3,gy+2,G-6,G-3);
      ctx.fillStyle='#37474f'; ctx.fillRect(gx+3,gy+2,G-6,4);
      for(let row=0;row<3;row++) for(let col=0;col<2;col++){
        const lit=Math.sin(t+cx*1.3+cy*.7+row*2+col*4)>0;
        ctx.fillStyle=lit?'#ffe082':'#1a237e';
        ctx.fillRect(gx+6+col*14,gy+8+row*10,8,7);
      }
      ctx.fillStyle='#263238'; ctx.fillRect(gx+G/2-4,gy+G-10,8,10);
      break;}
    case 'shop':{
      ctx.fillStyle='#e65100'; ctx.fillRect(gx+2,gy+G-24,G-4,24);
      ctx.fillStyle='#f57c00'; ctx.fillRect(gx+2,gy+G-27,G-4,4);
      ctx.fillStyle='#ffe082'; ctx.fillRect(gx+5,gy+G-22,G-10,7);
      ctx.fillStyle=`rgba(200,230,255,${.6+Math.sin(t*1.5)*.2})`; ctx.fillRect(gx+5,gy+G-14,G-10,8);
      break;}
    case 'clinic':{
      ctx.fillStyle='#f5f5f5'; ctx.fillRect(gx+3,gy+8,G-6,G-9);
      ctx.fillStyle='#c62828'; ctx.fillRect(gx+3,gy+8,G-6,7);
      ctx.fillStyle='white'; ctx.fillRect(gx+G/2-1.5,gy+9,3,5); ctx.fillRect(gx+G/2-4,gy+10.5,8,2);
      ctx.fillStyle='#90caf9'; ctx.fillRect(gx+5,gy+18,7,6); ctx.fillRect(gx+G-12,gy+18,7,6);
      break;}
    case 'school':{
      ctx.fillStyle='#fff8e1'; ctx.fillRect(gx+2,gy+12,G-4,G-13);
      ctx.fillStyle='#f9a825'; ctx.fillRect(gx+2,gy+8,G-4,6);
      ctx.fillStyle='#e65100';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy+2);ctx.lineTo(gx+2,gy+10);ctx.lineTo(gx+G-2,gy+10);ctx.closePath();ctx.fill();
      ctx.fillStyle='#90caf9'; ctx.fillRect(gx+5,gy+16,8,7); ctx.fillRect(gx+G-13,gy+16,8,7);
      break;}
    case 'condo':{
      ctx.fillStyle='#263238'; ctx.fillRect(gx+G/2-8,gy+1,16,G-2);
      ctx.fillStyle='#37474f'; ctx.fillRect(gx+2,gy+G-20,G-4,20);
      for(let row=0;row<5;row++) for(let col=0;col<2;col++){
        const lit=Math.sin(t*.8+cx*2+cy+row*1.7+col*3.2)>-.1;
        ctx.fillStyle=lit?'#ffd54f':'#0d47a1';
        ctx.fillRect(gx+G/2-7+col*8,gy+3+row*8,5,5);
      }
      for(let col=0;col<3;col++){
        ctx.fillStyle=Math.sin(t+col*2)>0?'#ffcc02':'#1565c0';
        ctx.fillRect(gx+4+col*12,gy+G-16,8,8);
      }
      ctx.fillStyle='#00bcd4'; ctx.fillRect(gx+G/2-8,gy,16,2);
      break;}
    case 'office':{
      ctx.fillStyle='#0d47a1'; ctx.fillRect(gx+4,gy+1,G-8,G-2);
      for(let row=0;row<6;row++){
        ctx.fillStyle=`rgba(144,202,249,${.3+Math.sin(t*.3+row*.5)*.15})`;
        ctx.fillRect(gx+6,gy+3+row*6,G-12,4);
      }
      ctx.strokeStyle='#42a5f5'; ctx.lineWidth=1.5;
      ctx.beginPath();ctx.moveTo(gx+G/2,gy-5);ctx.lineTo(gx+G/2,gy+2);ctx.stroke();
      ctx.fillStyle='#42a5f5'; ctx.beginPath();ctx.arc(gx+G/2,gy-5,2,0,Math.PI*2);ctx.fill();
      break;}
    case 'hotel':{
      ctx.fillStyle='#4a148c'; ctx.fillRect(gx+3,gy+4,G-6,G-5);
      ctx.fillStyle='#38006b';
      ctx.beginPath();ctx.moveTo(gx+G/2,gy);ctx.lineTo(gx+3,gy+6);ctx.lineTo(gx+G-3,gy+6);ctx.closePath();ctx.fill();
      for(let row=0;row<4;row++) for(let col=0;col<3;col++){
        ctx.fillStyle=Math.sin(t+row*1.3+col*2.1+cx)>0?'#ffe082':'#1a0033';
        ctx.fillRect(gx+5+col*11,gy+10+row*8,7,5);
      }
      break;}
    case 'stadium':{
      ctx.fillStyle='#1c1c1c';
      ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-2,G/3,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#2e7d32';
      ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-7,G/3-4,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#33691e'; ctx.lineWidth=1;
      ctx.beginPath();ctx.ellipse(gx+G/2,gy+G/2,G/2-12,G/3-8,0,0,Math.PI*2);ctx.stroke();
      [[4,4],[G-4,4],[4,G-4],[G-4,G-4]].forEach(([lx,ly])=>{
        ctx.fillStyle=Math.sin(t*2+lx*.1)>.5?'#fff176':'#f57f17';
        ctx.beginPath();ctx.arc(gx+lx,gy+ly,2,0,Math.PI*2);ctx.fill();
      });
      break;}
    case 'skyscraper':{
      ctx.fillStyle='#1a237e'; ctx.fillRect(gx+1,gy+G-18,G-2,18);
      ctx.fillStyle='#0d1b4a'; ctx.fillRect(gx+6,gy+2,G-12,G-18);
      ctx.fillStyle='#1565c0'; ctx.fillRect(gx+G/2-4,gy-4,8,G/3);
      for(let row=0;row<7;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.6+cx*1.5+cy+row*1.2+col*2.8)>0?'#bbdefb':'#0a1433';
        ctx.fillRect(gx+8+col*10,gy+4+row*5,7,3);
      }
      ctx.fillStyle=Math.sin(t*4)>0?'#ef5350':'#b71c1c';
      ctx.beginPath();ctx.arc(gx+G/2,gy-4,2.5,0,Math.PI*2);ctx.fill();
      break;}
    case 'mall':{
      ctx.fillStyle='#37474f'; ctx.fillRect(gx,gy+G-22,G,22);
      ctx.fillStyle='#546e7a'; ctx.fillRect(gx+8,gy+G-36,G-16,14);
      ctx.fillStyle=`rgba(144,202,249,${.3+Math.sin(t*.3)*.15})`; ctx.fillRect(gx+10,gy+G-34,G-20,10);
      ['#ef9a9a','#a5d6a7','#90caf9','#fff59d'].forEach((c,i)=>{
        if(i*10<G-4){ ctx.fillStyle=c; ctx.fillRect(gx+2+i*10,gy+G-18,8,10); }
      });
      break;}
    case 'luxury':{
      ctx.fillStyle='#0a0a0a'; ctx.fillRect(gx+G/2-8,gy,16,G);
      ctx.fillStyle='#111'; ctx.fillRect(gx+1,gy+G-20,G-2,20);
      ctx.strokeStyle='#d4af37'; ctx.lineWidth=.5;
      ctx.strokeRect(gx+G/2-8,gy,16,G); ctx.strokeRect(gx+1,gy+G-20,G-2,20);
      for(let row=0;row<6;row++) for(let col=0;col<2;col++){
        ctx.fillStyle=Math.sin(t*.5+cx*2+row*1.5+col*3)>0?'#d4af37':'#1a1500';
        ctx.fillRect(gx+G/2-7+col*8,gy+2+row*7,5,4);
      }
      ctx.fillStyle='#d4af37'; ctx.fillRect(gx+G/2-1,gy-6,2,6);
      ctx.beginPath();ctx.moveTo(gx+G/2,gy-10);ctx.lineTo(gx+G/2-3,gy-6);ctx.lineTo(gx+G/2+3,gy-6);ctx.closePath();ctx.fill();
      break;}
    case 'airport':{
      ctx.fillStyle='#212121'; ctx.fillRect(gx,gy+G-16,G,16);
      ctx.fillStyle='#37474f'; ctx.fillRect(gx+4,gy+G-30,G-8,16);
      ctx.fillStyle='#455a64';
      ctx.beginPath();ctx.moveTo(gx+4,gy+G-30);ctx.quadraticCurveTo(gx+G/2,gy+G-38,gx+G-4,gy+G-30);
      ctx.lineTo(gx+G-4,gy+G-28);ctx.quadraticCurveTo(gx+G/2,gy+G-36,gx+4,gy+G-28);ctx.closePath();ctx.fill();
      for(let i=0;i<5;i++){
        ctx.fillStyle=`rgba(144,202,249,${.5+Math.sin(t+i)*.3})`;
        ctx.fillRect(gx+5+i*8,gy+G-27,5,8);
      }
      const px=(animFrame*1.2+cx*13)%(G+20)-10;
      ctx.fillStyle='#eceff1'; ctx.fillRect(gx+px,gy+4,10,4);
      ctx.fillStyle='#b0bec5';
      ctx.beginPath();ctx.moveTo(gx+px+4,gy+4);ctx.lineTo(gx+px+2,gy+1);ctx.lineTo(gx+px+8,gy+4);ctx.closePath();ctx.fill();
      break;}
  }
  ctx.restore();
}

function drawCity(){
  cityX.clearRect(0,0,VW,VH);
  const c0=Math.floor(cam.x/GRID)-1, r0=Math.floor(cam.y/GRID)-1;
  const c1=Math.min(MAP_COLS-1, c0+Math.ceil(VW/GRID)+2);
  const r1=Math.min(MAP_ROWS-1, r0+Math.ceil(VH/GRID)+2);
  for(let r=r0;r<=r1;r++){
    for(let c=c0;c<=c1;c++){
      const key=`${c},${r}`;
      if(state.grid[key]){
        const sx=c*GRID-cam.x, sy=r*GRID-cam.y;
        drawBuilding(cityX, state.grid[key], sx, sy, c, r);
        // Condition indicator dot
        const prop=state.properties[key];
        if(prop){
          const cond=prop.condition;
          const color=cond>=70?'#3fb950':cond>=40?'#f0b429':cond>=20?'#f85149':'#666';
          cityX.fillStyle=color;
          cityX.beginPath(); cityX.arc(sx+GRID-5, sy+5, 3, 0, Math.PI*2); cityX.fill();
          cityX.strokeStyle='rgba(0,0,0,0.5)'; cityX.lineWidth=0.5;
          cityX.beginPath(); cityX.arc(sx+GRID-5, sy+5, 3, 0, Math.PI*2); cityX.stroke();
        }
      }
    }
  }
}

// ==================== MINIMAP ====================
function drawMinimap(){
  const mw=160, mh=100;
  const sx=mw/MAP_COLS, sy=mh/MAP_ROWS;
  mmX.clearRect(0,0,mw,mh);
  for(let r=0;r<MAP_ROWS;r++){
    for(let c=0;c<MAP_COLS;c++){
      const t=TERRAIN[`${c},${r}`]||'grass';
      const colors={grass:'#2e6b2e',water:'#1a5f8a',sand:'#b8975a',hill:'#4a5c4a'};
      mmX.fillStyle=colors[t];
      mmX.fillRect(c*sx,r*sy,sx+.5,sy+.5);
    }
  }
  // District reputation overlay
  const dsx=DIST_W*sx, dsy=DIST_H*sy;
  for(let dy=0;dy<DIST_ROWS;dy++){
    for(let dx=0;dx<DIST_COLS;dx++){
      const dist=state.districts[`${dx},${dy}`];
      if(dist){
        const rep=dist.reputation;
        if(rep>55){
          mmX.fillStyle=`rgba(63,185,80,${(rep-55)/100*0.3})`;
        } else if(rep<45){
          mmX.fillStyle=`rgba(248,81,73,${(45-rep)/100*0.3})`;
        } else { continue; }
        mmX.fillRect(dx*dsx,dy*dsy,dsx,dsy);
      }
    }
  }
  // Buildings
  for(const key in state.grid){
    const[c,r]=key.split(',').map(Number);
    mmX.fillStyle='#f0b429';
    mmX.fillRect(c*sx,r*sy,sx+.5,sy+.5);
  }
  // Viewport rect
  mmX.strokeStyle='rgba(255,255,255,0.6)'; mmX.lineWidth=1;
  mmX.strokeRect(cam.x/MAP_W*mw, cam.y/MAP_H*mh, VW/MAP_W*mw, VH/MAP_H*mh);
}

// ==================== MOUSE / DRAG ====================
function getMapCell(ex,ey){
  const mx=ex+cam.x, my=ey+cam.y;
  return[Math.floor(mx/GRID), Math.floor(my/GRID)];
}

const wrap=document.getElementById('map-wrap');

wrap.addEventListener('mousedown',e=>{
  dragging=false;
  dragStart={x:e.clientX,y:e.clientY};
  camStart={x:cam.x,y:cam.y};
  wrap.style.cursor='grabbing';
});

wrap.addEventListener('mousemove',e=>{
  const dx=e.clientX-dragStart.x, dy=e.clientY-dragStart.y;
  if(Math.abs(dx)>3||Math.abs(dy)>3) dragging=true;
  if(dragging&&e.buttons===1){
    cam.x=camStart.x-dx; cam.y=camStart.y-dy; clampCam();
  }
  // tooltip
  const rect=wrap.getBoundingClientRect();
  const[cx,cy]=getMapCell(e.clientX-rect.left, e.clientY-rect.top);
  const key=`${cx},${cy}`;
  const tt=document.getElementById('tooltip');
  if(state.grid[key]&&!dragging){
    const prop=state.properties[key];
    const b=BUILDINGS.find(x=>x.id===state.grid[key]);
    if(!b||!prop){tt.style.display='none';return;}
    document.getElementById('tt-name').textContent=b.name;
    document.getElementById('tt-val').innerHTML=`<span>Â¥${Math.floor(prop.value).toLocaleString()}</span>`;
    const changePct=((prop.value-prop.purchasePrice)/prop.purchasePrice*100).toFixed(1);
    const changeClass=changePct>=0?'up':'dn';
    document.getElementById('tt-cost').textContent=`Â¥${prop.purchasePrice.toLocaleString()}`;
    document.getElementById('tt-change').innerHTML=`<span class="${changeClass}">${changePct>=0?'+':''}${changePct}%</span>`;
    if(b.baseRent>0){
      const monthlyRent=calcPropertyRent(key);
      document.getElementById('tt-rent').textContent=`Â¥${Math.floor(monthlyRent).toLocaleString()}`;
      document.getElementById('tt-rent-row').style.display='';
      document.getElementById('tt-vac').textContent=`${prop.vacancy.toFixed(1)}%`;
      document.getElementById('tt-vac-row').style.display='';
    } else {
      document.getElementById('tt-rent-row').style.display='none';
      document.getElementById('tt-vac-row').style.display='none';
    }
    document.getElementById('tt-cond').textContent=`${Math.floor(prop.condition)}/100`;
    const dk=getDistrictKey(cx,cy);
    const distRep=state.districts[dk]?state.districts[dk].reputation:50;
    document.getElementById('tt-dist').textContent=`${getDistrictName(dk)} ${Math.floor(distRep)}/100`;
    tt.style.left=Math.min(e.clientX-rect.left+12,VW-230)+'px';
    tt.style.top=Math.max(e.clientY-rect.top-120,4)+'px';
    tt.style.display='block';
  } else tt.style.display='none';
});

wrap.addEventListener('mouseup',e=>{
  wrap.style.cursor='crosshair';
  if(dragging){dragging=false;return;}
  const rect=wrap.getBoundingClientRect();
  const[cx,cy]=getMapCell(e.clientX-rect.left, e.clientY-rect.top);
  if(cx<0||cy<0||cx>=MAP_COLS||cy>=MAP_ROWS)return;
  const key=`${cx},${cy}`;
  handleClick(key,cx,cy,e.clientX-rect.left,e.clientY-rect.top);
});

wrap.addEventListener('mouseleave',()=>{
  document.getElementById('tooltip').style.display='none';
  dragging=false; wrap.style.cursor='crosshair';
});

// Touch support
let touch0={x:0,y:0};
wrap.addEventListener('touchstart',e=>{
  touch0={x:e.touches[0].clientX,y:e.touches[0].clientY};
  camStart={x:cam.x,y:cam.y}; dragging=false;
},{passive:true});
wrap.addEventListener('touchmove',e=>{
  const dx=e.touches[0].clientX-touch0.x, dy=e.touches[0].clientY-touch0.y;
  if(Math.abs(dx)>5||Math.abs(dy)>5) dragging=true;
  if(dragging){ cam.x=camStart.x-dx; cam.y=camStart.y-dy; clampCam(); }
},{passive:true});
wrap.addEventListener('touchend',e=>{
  if(dragging){dragging=false;return;}
  const rect=wrap.getBoundingClientRect();
  const tx=e.changedTouches[0].clientX-rect.left;
  const ty=e.changedTouches[0].clientY-rect.top;
  const[cx,cy]=getMapCell(tx,ty);
  if(cx>=0&&cy>=0&&cx<MAP_COLS&&cy<MAP_ROWS){
    handleClick(`${cx},${cy}`,cx,cy,tx,ty);
  }
});

mm.addEventListener('click',e=>{
  const rect=mm.getBoundingClientRect();
  const fx=(e.clientX-rect.left)/160, fy=(e.clientY-rect.top)/100;
  cam.x=fx*MAP_W - VW/2; cam.y=fy*MAP_H - VH/2; clampCam();
});

// ==================== CLICK HANDLING ====================
function handleClick(key,cx,cy,screenX,screenY){
  // Demolish mode
  if(isDemolish){
    if(state.grid[key]){
      const prop=state.properties[key];
      const refund=Math.floor((prop?prop.value:0)*0.4);
      const b=BUILDINGS.find(x=>x.id===state.grid[key]);
      state.money+=refund;
      state.population-=(b?b.pop:0);
      delete state.grid[key];
      delete state.properties[key];
      updateUI(); buildSidebar();
      notify(`ğŸ—‘ å–ã‚Šå£Šã— (+Â¥${refund.toLocaleString()} è¿”é‚„)`,'rd');
    }
    return;
  }
  // Repair mode
  if(isRepairMode){
    if(state.grid[key]&&state.properties[key]){
      const prop=state.properties[key];
      if(prop.condition>=99){notify('âœ… ä¿®ç†ä¸è¦','gd');return;}
      const b=BUILDINGS.find(x=>x.id===prop.type);
      const repairCost=Math.floor(b.cost*(100-prop.condition)/100*0.3);
      if(state.money<repairCost){notify(`ğŸ’¸ ä¿®ç†è²» Â¥${repairCost.toLocaleString()} ä¸è¶³`,'rd');return;}
      state.money-=repairCost;
      prop.condition=100;
      updateUI(); buildSidebar();
      notify(`ğŸ”§ ä¿®ç†å®Œäº† (-Â¥${repairCost.toLocaleString()})`,'gr');
      spawnFloat(screenX,screenY,`-Â¥${repairCost.toLocaleString()}`,true);
    }
    return;
  }
  // Build mode
  if(state.grid[key]){notify('âš  ã™ã§ã«å»ºç‰©ãŒã‚ã‚Šã¾ã™','rd');return;}
  const b=BUILDINGS.find(x=>x.id===selectedType);
  if(!b)return;
  if(b.tier>state.maxMilestone){notify('ğŸ”’ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æœªé”ã§æœªè§£æ”¾','rd');return;}
  const terrain=TERRAIN[key]||'grass';
  if(terrain==='water'&&selectedType!=='ocean'){notify('ğŸŒŠ æµ·ã«ã¯å»ºã¦ã‚‰ã‚Œã¾ã›ã‚“','rd');return;}

  // Auto-borrow if needed
  if(state.money<b.cost){
    const needed=b.cost-state.money;
    const maxBorrow=calcMaxLoan()-state.loanBalance;
    if(needed<=maxBorrow){
      borrowMoney(needed);
      notify(`ğŸ’³ Â¥${Math.floor(needed).toLocaleString()} è‡ªå‹•å€Ÿå…¥`,'gd');
    } else {
      notify('ğŸ’¸ äºˆç®—ã‚‚å€Ÿå…¥æ ã‚‚ä¸è¶³ï¼','rd');
      return;
    }
  }

  state.money-=b.cost;
  state.population+=(b.pop||0);
  state.grid[key]=selectedType;
  state.properties[key]={
    type:selectedType,
    purchasePrice:b.cost,
    value:b.cost,
    vacancy: b.baseRent>0 ? 30 : 0,
    condition:100,
    monthsOwned:0,
  };
  updateUI(); buildSidebar();
  notify(`âœ… ${b.name} å»ºè¨­ (-Â¥${b.cost.toLocaleString()})`,'gr');
  spawnFloat(screenX,screenY,`-Â¥${b.cost.toLocaleString()}`,true);
}

// ==================== NET WORTH & MILESTONES ====================
function calcTotalAssets(){
  let total=0;
  for(const prop of Object.values(state.properties)) total+=prop.value;
  return total;
}

function calcNetWorth(){
  return state.money + calcTotalAssets() - state.loanBalance;
}

function getMilestoneIndex(){
  const nw=calcNetWorth();
  for(let i=MILESTONES.length-1;i>=0;i--){
    if(nw>=MILESTONES[i].threshold) return i;
  }
  return -1;
}

function checkMilestones(){
  const idx=getMilestoneIndex();
  if(idx>state.maxMilestone){
    state.maxMilestone=idx;
    showMilestoneModal(idx);
    buildSidebar();
  }
}

function showMilestoneModal(idx){
  gamePaused=true;
  const m=MILESTONES[idx];
  document.getElementById('m-stars').textContent='â­'.repeat(idx+1);
  document.getElementById('m-title').textContent='MILESTONE!';
  document.getElementById('m-desc').textContent=`ã€Œ${m.title}ã€ã«æ˜‡æ ¼ï¼\næ–°ã—ã„å»ºç‰©ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚\nç´”è³‡ç”£: Â¥${Math.floor(calcNetWorth()).toLocaleString()}`;
  document.getElementById('m-btn').textContent='OK â†’';
  document.getElementById('m-btn').onclick=closeModal;
  document.getElementById('modal').classList.add('show');
}

function closeModal(){
  document.getElementById('modal').classList.remove('show');
  gamePaused=false;
}

// ==================== LOAN SYSTEM ====================
function calcLoanRate(){
  const riskPremium=(850-state.creditScore)/850*7;
  return Math.max(0.5,(3+riskPremium+state.rateMod))/100;
}

function calcMaxLoan(){
  const assets=calcTotalAssets();
  return (state.creditScore/850)*Math.max(assets*2, 10000);
}

function borrowMoney(amount){
  const newRate=calcLoanRate();
  if(state.loanBalance>0){
    state.loanRate=(state.loanBalance*state.loanRate+amount*newRate)/(state.loanBalance+amount);
  } else {
    state.loanRate=newRate;
  }
  state.loanBalance+=amount;
  state.money+=amount;
}

function repayLoan(amount){
  const actual=Math.min(amount, state.loanBalance, state.money);
  if(actual<=0) return;
  state.money-=actual;
  state.loanBalance-=actual;
  if(state.loanBalance<=0){ state.loanBalance=0; state.loanRate=0; }
}

function openLoanDialog(){
  gamePaused=true;
  updateLoanDialog();
  document.getElementById('loan-modal').classList.add('show');
}

function closeLoanDialog(){
  document.getElementById('loan-modal').classList.remove('show');
  gamePaused=false;
  updateUI(); buildSidebar();
}

function updateLoanDialog(){
  const maxNew=Math.floor(calcMaxLoan()-state.loanBalance);
  const rate=calcLoanRate();
  const monthlyPayment=state.loanBalance>0 ? state.loanBalance*(state.loanRate/12+0.005) : 0;
  const body=document.getElementById('loan-body');
  body.innerHTML=`
    <div class="loan-grid">
      <div><span class="loan-lbl">ä¿¡ç”¨ã‚¹ã‚³ã‚¢</span><div class="loan-val gold">${state.creditScore}</div></div>
      <div><span class="loan-lbl">ç¾åœ¨ã®å€Ÿå…¥æ®‹é«˜</span><div class="loan-val red">Â¥${Math.floor(state.loanBalance).toLocaleString()}</div></div>
      <div><span class="loan-lbl">é‡‘åˆ© (å¹´)</span><div class="loan-val">${(rate*100).toFixed(2)}%</div></div>
      <div><span class="loan-lbl">æœˆã€…ã®è¿”æ¸ˆ</span><div class="loan-val red">Â¥${Math.floor(monthlyPayment).toLocaleString()}</div></div>
      <div><span class="loan-lbl">è¿½åŠ å€Ÿå…¥å¯èƒ½é¡</span><div class="loan-val green">Â¥${maxNew.toLocaleString()}</div></div>
      <div><span class="loan-lbl">ç¾é‡‘</span><div class="loan-val gold">Â¥${Math.floor(state.money).toLocaleString()}</div></div>
    </div>
    <hr class="loan-sep">
    <div class="loan-row"><label>å€Ÿå…¥é¡:</label><input type="number" id="borrow-amt" min="0" max="${maxNew}" value="${Math.min(maxNew,10000)}" step="1000"></div>
    <button class="modal-btn" style="width:100%;margin-bottom:12px" onclick="doBorrow()">ğŸ’° å€Ÿå…¥ã™ã‚‹</button>
    ${state.loanBalance>0?`
    <hr class="loan-sep">
    <div class="loan-row"><label>è¿”æ¸ˆé¡:</label><input type="number" id="repay-amt" min="0" max="${Math.floor(Math.min(state.loanBalance,state.money))}" value="${Math.floor(Math.min(state.loanBalance,state.money))}" step="1000"></div>
    <button class="modal-btn secondary" style="width:100%" onclick="doRepay()">ğŸ’³ è¿”æ¸ˆã™ã‚‹</button>
    `:''}`;
}

function doBorrow(){
  const input=document.getElementById('borrow-amt');
  const amt=Math.floor(Number(input.value));
  const maxNew=Math.floor(calcMaxLoan()-state.loanBalance);
  if(amt<=0||amt>maxNew){notify('âš  ç„¡åŠ¹ãªå€Ÿå…¥é¡','rd');return;}
  borrowMoney(amt);
  notify(`ğŸ’° Â¥${amt.toLocaleString()} å€Ÿå…¥å®Œäº†`,'gr');
  updateLoanDialog();
}

function doRepay(){
  const input=document.getElementById('repay-amt');
  const amt=Math.floor(Number(input.value));
  if(amt<=0){notify('âš  ç„¡åŠ¹ãªè¿”æ¸ˆé¡','rd');return;}
  repayLoan(amt);
  notify(`ğŸ’³ Â¥${amt.toLocaleString()} è¿”æ¸ˆå®Œäº†`,'gr');
  updateLoanDialog();
}

// ==================== RENT & VACANCY ====================
function calcPropertyRent(key){
  const prop=state.properties[key];
  if(!prop) return 0;
  const b=BUILDINGS.find(x=>x.id===prop.type);
  if(!b||b.baseRent<=0) return 0;
  const[cx,cy]=key.split(',').map(Number);
  const dk=getDistrictKey(cx,cy);
  const distRep=(state.districts[dk]?state.districts[dk].reputation:50)/50;
  const condMult=prop.condition>=20 ? Math.max(0.3, prop.condition/100) : 0;
  const popMult=1+state.population/5000;
  return b.baseRent*(1-prop.vacancy/100)*distRep*condMult*popMult;
}

function updateVacancy(){
  for(const[key,prop] of Object.entries(state.properties)){
    const b=BUILDINGS.find(x=>x.id===prop.type);
    if(!b||b.baseRent<=0) continue;
    const[cx,cy]=key.split(',').map(Number);
    const dk=getDistrictKey(cx,cy);
    const distRep=state.districts[dk]?state.districts[dk].reputation:50;
    let delta=-2; // natural fill rate
    delta+=(distRep-50)/100*5; // district factor
    if(prop.condition<50) delta+=(50-prop.condition)/50*5; // condition penalty
    delta+=(Math.random()-0.5)*6; // random noise Â±3
    if(state.vacancyModMonths>0) delta+=state.vacancyMod;
    prop.vacancy=Math.max(0, Math.min(100, prop.vacancy+delta));
  }
}

// ==================== PROPERTY VALUES ====================
function calcAdjacencyBonus(cx,cy){
  let bonus=0;
  for(let dx=-1;dx<=1;dx++){
    for(let dy=-1;dy<=1;dy++){
      if(dx===0&&dy===0) continue;
      const nk=`${cx+dx},${cy+dy}`;
      const np=state.properties[nk];
      if(np){
        const nb=BUILDINGS.find(x=>x.id===np.type);
        if(nb&&nb.cat==='infra') bonus+=0.005;
        else bonus+=0.002;
      }
    }
  }
  return bonus;
}

function updatePropertyValues(){
  for(const[key,prop] of Object.entries(state.properties)){
    const[cx,cy]=key.split(',').map(Number);
    const dk=getDistrictKey(cx,cy);
    const distRep=state.districts[dk]?state.districts[dk].reputation:50;
    const distGrowth=(distRep-50)/1000; // -5% to +5% mapped from reputation 0-100
    const adjBonus=calcAdjacencyBonus(cx,cy);
    const marketNoise=(Math.random()-0.5)*0.06; // Â±3%
    let marketEvent=0;
    if(state.marketModMonths>0) marketEvent=state.marketMod;
    const totalGrowth=distGrowth+adjBonus+marketNoise+marketEvent;
    prop.value=Math.max(prop.purchasePrice*0.1, prop.value*(1+totalGrowth));
  }
}

// ==================== BUILDING CONDITION ====================
function degradeBuildings(){
  for(const prop of Object.values(state.properties)){
    const b=BUILDINGS.find(x=>x.id===prop.type);
    const rate=b&&b.cat==='infra'?0.5:1;
    prop.condition=Math.max(0, prop.condition-rate);
  }
}

// ==================== EVENTS ====================
function rollForEvent(){
  if(Math.random()>0.30) return; // 30% chance per month
  const totalWeight=EVENT_TYPES.reduce((s,e)=>s+e.weight,0);
  let roll=Math.random()*totalWeight;
  for(const ev of EVENT_TYPES){
    roll-=ev.weight;
    if(roll<=0){ executeEvent(ev); return; }
  }
}

function executeEvent(ev){
  let detail='';
  switch(ev.id){
    case 'boom':
      state.marketMod=0.03; state.marketModMonths=3;
      detail='å…¨ç‰©ä»¶ã®ä¾¡å€¤ãŒä¸Šæ˜‡ä¸­ (3ãƒ¶æœˆé–“)';
      break;
    case 'crash':
      state.marketMod=-0.05; state.marketModMonths=6;
      detail='å…¨ç‰©ä»¶ã®ä¾¡å€¤ãŒä¸‹è½ä¸­ (6ãƒ¶æœˆé–“)';
      break;
    case 'quake':{
      const dks=Object.keys(state.districts);
      const dk=dks[Math.floor(Math.random()*dks.length)];
      const[ddx,ddy]=dk.split(',').map(Number);
      let damaged=0;
      for(let cy=ddy*DIST_H;cy<Math.min((ddy+1)*DIST_H,MAP_ROWS);cy++){
        for(let cx=ddx*DIST_W;cx<Math.min((ddx+1)*DIST_W,MAP_COLS);cx++){
          const prop=state.properties[`${cx},${cy}`];
          if(prop){ prop.condition=Math.max(0,prop.condition-(20+Math.random()*30)); damaged++; }
        }
      }
      detail=`${getDistrictName(dk)}åœ°åŒº: ${damaged}æ£Ÿã«è¢«å®³`;
      break;
    }
    case 'fire':{
      const keys=Object.keys(state.properties);
      if(keys.length===0){detail='è¢«å®³ãªã—';break;}
      const key=keys[Math.floor(Math.random()*keys.length)];
      const prop=state.properties[key];
      const b=BUILDINGS.find(x=>x.id===prop.type);
      prop.condition=Math.max(0,prop.condition-60-Math.random()*30);
      detail=`${b?b.name:'å»ºç‰©'}ãŒè¢«å®³ã‚’å—ã‘ã¾ã—ãŸ`;
      break;
    }
    case 'exodus':{
      const dks=Object.keys(state.districts);
      const dk=dks[Math.floor(Math.random()*dks.length)];
      state.districts[dk].reputation=Math.max(0,state.districts[dk].reputation-30);
      detail=`${getDistrictName(dk)}åœ°åŒºã®è©•åˆ¤ãŒå¤§å¹…ä½ä¸‹`;
      break;
    }
    case 'redev':{
      const dks=Object.keys(state.districts);
      const dk=dks[Math.floor(Math.random()*dks.length)];
      state.districts[dk].reputation=Math.min(100,state.districts[dk].reputation+20);
      detail=`${getDistrictName(dk)}åœ°åŒºãŒå†é–‹ç™ºã§æ´»æ€§åŒ–`;
      break;
    }
    case 'rate':{
      const change=Math.random()>0.5?1:-1;
      state.rateMod=Math.max(-2,Math.min(3,state.rateMod+change));
      // Recalculate existing loan rate
      if(state.loanBalance>0) state.loanRate=calcLoanRate();
      detail=`é‡‘åˆ©ãŒ${change>0?'ä¸Šæ˜‡':'ä½ä¸‹'}ã—ã¾ã—ãŸ`;
      break;
    }
    case 'vacancy':{
      const types=['residential','commercial'];
      const targetCat=types[Math.floor(Math.random()*types.length)];
      let affected=0;
      for(const prop of Object.values(state.properties)){
        const b=BUILDINGS.find(x=>x.id===prop.type);
        if(b&&b.cat===targetCat&&b.baseRent>0){
          prop.vacancy=Math.min(100,prop.vacancy+40);
          affected++;
        }
      }
      detail=`${targetCat==='residential'?'ä½å±…':'å•†æ¥­'}ç‰©ä»¶ã®ç©ºå®¤ç‡ãŒæ€¥å¢— (${affected}æ£Ÿ)`;
      break;
    }
  }
  addEventLog(`${ev.icon} ${ev.name}: ${detail}`, ev.type);
  notify(`${ev.icon} ${ev.name}`, ev.type==='good'?'gr':ev.type==='bad'?'rd':'gd');
}

function addEventLog(text, type){
  state.eventLog.unshift({text, type, year:state.year, month:state.month});
  if(state.eventLog.length>20) state.eventLog.pop();
  renderEventLog();
}

function renderEventLog(){
  const el=document.getElementById('event-log');
  const recent=state.eventLog.slice(0,5);
  el.innerHTML=recent.map(e=>`<div class="ev-item ${e.type}"><span class="ev-date">${e.year}Y${e.month}M</span>${e.text}</div>`).join('');
}

// ==================== MONTHLY TICK ====================
function monthlyTick(){
  // Advance time
  state.month++;
  if(state.month>12){ state.month=1; state.year++; }

  // Age properties
  for(const prop of Object.values(state.properties)) prop.monthsOwned++;

  // Update districts
  updateDistricts();

  // Update property values
  updatePropertyValues();

  // Update vacancy
  updateVacancy();

  // Collect rent
  let totalRent=0;
  for(const key of Object.keys(state.properties)){
    const rent=calcPropertyRent(key);
    if(rent>0) totalRent+=rent;
  }
  state.money+=totalRent;

  // Process loans
  if(state.loanBalance>0){
    const monthlyInterest=state.loanBalance*state.loanRate/12;
    const minPrincipal=state.loanBalance*0.005;
    const payment=monthlyInterest+minPrincipal;
    if(state.money>=payment){
      state.money-=payment;
      state.loanBalance=Math.max(0,state.loanBalance-minPrincipal);
      if(state.loanBalance<=0) state.loanRate=0;
      state.creditScore=Math.min(850,state.creditScore+2);
    } else {
      // Missed payment
      state.loanBalance+=monthlyInterest;
      state.creditScore=Math.max(300,state.creditScore-20);
      addEventLog('âš ï¸ è¿”æ¸ˆä¸èƒ½: åˆ©æ¯ãŒæ®‹é«˜ã«åŠ ç®—ã•ã‚Œã¾ã—ãŸ','bad');
    }
  }

  // Degrade buildings
  degradeBuildings();

  // Decay active modifiers
  if(state.marketModMonths>0){
    state.marketModMonths--;
    if(state.marketModMonths<=0) state.marketMod=0;
  }
  if(state.vacancyModMonths>0){
    state.vacancyModMonths--;
    if(state.vacancyModMonths<=0) state.vacancyMod=0;
  }

  // Random event
  rollForEvent();

  // Credit score from portfolio
  const assets=calcTotalAssets();
  if(assets>0) state.creditScore=Math.min(850,state.creditScore+Math.min(3,Math.floor(assets/100000)));

  // Check milestones
  checkMilestones();

  // Bankruptcy check
  const nw=calcNetWorth();
  if(nw<-10000){
    state.bankruptMonths++;
    if(state.bankruptMonths>=6) showBankruptModal();
    else if(state.bankruptMonths>=3) addEventLog('âš ï¸ ç ´ç”£è­¦å‘Š: ç´”è³‡ç”£ãŒãƒã‚¤ãƒŠã‚¹ã§ã™ï¼','bad');
  } else {
    state.bankruptMonths=0;
  }

  // Update everything
  updateUI();
  buildSidebar();
}

function showBankruptModal(){
  gamePaused=true;
  document.getElementById('m-stars').textContent='ğŸ’¸ğŸ’¸ğŸ’¸';
  document.getElementById('m-title').textContent='ç ´ç”£ï¼';
  document.getElementById('m-desc').textContent=`å€Ÿå…¥é‡‘ãŒè³‡ç”£ã‚’å¤§å¹…ã«ä¸Šå›ã‚Šã¾ã—ãŸã€‚\nã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã€‚\n\næœ€çµ‚ç´”è³‡ç”£: Â¥${Math.floor(calcNetWorth()).toLocaleString()}`;
  document.getElementById('m-btn').textContent='ãƒªã‚»ãƒƒãƒˆã—ã¦å†æŒ‘æˆ¦';
  document.getElementById('m-btn').onclick=function(){closeModal();confirmReset();};
  document.getElementById('modal').classList.add('show');
}

// ==================== UI ====================
function updateUI(){
  document.getElementById('s-money').textContent=`Â¥${Math.floor(state.money).toLocaleString()}`;
  document.getElementById('s-assets').textContent=`Â¥${Math.floor(calcTotalAssets()).toLocaleString()}`;
  document.getElementById('s-debt').textContent=`Â¥${Math.floor(state.loanBalance).toLocaleString()}`;
  const nw=calcNetWorth();
  document.getElementById('s-networth').textContent=`Â¥${Math.floor(nw).toLocaleString()}`;
  document.getElementById('s-date').textContent=`${state.year}å¹´ ${state.month}æœˆ`;

  // Milestone bar
  const idx=state.maxMilestone;
  const m=MILESTONES[idx];
  document.getElementById('milestone-name').textContent=m?m.title:'åˆå¿ƒè€…';
  if(idx<MILESTONES.length-1){
    const next=MILESTONES[idx+1];
    const prev=m?m.threshold:0;
    const pct=Math.max(0,Math.min(100,(nw-prev)/(next.threshold-prev)*100));
    document.getElementById('milestone-fill').style.width=pct+'%';
    document.getElementById('milestone-goal').textContent=`æ¬¡: ç´”è³‡ç”£ Â¥${next.threshold.toLocaleString()} (${Math.floor(pct)}%)`;
  } else {
    document.getElementById('milestone-fill').style.width='100%';
    document.getElementById('milestone-goal').textContent='æœ€é«˜ãƒ©ãƒ³ã‚¯é”æˆï¼';
  }
}

function notify(text,type='gd'){
  const el=document.getElementById('notif');
  el.textContent=text; el.className=`notif show ${type}`;
  clearTimeout(notifTO);
  notifTO=setTimeout(()=>el.classList.remove('show'),2200);
}

function spawnFloat(x,y,text,isDebit){
  const c=document.getElementById('map-wrap');
  const el=document.createElement('div');
  el.className='ifloat'; el.textContent=text;
  el.style.left=x+'px'; el.style.top=y+'px';
  el.style.color=isDebit?'#f85149':'#3fb950';
  c.appendChild(el);
  setTimeout(()=>el.remove(),1400);
}

// ==================== SAVE / LOAD ====================
const SK='empireBuilder_v1';

function saveGame(){
  try{
    const saveData={
      ...state,
      money:Math.floor(state.money*100)/100,
      cam,
      savedAt:new Date().toISOString()
    };
    localStorage.setItem(SK,JSON.stringify(saveData));
    notify('ğŸ’¾ ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼','gr');
  }catch(e){notify('âŒ ã‚»ãƒ¼ãƒ–å¤±æ•—','rd');}
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SK);
    if(!raw){notify('ğŸ“‚ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—','rd');return;}
    const d=JSON.parse(raw);
    state={
      money:d.money||10000,
      year:d.year||1,
      month:d.month||1,
      loanBalance:d.loanBalance||0,
      loanRate:d.loanRate||0,
      creditScore:d.creditScore||600,
      maxMilestone:d.maxMilestone||0,
      population:d.population||0,
      grid:d.grid||{},
      properties:d.properties||{},
      districts:d.districts||{},
      eventLog:d.eventLog||[],
      marketMod:d.marketMod||0,
      marketModMonths:d.marketModMonths||0,
      vacancyMod:d.vacancyMod||0,
      vacancyModMonths:d.vacancyModMonths||0,
      rateMod:d.rateMod||0,
      bankruptMonths:d.bankruptMonths||0,
    };
    if(d.cam) Object.assign(cam,d.cam);
    clampCam();
    updateUI(); buildSidebar(); renderEventLog(); drawBg(); drawCity();
    notify('ğŸ“‚ ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼','gd');
  }catch(e){notify('âŒ ãƒ­ãƒ¼ãƒ‰å¤±æ•—','rd');}
}

function confirmReset(){
  if(confirm('æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¾ã™ã€‚')){
    localStorage.removeItem(SK);
    state=defaultState();
    initDistricts();
    cam={x:MAP_W/2-VW/2,y:MAP_H/2-VH/2}; clampCam();
    selectedType='house'; isDemolish=false; isRepairMode=false;
    lastMonthTime=Date.now();
    updateUI(); buildSidebar(); renderEventLog(); drawBg(); drawCity();
    notify('ğŸ”„ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ','gd');
  }
}

// ==================== GAME LOOP ====================
function animate(){
  animFrame++;

  // Monthly tick
  if(!gamePaused){
    const now=Date.now();
    if(now-lastMonthTime>=MONTH_MS){
      lastMonthTime=now;
      monthlyTick();
    }
  }

  if(animFrame%3===0) drawBg();
  drawCity();
  if(animFrame%10===0) drawMinimap();
  requestAnimationFrame(animate);
}

// ==================== INIT ====================
generateTerrain();

window.addEventListener('resize',resize);
resize();

cam.x=MAP_W/2-VW/2; cam.y=MAP_H/2-VH/2; clampCam();

// Initialize districts (or load from save)
const hasSave=localStorage.getItem(SK);
if(hasSave){
  setTimeout(()=>{
    if(confirm('å‰å›ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')){
      loadGame();
    } else {
      initDistricts();
      buildSidebar(); updateUI();
    }
  },400);
} else {
  initDistricts();
}

buildSidebar(); updateUI();
setInterval(()=>{if(!gamePaused)saveGame();},60000);

animate();
</script>

</body>
</html>
